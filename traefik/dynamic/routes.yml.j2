# Dynamic Traefik Routes
# Managed by Git - configs repo
# Templated by Ansible - variables defined in group_vars/proxy_servers.yml

http:
  routers:
{% if traefik_dashboard_enabled | default(false) %}
    # Traefik Dashboard
    traefik-dashboard:
      rule: "Host(`proxy.{{ traefik_ingress_domain }}`) && (PathPrefix(`/api`) || PathPrefix(`/dashboard`))"
      service: api@internal
      middlewares:
        - dashboard-auth
        - secure-headers
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt
{% endif %}

    router-ingress:
      rule: "Host(`router.{{ traefik_ingress_domain }}`)"
      service: router-service
      middlewares:
        - secure-headers
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt

    unifi-ingress:
      rule: "Host(`controller.{{ traefik_ingress_domain }}`)"
      service: unifi-service
      middlewares:
        - secure-headers
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt

    # Ansible/Semaphore - Public service via Cloudflare
    ansible-ingress:
      rule: "Host(`ansible.{{ traefik_ingress_domain }}`)"
      service: ansible-service
      middlewares:
        - secure-headers
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt

    vault-ingress:
      rule: "Host(`vault.{{ traefik_ingress_domain }}`)"
      service: vault-service
      middlewares:
        - secure-headers
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt

    nas-ingress:
      rule: "Host(`datastore.{{ traefik_ingress_domain }}`)"
      service: nas-service
      middlewares:
        - secure-headers
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt

    adguard-ingress:
      rule: "Host(`adguard.{{ traefik_ingress_domain }}`)"
      service: adguard-service
      middlewares:
        - secure-headers
        - internal-only
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt

    # NanoMDM - Apple MDM server (public via Cloudflare Tunnel)
    mdm-ingress:
      rule: "Host(`mdm.{{ traefik_ingress_domain }}`)"
      service: mdm-service
      middlewares:
        - secure-headers
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt

    assistant-ingress:
      rule: "Host(`assistant.{{ traefik_ingress_domain }}`)"
      service: assistant-service
      middlewares:
        - websocket-headers
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt

    freebsd-dev-ingress:
      rule: "Host(`freebsd-dev.{{ traefik_ingress_domain }}`)"
      service: freebsd-dev-service
      middlewares:
        - secure-headers
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt

  services:
    ansible-service:
      loadBalancer:
        servers:
          - url: "http://[3d06:bad:b01::107]:3000"
        healthCheck:
          path: /api/ping
          interval: 30s
          timeout: 5s

    vault-service:
      loadBalancer:
        servers:
          - url: "https://[3d06:bad:b01::254]:8006"
        serversTransport: insecure-transport

    router-service:
      loadBalancer:
        servers:
          - url: "https://[3d06:bad:b01::1]"
        serversTransport: insecure-transport

    unifi-service:
      loadBalancer:
        servers:
          - url: "https://unifi.home.goodkind.io:8443"
        serversTransport: unifi-transport

    nas-service:
      loadBalancer:
        servers:
          - url: "http://nas.home.goodkind.io:3923"

    adguard-service:
      loadBalancer:
        servers:
          - url: "https://[3d06:bad:b01::53]"
        serversTransport: insecure-transport

    mdm-service:
      loadBalancer:
        servers:
          - url: "http://[3d06:bad:b01::103]:9000"

    assistant-service:
      loadBalancer:
        servers:
          - url: "http://[3d06:bad:b01:2::3]:8123"
        passHostHeader: true

    freebsd-dev-service:
      loadBalancer:
        servers:
          - url: "http://[3d06:bad:b01::108]:8080"

  serversTransports:
    insecure-transport:
      insecureSkipVerify: true

    unifi-transport:
      insecureSkipVerify: true
      serverName: "UniFi"

udp:
  routers:
    # Xpra Remote Desktop - QUIC/UDP routing
    xpra-quic-ingress:
      entryPoints:
        - xpra-quic
      service: xpra-quic-service

  services:
    xpra-quic-service:
      loadBalancer:
        servers:
          - address: "[3d06:bad:b01::100]:9876"
