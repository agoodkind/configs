# Dynamic Traefik Routes
# Managed by Git - configs repo
# Templated by Ansible - variables defined in group_vars/traefik_servers.yml

http:
  routers:
    # Traefik Dashboard
    traefik-dashboard:
      rule: "Host(`traefik.{{ traefik_public_domain }}`) && (PathPrefix(`/api`) || PathPrefix(`/dashboard`))"
      service: api@internal
      middlewares:
        - dashboard-auth
        - secure-headers
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt

    # Ansible/Semaphore - Public service via Cloudflare
    ansible-public:
      rule: "Host(`ansible.{{ traefik_public_domain }}`)"
      service: ansible
      middlewares:
        - cloudflare-only  # Only accept Cloudflare IPs
        - secure-headers
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt

    vault-public:
      rule: "Host(`vault.{{ traefik_public_domain }}`)"
      service: vault
      middlewares:
        - cloudflare-only  # Only accept Cloudflare IPs
        - secure-headers
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt

  services:
    ansible:
      loadBalancer:
        servers:
          - url: "http://ansible.{{ traefik_internal_domain }}:3000"
        healthCheck:
          path: /api/ping
          interval: 30s
          timeout: 5s

    vault:
      loadBalancer:
        servers:
          - url: "https://vault.{{ traefik_internal_domain }}:8006"

  serversTransports:
    insecure-transport:
      insecureSkipVerify: true
