# Dynamic Traefik Routes
# Managed by Git - configs repo
# Templated by Ansible - variables defined in group_vars/traefik_servers.yml

http:
  routers:
    # Traefik Dashboard
    traefik-dashboard:
      rule: "Host(`traefik.{{ traefik_ingress_domain }}`) && (PathPrefix(`/api`) || PathPrefix(`/dashboard`))"
      service: api@internal
      middlewares:
        - dashboard-auth
        - secure-headers
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt

    router-ingress:
      rule: "Host(`router.{{ traefik_ingress_domain }}`)"
      service: router-service
      middlewares:
        - secure-headers
      entryPoints:
        - web
      tls:
        certResolver: letsencrypt

    unifi-ingress:
      rule: "Host(`unifi.{{ traefik_ingress_domain }}`)"
      service: unifi-service
      middlewares:
        - secure-headers
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt

    # Ansible/Semaphore - Public service via Cloudflare
    ansible-ingress:
      rule: "Host(`ansible.{{ traefik_ingress_domain }}`)"
      service: ansible-service
      middlewares:
        {# - cloudflare-only  # Only accept Cloudflare IPs #}
        - secure-headers
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt

    vault-ingress:
      rule: "Host(`vault.{{ traefik_ingress_domain }}`)"
      service: vault-service
      middlewares:
        {# - cloudflare-only  # Only accept Cloudflare IPs #}
        - secure-headers
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt

  services:
    ansible-service:
      loadBalancer:
        servers:
          - url: "http://ansible.{{ traefik_upstream_domain }}:3000"
        healthCheck:
          path: /api/ping
          interval: 30s
          timeout: 5s

    vault-service:
      loadBalancer:
        servers:
          - url: "https://vault.{{ traefik_upstream_domain }}:8006"
      serversTransport: insecure-transport

    router-service:
      loadBalancer:
        servers:
          - url: "https://router.{{ traefik_upstream_domain }}"
      serversTransport: insecure-transport

    unifi-service:
      loadBalancer:
        servers:
          - url: "https://unifi.{{ traefik_upstream_domain }}:8443"
      serversTransport: unifi-transport

  serversTransports:
    insecure-transport:
      insecureSkipVerify: true
    
    unifi-transport:
      insecureSkipVerify: true
      serverName: "UniFi"
