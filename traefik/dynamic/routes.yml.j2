# Dynamic Traefik Routes
# Managed by Git - configs repo
# Templated by Ansible - variables defined in group_vars/proxy_servers.yml

http:
  routers:
{% if traefik_dashboard_enabled | default(false) %}
    # Traefik Dashboard
    traefik-dashboard:
      rule: "Host(`proxy.{{ traefik_ingress_domain }}`) && (PathPrefix(`/api`) || PathPrefix(`/dashboard`))"
      service: api@internal
      middlewares:
        - dashboard-auth
        - secure-headers
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt
{% endif %}

    router-ingress:
      rule: "Host(`router.{{ traefik_ingress_domain }}`)"
      service: router-service
      middlewares:
        - secure-headers
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt

    unifi-ingress:
      rule: "Host(`unifi.{{ traefik_ingress_domain }}`)"
      service: unifi-service
      middlewares:
        - secure-headers
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt

    # Ansible/Semaphore - Public service via Cloudflare
    ansible-ingress:
      rule: "Host(`ansible.{{ traefik_ingress_domain }}`)"
      service: ansible-service
      middlewares:
        - secure-headers
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt

    vault-ingress:
      rule: "Host(`vault.{{ traefik_ingress_domain }}`)"
      service: vault-service
      middlewares:
        - secure-headers
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt

    nas-ingress:
      rule: "Host(`nas.{{ traefik_ingress_domain }}`)"
      service: nas-service
      middlewares:
        - secure-headers
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt

    adguard-ingress:
      rule: "Host(`adguard.{{ traefik_ingress_domain }}`)"
      service: adguard-service
      middlewares:
        - secure-headers
        - internal-only
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt

    # NanoMDM - Apple MDM server (public via Cloudflare Tunnel)
    mdm-ingress:
      rule: "Host(`mdm.{{ traefik_ingress_domain }}`)"
      service: mdm-service
      middlewares:
        - secure-headers
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt

  services:
    ansible-service:
      loadBalancer:
        servers:
          - url: "http://[3d06:bad:b01::107]:3000"
        healthCheck:
          path: /api/ping
          interval: 30s
          timeout: 5s

    vault-service:
      loadBalancer:
        servers:
          - url: "https://[3d06:bad:b01::fe]:8006"
        serversTransport: insecure-transport

    router-service:
      loadBalancer:
        servers:
          - url: "https://[3d06:bad:b01::1]"
        serversTransport: insecure-transport

    unifi-service:
      loadBalancer:
        servers:
          - url: "https://[3d06:bad:b01::102]:8443"
        serversTransport: unifi-transport

    nas-service:
      loadBalancer:
        servers:
          - url: "https://nas.{{ traefik_upstream_domain }}:8443"
        serversTransport: insecure-transport

    adguard-service:
      loadBalancer:
        servers:
          - url: "https://[3d06:bad:b01::53]"
        serversTransport: insecure-transport

    mdm-service:
      loadBalancer:
        servers:
          - url: "http://[3d06:bad:b01::103]:9000"

  serversTransports:
    insecure-transport:
      insecureSkipVerify: true

    unifi-transport:
      insecureSkipVerify: true
      serverName: "UniFi"
