#!/bin/bash
# networkd-dispatcher hook to update policy routing
# Triggered when WAN interfaces become routable (DHCP lease obtained)
# Generated by Ansible
#
# What it does (symptoms):
# - Ensures routing converges quickly when a WAN becomes usable (e.g. after DHCPv4/DHCPv6, or after a flap).
#
# What it does (technical):
# - Runs only on `STATE=routable` for primary WAN interfaces.
# - Invokes `/usr/local/bin/update-routes.sh` to rebuild policy routing tables/rules.
#
# Dependency graph:
# - Called by: `networkd-dispatcher` when systemd-networkd reports a `routable` transition.
# - Calls into: `update-routes.sh`.

IFACE=$1
STATE=$2

# Only run for routable state (when IP is obtained and interface is up)
if [ "$STATE" != "routable" ]; then
    exit 0
fi

# Session-style debug logging (JSON lines)
DEBUG="{{ mwan_debug_logging | default(false) | ternary('1','0') }}"
DEBUG_LOG="/var/log/mwan-debug.log"
TRACE_FILE="/run/mwan-trace-id"
MWAN_TRACE_ID="${MWAN_TRACE_ID:-}"
if [ -z "${MWAN_TRACE_ID:-}" ] && [ -r "$TRACE_FILE" ]; then
    MWAN_TRACE_ID="$(cat "$TRACE_FILE" 2>/dev/null || true)"
fi

# Only run for WAN interfaces (AT&T VLAN or Webpass)
ATT_VLAN="{{ mwan_att_iface }}.{{ mwan_att_vlan_id }}"
WEBPASS_IFACE="{{ mwan_webpass_iface }}"

if [ "$IFACE" != "$ATT_VLAN" ] && [ "$IFACE" != "$WEBPASS_IFACE" ]; then
    # Not a WAN interface, skip
    exit 0
fi

prefix=""
[ -n "${MWAN_TRACE_ID:-}" ] && prefix="traceId=${MWAN_TRACE_ID} "
logger -t networkd-dispatcher \
    "${prefix}Interface $IFACE is now routable, updating policy routing"

if [ "$DEBUG" = "1" ]; then
    printf '{"traceId":"%s","component":"50-update-routes","location":"EVENT","message":"hook_event","data":{"iface":"%s","state":"%s"},"timestamp":%s}\n' \
        "${MWAN_TRACE_ID:-}" "$IFACE" "$STATE" "$(date +%s%3N)" >> "$DEBUG_LOG"
fi

# Call update-routes.sh to rebuild routing tables
/usr/local/bin/update-routes.sh

exit 0
