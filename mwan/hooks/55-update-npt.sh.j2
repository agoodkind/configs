#!/bin/bash
# networkd-dispatcher hook to update NPT after WAN becomes routable
# Generated by Ansible
#
# What it does (symptoms):
# - Ensures IPv6 starts working as soon as a WAN has a delegated prefix (PD) and becomes routable.
# - Prevents “NPT rules missing” failures after DHCP/PD changes.
#
# What it does (technical):
# - Runs only on `STATE=routable` for WAN interfaces.
# - Discovers delegated prefix info and persists it to `/var/lib/mwan/pd-<iface>`.
# - Calls `/usr/local/bin/update-npt.sh <iface> <prefix>` to program runtime `nft ip6 nat` rules.
#
# Dependency graph:
# - Called by: `networkd-dispatcher` on systemd-networkd state transitions.
# - Calls into: `update-npt.sh`.

IFACE="$1"
STATE="$2"

# Only act when interface is routable
[ "$STATE" = "routable" ] || exit 0

ATT_IFACE="{{ mwan_att_iface }}.{{ mwan_att_vlan_id }}"
WEBPASS_IFACE="{{ mwan_webpass_iface }}"
MB_IFACE="{{ mwan_monkeybrains_iface }}"

# Only handle WAN interfaces (AT&T VLAN, Webpass, Monkeybrains)
if [ "$IFACE" != "$ATT_IFACE" ] && [ "$IFACE" != "$WEBPASS_IFACE" ] && [ "$IFACE" != "$MB_IFACE" ]; then
    exit 0
fi

log() {
    local prefix=""
    [ -n "${MWAN_TRACE_ID:-}" ] && prefix="traceId=${MWAN_TRACE_ID} "
    logger -t networkd-dispatcher "${prefix}[update-npt] $*"
    echo "[update-npt] ${prefix}$*"
}

# Session-style debug logging (JSON lines)
DEBUG="{{ mwan_debug_logging | default(false) | ternary('1','0') }}"
DEBUG_LOG="/var/log/mwan-debug.log"
TRACE_FILE="/run/mwan-trace-id"
MWAN_TRACE_ID="${MWAN_TRACE_ID:-}"
if [ -z "${MWAN_TRACE_ID:-}" ] && [ -r "$TRACE_FILE" ]; then
    MWAN_TRACE_ID="$(cat "$TRACE_FILE" 2>/dev/null || true)"
fi
debug_json_line() {
    [ "$DEBUG" = "1" ] || return 0
    local loc="$1"; shift
    local msg="$1"; shift
    local data="${1:-{}}"; shift || true
    jq -cn \
        --arg traceId "${MWAN_TRACE_ID:-}" \
        --arg component "55-update-npt" \
        --arg location "$loc" \
        --arg message "$msg" \
        --arg data "$data" \
        --argjson timestamp "$(date +%s%3N)" \
        '{traceId:$traceId,component:$component,location:$location,message:$message,data:(try ($data|fromjson) catch {"_raw":$data}),timestamp:$timestamp}' \
        >>"$DEBUG_LOG"
}

#region agent log
LOG_PATH="/var/log/mwan-debug.log"
log_json() {
    local hid="$1"; shift
    local loc="$1"; shift
    local msg="$1"; shift
    local data="$1"; shift
    printf '{"traceId":"%s","sessionId":"debug-session","runId":"run1",' \
           '"hypothesisId":"%s","location":"%s","message":"%s",' \
           '"data":%s,"timestamp":%s}\n' \
           "${MWAN_TRACE_ID:-}" "$hid" "$loc" "$msg" "$data" "$(date +%s%3N)" \
           >> "$LOG_PATH"
}
#endregion

log "Event iface=$IFACE state=$STATE"
log_json "H1" "55-update-npt.sh:EVENT" "hook_event" \
    "{\"iface\":\"$IFACE\",\"state\":\"$STATE\"}"
debug_json_line "EVENT" "hook_event" "{\"iface\":\"$IFACE\",\"state\":\"$STATE\"}"

# Capture DHCPv6-PD routes (systemd installs PD routes as proto dhcp, dev lo)
ROUTE_OUTPUT=$(ip -6 route show proto dhcp)
log "DHCPv6 proto dhcp routes:\n$ROUTE_OUTPUT"
log_json "H1" "55-update-npt.sh:ROUTES" "dhcp_routes" \
    "{\"routes\":\"$ROUTE_OUTPUT\"}"
debug_json_line "ROUTES" "dhcp_routes" "{\"routes\":\"$ROUTE_OUTPUT\"}"

# Try to extract prefixes
STATE_DIR="/var/lib/mwan"
mkdir -p "$STATE_DIR"
STATE_FILE="$STATE_DIR/pd-$IFACE"

# 1) networkctl status (delegated prefix) - best per-iface signal
PREFIXES=$(networkctl status "$IFACE" --no-pager 2>/dev/null | \
    sed -n 's/.*delegated prefix \\([^ ]*\\).*/\\1/p' || true)

# 2) proto dhcp routes (coarse; may include prefixes from other ifaces)
if [ -z "$PREFIXES" ]; then
    PREFIXES=$(printf '%s\n' "$ROUTE_OUTPUT" | awk '/\\//{print $1}' | grep '/' || true)
fi

# 3) state file fallback
if [ -z "$PREFIXES" ] && [ -f "$STATE_FILE" ]; then
    PREFIXES=$(cat "$STATE_FILE")
fi

log_json "H2" "55-update-npt.sh:PREFIXES" "prefixes_found" \
    "{\"prefixes\":\"$PREFIXES\"}"
debug_json_line "PREFIXES" "prefixes_found" "{\"prefixes\":\"$PREFIXES\"}"

if [ -z "$PREFIXES" ]; then
    # Fallback mode:
    # Some deployments intentionally use fixed per-WAN /60 targets (NPT) rather than
    # relying on dynamically-discovered DHCPv6-PD routes.
    case "$IFACE" in
        "$ATT_IFACE") PREFIXES="{{ mwan_npt_att_prefix }}" ;;
        "$WEBPASS_IFACE") PREFIXES="{{ mwan_npt_webpass_prefix }}" ;;
        "$MB_IFACE") PREFIXES="{{ mwan_npt_monkeybrains_prefix | default('') }}" ;;
        *) PREFIXES="" ;;
    esac
    [ -n "$PREFIXES" ] && debug_json_line "FALLBACK" "using_static_prefix" "{\"iface\":\"$IFACE\",\"prefixes\":\"$PREFIXES\"}"
fi

if [ -z "$PREFIXES" ]; then
    log "No prefix found for $IFACE; skipping NPT update"
    exit 0
fi

# Persist latest prefixes
echo "$PREFIXES" > "$STATE_FILE"

log "Found prefixes: $PREFIXES"
log_json "H3" "55-update-npt.sh:FOUND" "prefixes_nonempty" \
    "{\"prefixes\":\"$PREFIXES\"}"
debug_json_line "FOUND" "prefixes_nonempty" "{\"prefixes\":\"$PREFIXES\"}"

for prefix in $PREFIXES; do
    log "Updating NPT for $IFACE with prefix $prefix"
    log_json "H4" "55-update-npt.sh:CALL" "calling_update_npt" \
        "{\"iface\":\"$IFACE\",\"prefix\":\"$prefix\"}"
    debug_json_line "CALL" "calling_update_npt" "{\"iface\":\"$IFACE\",\"prefix\":\"$prefix\"}"
    /usr/local/bin/update-npt.sh "$IFACE" "$prefix" || \
        log "NPT update failed for $IFACE prefix $prefix"
done
