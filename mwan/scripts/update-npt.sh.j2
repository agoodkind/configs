#!/bin/sh
# Update nftables NPT (IPv6 prefix translation) rules
# Called by dhcpcd.exit-hook when prefix delegation changes
# Generated by Ansible

set -e

WAN_IFACE="$1"
DELEGATED_PREFIX="$2"
DEBUG="{{ mwan_debug_logging | default(false) | ternary('1','0') }}"
DEBUG_LOG="/var/log/mwan-debug.log"
TRACE_FILE="/run/mwan-trace-id"
MWAN_TRACE_ID="${MWAN_TRACE_ID:-}"
if [ -z "${MWAN_TRACE_ID:-}" ] && [ -r "$TRACE_FILE" ]; then
    MWAN_TRACE_ID="$(cat "$TRACE_FILE" 2>/dev/null || true)"
fi

if [ -z "$WAN_IFACE" ] || [ -z "$DELEGATED_PREFIX" ]; then
    echo "Usage: $(basename "$0") <wan_iface> <delegated_prefix>"
    echo "Example: $(basename "$0") {{ mwan_att_iface }}.{{ mwan_att_vlan_id }} 2600:1700:2f71:c80::/60"
    exit 1
fi

readonly INTERNAL_PREFIX="{{ mwan_internal_prefix }}"
readonly OPNSENSE_EDGE_V6="{{ mwan_opnsense_edge_ipv6 | default('3d06:bad:b01:fe::2') }}"

log() {
    local msg="$1"
    local prefix=""
    [ -n "${MWAN_TRACE_ID:-}" ] && prefix="traceId=${MWAN_TRACE_ID} "
    logger -t update-npt "${prefix}${msg}"
    echo "[update-npt] ${prefix}${msg}"
}

debug_json() {
    [ "$DEBUG" = "1" ] || return 0
    local loc="$1"; shift
    local msg="$1"; shift
    local data="${1:-{}}"; shift || true
    printf '{"traceId":"%s","component":"update-npt","location":"%s","message":"%s","data":%s,"timestamp":%s}\n' \
        "${MWAN_TRACE_ID:-}" "$loc" "$msg" "$data" "$(date +%s%3N)" >> "$DEBUG_LOG"
}

log "Updating NPT rules for $WAN_IFACE"
log "  Delegated prefix: $DELEGATED_PREFIX"

# Delete existing postrouting rules for this iface
for handle in $(nft -a list chain ip6 nat postrouting | grep "oif \"$WAN_IFACE\".*# handle" | sed -e 's/^.* handle //'); do
    nft delete rule ip6 nat postrouting handle "$handle"
done

# Delete existing prerouting rules for this iface
for handle in $(nft -a list chain ip6 nat prerouting | grep "iif \"$WAN_IFACE\".*# handle" | sed -e 's/^.* handle //'); do
    nft delete rule ip6 nat prerouting handle "$handle"
done

# Decide target /60 for this iface
case "$WAN_IFACE" in
    "{{ mwan_att_iface }}.{{ mwan_att_vlan_id }}")
        TARGET_PREFIX="{{ mwan_npt_att_prefix }}"
        ;;
    "{{ mwan_webpass_iface }}")
        TARGET_PREFIX="{{ mwan_npt_webpass_prefix }}"
        ;;
    *)
        log "Unknown WAN iface $WAN_IFACE; skipping"
        exit 0
        ;;
esac

[ "$DEBUG" = "1" ] && debug_json "SELECT" "target_prefix_selected" "$(python3 - <<'PY'
import json,os
print(json.dumps({"iface": os.environ.get("WAN_IFACE",""), "delegated": os.environ.get("DELEGATED_PREFIX",""), "target": os.environ.get("TARGET_PREFIX","")}))
PY
)"

# Postrouting: 
# - SNAT specific /128s (fe::1, fe::2) to PD ::1
# - NPT broader /60 to PD /60
# Add PD ::1 address to interface first
ip -6 addr replace "${TARGET_PREFIX%/*}1/128" dev "$WAN_IFACE" nodad || true
# If this packet is part of a DNAT'd flow to the OPNsense edge address, do NOT clobber
# conntrack's reverse-NAT with an unconditional SNAT rule.
nft add rule ip6 nat postrouting oif "$WAN_IFACE" ip6 saddr "$OPNSENSE_EDGE_V6/128" ct status dnat return
nft add rule ip6 nat postrouting oif "$WAN_IFACE" ip6 saddr "$OPNSENSE_EDGE_V6/128" snat to "${TARGET_PREFIX%/*}1"
nft add rule ip6 nat postrouting oif "$WAN_IFACE" ip6 saddr 3d06:bad:b01:fe::1/128 snat to "${TARGET_PREFIX%/*}1"
nft add rule ip6 nat postrouting oif "$WAN_IFACE" ip6 saddr "$INTERNAL_PREFIX" snat ip6 prefix to "$TARGET_PREFIX"

# Prerouting: 
# - DNAT PD ::1 back to fe::2
# - NPT broader PD /60 back to LAN /60
nft add rule ip6 nat prerouting iif "$WAN_IFACE" ip6 daddr "${TARGET_PREFIX%/*}1/128" dnat to "$OPNSENSE_EDGE_V6"
nft add rule ip6 nat prerouting iif "$WAN_IFACE" ip6 daddr "$TARGET_PREFIX" dnat ip6 prefix to "$INTERNAL_PREFIX"

# Also DNAT any other global IPv6 address that is currently assigned to the WAN interface
# (e.g., SLAAC /64 address or other provider-assigned /128) back to OPNsense.
#
# This prevents confusion where a "WAN interface address" is reachable from the Internet,
# but would otherwise terminate on MWAN and never be seen by OPNsense.
for ip6_cidr in $(ip -6 addr show dev "$WAN_IFACE" scope global | awk '/inet6/{print $2}' || true); do
    # Only hairpin /128 interface addresses.
    [ "${ip6_cidr#*/}" = "128" ] || continue

    # Skip the PD ::1/128 alias we intentionally manage above.
    [ "$ip6_cidr" = "${TARGET_PREFIX%/*}1/128" ] && continue

    ip6_addr="${ip6_cidr%/*}"
    [ -n "$ip6_addr" ] || continue
    nft add rule ip6 nat prerouting iif "$WAN_IFACE" ip6 daddr "$ip6_addr/128" dnat to "$OPNSENSE_EDGE_V6"
done

# Save current nftables config
nft list ruleset > /etc/nftables.conf.dynamic

[ "$DEBUG" = "1" ] && debug_json "NFT" "ip6_nat_chains" "$(python3 - <<'PY'
import json,subprocess
def cmd(*a):
    return subprocess.run(list(a), capture_output=True, text=True).stdout.strip()
print(json.dumps({
  "prerouting": cmd("nft","-a","list","chain","ip6","nat","prerouting"),
  "postrouting": cmd("nft","-a","list","chain","ip6","nat","postrouting"),
}))
PY
)"

log "NPT update complete for $WAN_IFACE"
