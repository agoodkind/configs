#!/bin/bash
# Generated by Ansible
#
# What it does (symptoms):
# - Prevents boot-time “half configured” routing where Monkeybrains accidentally becomes the default path
#   because primary WAN gateways weren’t ready when `update-routes.sh` first ran.
#
# What it does (technical):
# - Waits until at least one primary WAN has a usable IPv4 default gateway AND at least one has a usable IPv6
#   default gateway (as observed in the kernel route tables).
# - Has an emergency fallback: if primary WAN interfaces don’t exist at all, allow boot to proceed if
#   Monkeybrains has any gateway so the box stays reachable.
#
# Dependency graph:
# - Called by: `mwan-update-routes.service` as `ExecStartPre=...`.
# - Enables: safe execution of `/usr/local/bin/update-routes.sh`.
# - Requires: kernel netdevices exist and `ip` is available.

set -euo pipefail

ATT_VLAN="{{ mwan_att_iface }}.{{ mwan_att_vlan_id }}"
WEBPASS_IFACE="{{ mwan_webpass_iface }}"
MB_IFACE="{{ mwan_monkeybrains_iface | default('enmbrains0') }}"

WAIT_SECS="${WAIT_SECS:-120}"
SLEEP_SECS="${SLEEP_SECS:-2}"

log() {
  logger -t mwan-wait-routes-prereqs "$1"
  echo "[mwan-wait-routes-prereqs] $1"
}

iface_exists() {
  local iface="$1"
  [ -d "/sys/class/net/$iface" ]
}

gw4_for_dev() {
  local dev="$1"
  ip -j -4 route show default 2>/dev/null | jq -r --arg dev "$dev" '
    [
      .[] |
      if (.dev? == $dev and (.gateway? != null) and (.gateway? != "")) then
        .gateway
      elif (.nexthops? != null) then
        (.nexthops[]? | select(.dev? == $dev) | .gateway? // empty)
      else
        empty
      end
    ] | map(select(. != "")) | .[0] // empty
  '
}

gw6_for_dev() {
  local dev="$1"
  ip -j -6 route show default 2>/dev/null | jq -r --arg dev "$dev" '
    [
      .[] |
      if (.dev? == $dev and (.gateway? != null) and (.gateway? != "")) then
        .gateway
      elif (.nexthops? != null) then
        (.nexthops[]? | select(.dev? == $dev) | .gateway? // empty)
      else
        empty
      end
    ] | map(select(. != "")) | .[0] // empty
  '
}

log "Waiting for WAN gateways (timeout=${WAIT_SECS}s): $ATT_VLAN, $WEBPASS_IFACE"

for i in $(seq 1 "$((WAIT_SECS / SLEEP_SECS))"); do
  att_exists=0; web_exists=0
  iface_exists "$ATT_VLAN" && att_exists=1
  iface_exists "$WEBPASS_IFACE" && web_exists=1

  att_gw4="$(gw4_for_dev "$ATT_VLAN" || true)"
  web_gw4="$(gw4_for_dev "$WEBPASS_IFACE" || true)"
  att_gw6="$(gw6_for_dev "$ATT_VLAN" || true)"
  web_gw6="$(gw6_for_dev "$WEBPASS_IFACE" || true)"

  have_primary_v4=0
  if [ -n "$att_gw4" ] || [ -n "$web_gw4" ]; then
    have_primary_v4=1
  fi

  have_primary_v6=0
  if [ -n "$att_gw6" ] || [ -n "$web_gw6" ]; then
    have_primary_v6=1
  fi

  # Normal case: at least one primary WAN exists; don't proceed until we can build v4+v6 policy routing.
  if [ "$att_exists" -eq 1 ] || [ "$web_exists" -eq 1 ]; then
    if [ "$have_primary_v4" -eq 1 ] && [ "$have_primary_v6" -eq 1 ]; then
      log "Primary WAN gateways detected (v4+v6)."
      exit 0
    fi
  else
    # Emergency: no primary WAN interfaces exist; allow boot to proceed if Monkeybrains has any gateway.
    mb_gw4="$(gw4_for_dev "$MB_IFACE" || true)"
    mb_gw6="$(gw6_for_dev "$MB_IFACE" || true)"
    if [ -n "$mb_gw4" ] || [ -n "$mb_gw6" ]; then
      log "No primary WAN interfaces found; proceeding with Monkeybrains gateways."
      log "Primary WANs will continue to be monitored; when AT&T/Webpass become available and healthy, "\
"the health daemon and routable hooks will trigger /usr/local/bin/update-routes.sh to converge."
      exit 0
    fi
  fi

  sleep "$SLEEP_SECS"
done

log "Timeout waiting for WAN gateways"
exit 1
