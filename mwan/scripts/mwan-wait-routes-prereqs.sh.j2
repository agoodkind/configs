#!/bin/bash
# Wait for policy-routing prerequisites (WAN routability).
# Generated by Ansible

set -euo pipefail

ATT_VLAN="{{ mwan_att_iface }}.{{ mwan_att_vlan_id }}"
WEBPASS_IFACE="{{ mwan_webpass_iface }}"

WAIT_SECS="${WAIT_SECS:-90}"
SLEEP_SECS="${SLEEP_SECS:-2}"

log() {
  logger -t mwan-wait-routes-prereqs "$1"
  echo "[mwan-wait-routes-prereqs] $1"
}

is_routable() {
  local iface="$1"
  networkctl status "$iface" --no-pager 2>/dev/null | grep -q 'State: routable'
}

log "Waiting for WANs to become routable (timeout=${WAIT_SECS}s): $ATT_VLAN, $WEBPASS_IFACE"

for i in $(seq 1 "$((WAIT_SECS / SLEEP_SECS))"); do
  ok=0
  is_routable "$ATT_VLAN" && ok=$((ok + 1))
  is_routable "$WEBPASS_IFACE" && ok=$((ok + 1))

  # We only need ONE routable WAN to build sane tables; the rest can converge later.
  if [ "$ok" -ge 1 ]; then
    log "Routable WANs detected (count=$ok)"
    exit 0
  fi

  sleep "$SLEEP_SECS"
done

log "Timeout waiting for routable WANs"
exit 1
