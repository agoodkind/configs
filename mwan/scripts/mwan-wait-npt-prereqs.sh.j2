#!/bin/bash
# Wait for NPT prerequisites (WAN interfaces + base nftables table).
# Generated by Ansible

set -euo pipefail

ATT_VLAN="{{ mwan_att_iface }}.{{ mwan_att_vlan_id }}"
WEBPASS_IFACE="{{ mwan_webpass_iface }}"

IFACE_WAIT_SECS="${IFACE_WAIT_SECS:-60}"
NFT_WAIT_SECS="${NFT_WAIT_SECS:-30}"
TRACE_FILE="/run/mwan-trace-id"
MWAN_TRACE_ID="${MWAN_TRACE_ID:-}"
if [ -z "${MWAN_TRACE_ID:-}" ] && [ -r "$TRACE_FILE" ]; then
  MWAN_TRACE_ID="$(cat "$TRACE_FILE" 2>/dev/null || true)"
fi

log() {
  local msg="$1"
  local prefix=""
  [ -n "${MWAN_TRACE_ID:-}" ] && prefix="traceId=${MWAN_TRACE_ID} "
  logger -t mwan-wait-npt-prereqs "${prefix}${msg}"
  echo "[mwan-wait-npt-prereqs] ${prefix}${msg}"
}

wait_for_iface() {
  local iface="$1"
  local i
  for i in $(seq 1 "$IFACE_WAIT_SECS"); do
    [ -d "/sys/class/net/$iface" ] && return 0
    sleep 1
  done
  return 1
}

wait_for_nft_table() {
  local i
  for i in $(seq 1 "$NFT_WAIT_SECS"); do
    nft list table ip6 nat >/dev/null 2>&1 && return 0
    sleep 1
  done
  return 1
}

log "Waiting for WAN interfaces to exist: $ATT_VLAN, $WEBPASS_IFACE (timeout=${IFACE_WAIT_SECS}s)"
wait_for_iface "$ATT_VLAN" || { log "WAN interface not present: $ATT_VLAN"; exit 1; }
wait_for_iface "$WEBPASS_IFACE" || { log "WAN interface not present: $WEBPASS_IFACE"; exit 1; }

log "Waiting for nftables table to exist: ip6 nat (timeout=${NFT_WAIT_SECS}s)"
wait_for_nft_table || { log "nftables table not ready: ip6 nat"; exit 1; }

log "Prerequisites satisfied"
