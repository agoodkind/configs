# Sysctl configuration for mwan multi-WAN router
# Generated by Ansible - interface names are templated from group_vars

# Enable IPv4 forwarding
net.ipv4.ip_forward = 1

# Enable IPv6 forwarding
net.ipv6.conf.all.forwarding = 1
net.ipv6.conf.default.forwarding = 1

# Disable IPv6 router advertisements on all interfaces by default
net.ipv6.conf.all.accept_ra = 0
net.ipv6.conf.default.accept_ra = 0

# Disable SLAAC on Webpass interface (prevents unwanted autoconf addresses)
net.ipv6.conf.{{ mwan_webpass_iface }}.accept_ra = 0
net.ipv6.conf.{{ mwan_webpass_iface }}.autoconf = 0

# Enable router advertisements on internal interface (to OPNsense)
net.ipv6.conf.{{ mwan_internal_iface }}.accept_ra = 2

# Increase connection tracking table size for multi-WAN
# Note: nf_conntrack module must be loaded first (done in handler)
net.netfilter.nf_conntrack_max = 262144

# Enable reverse path filtering (helps with multi-path routing)
net.ipv4.conf.all.rp_filter = 2
net.ipv4.conf.default.rp_filter = 2

# Disable source validation on Webpass WAN (needed for policy routing)
net.ipv4.conf.{{ mwan_webpass_iface }}.rp_filter = 0
# Disable source validation on AT&T VLAN (needed for policy routing)
net.ipv4.conf.{{ mwan_att_iface }}.{{ mwan_att_vlan_id }}.rp_filter = 0

# IPv6 specific optimizations
net.ipv6.conf.all.use_tempaddr = 0  # Don't use temporary addresses
net.ipv6.conf.default.use_tempaddr = 0

# TCP optimizations (despite "ipv4" in name, these apply to ALL TCP - both IPv4 and IPv6)

# Enable TCP Fast Open
net.ipv4.tcp_fastopen = 3

# Optimize TCP buffer sizes for high-throughput
net.core.rmem_max = 134217728
net.core.wmem_max = 134217728
net.ipv4.tcp_rmem = 4096 87380 67108864
net.ipv4.tcp_wmem = 4096 65536 67108864

# Enable Explicit Congestion Notification
net.ipv4.tcp_ecn = 1

# Protect against SYN flood attacks
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_max_syn_backlog = 8192
