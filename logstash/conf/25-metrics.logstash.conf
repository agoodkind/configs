filter {
  # Process Gateway metrics (dpinger stats)
  if [type] == "opnsense_gateway_metrics" {
    # Extract hostname from URL
    mutate {
      add_field => { "[host][name]" => "opnsense" }
      add_field => {
        "[data_stream][type]" => "metrics"
        "[data_stream][dataset]" => "opnsense.gateway"
        "[data_stream][namespace]" => "default"
        "[event][kind]" => "metric"
        "[event][category]" => "network"
        "[event][module]" => "opnsense"
      }
    }

    # Process gateway status items
    if [items] {
      ruby {
        path => "/etc/logstash/ruby/process_gateway_metrics.rb"
      }
    }

    mutate {
      remove_field => ["items", "status", "headers"]
    }
  }

  # Process System resource metrics (CPU/RAM)
  if [type] == "opnsense_system_metrics" {
    mutate {
      add_field => { "[host][name]" => "opnsense" }
      add_field => {
        "[data_stream][type]" => "metrics"
        "[data_stream][dataset]" => "opnsense.system"
        "[data_stream][namespace]" => "default"
        "[event][kind]" => "metric"
        "[event][category]" => "host"
        "[event][module]" => "opnsense"
      }
    }

    # Process memory metrics
    if [memory] {
      mutate {
        copy => { "[memory][used]" => "[metrics][system][memory][used_bytes]" }
        copy => { "[memory][total]" => "[metrics][system][memory][total_bytes]" }
        copy => { "[memory][used_frmt]" => "[metrics][system][memory][used_mb]" }
        copy => { "[memory][total_frmt]" => "[metrics][system][memory][total_mb]" }
        copy => { "[memory][arc]" => "[metrics][system][memory][arc_bytes]" }
        copy => { "[memory][arc_frmt]" => "[metrics][system][memory][arc_mb]" }
        copy => { "[memory][arc_txt]" => "[metrics][system][memory][arc_text]" }
      }
      
      # Calculate memory usage percentage
      ruby {
        path => "/etc/logstash/ruby/process_memory_metrics.rb"
      }
    }

    mutate {
      remove_field => ["memory", "headers"]
    }
  }

  # Process System load/uptime metrics
  if [type] == "opnsense_load_metrics" {
    mutate {
      add_field => { "[host][name]" => "opnsense" }
      add_field => {
        "[data_stream][type]" => "metrics"
        "[data_stream][dataset]" => "opnsense.system"
        "[data_stream][namespace]" => "default"
        "[event][kind]" => "metric"
        "[event][category]" => "host"
        "[event][module]" => "opnsense"
      }
    }

    # Parse load averages from string format "0.12, 0.15, 0.18"
    if [loadavg] {
      ruby {
        path => "/etc/logstash/ruby/process_load_metrics.rb"
      }
    }

    # Copy uptime and other time fields
    if [uptime] {
      mutate {
        copy => { "[uptime]" => "[metrics][system][uptime]" }
      }
    }
    
    if [datetime] {
      mutate {
        copy => { "[datetime]" => "[metrics][system][datetime]" }
      }
    }
    
    if [boottime] {
      mutate {
        copy => { "[boottime]" => "[metrics][system][boottime]" }
      }
    }
    
    if [config] {
      mutate {
        copy => { "[config]" => "[metrics][system][last_config_change]" }
      }
    }

    mutate {
      remove_field => ["loadavg", "uptime", "datetime", "boottime", "config", "headers"]
    }
  }

  # Process Interface statistics (bytes/packets in/out)
  if [type] == "opnsense_interface_metrics" {
    mutate {
      add_field => { "[host][name]" => "opnsense" }
      add_field => {
        "[data_stream][type]" => "metrics"
        "[data_stream][dataset]" => "opnsense.interface"
        "[data_stream][namespace]" => "default"
        "[event][kind]" => "metric"
        "[event][category]" => "network"
        "[event][module]" => "opnsense"
      }
    }

    # Process interface statistics
    if [statistics] {
      ruby {
        path => "/etc/logstash/ruby/process_interface_metrics.rb"
      }
    }

    mutate {
      remove_field => ["statistics", "headers"]
    }
  }
}

