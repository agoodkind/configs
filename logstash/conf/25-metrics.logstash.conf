filter {
  # Process Gateway metrics (dpinger stats)
  if [type] == "opnsense_gateway_metrics" {
    # Extract hostname from URL
    mutate {
      add_field => { "[host][name]" => "opnsense" }
      add_field => {
        "[data_stream][type]" => "metrics"
        "[data_stream][dataset]" => "opnsense.gateway"
        "[data_stream][namespace]" => "default"
        "[event][kind]" => "metric"
        "[event][category]" => "network"
        "[event][module]" => "opnsense"
      }
    }

    # Process gateway status items
    if [items] {
      ruby {
        code => '
          items = event.get("items")
          if items.is_a?(Array)
            items.each do |gw|
              if gw.is_a?(Hash) && gw["name"]
                name = gw["name"]
                event.set("[metrics][gateway][#{name}][delay_ms]", gw["delay"])
                event.set("[metrics][gateway][#{name}][stddev_ms]", gw["stddev"])
                event.set("[metrics][gateway][#{name}][loss_percent]", gw["loss"])
                event.set("[metrics][gateway][#{name}][status]", gw["status"])
                event.set("[metrics][gateway][#{name}][status_raw]", gw["status_translated"])
              end
            end
          end
        '
      }
    }

    mutate {
      remove_field => ["items", "status", "headers"]
    }
  }

  # Process System resource metrics (CPU/RAM)
  if [type] == "opnsense_system_metrics" {
    mutate {
      add_field => { "[host][name]" => "opnsense" }
      add_field => {
        "[data_stream][type]" => "metrics"
        "[data_stream][dataset]" => "opnsense.system"
        "[data_stream][namespace]" => "default"
        "[event][kind]" => "metric"
        "[event][category]" => "host"
        "[event][module]" => "opnsense"
      }
    }

    # Process memory metrics
    if [memory] {
      mutate {
        copy => { "[memory][used]" => "[metrics][system][memory][used_bytes]" }
        copy => { "[memory][total]" => "[metrics][system][memory][total_bytes]" }
        copy => { "[memory][used_frmt]" => "[metrics][system][memory][used_mb]" }
        copy => { "[memory][total_frmt]" => "[metrics][system][memory][total_mb]" }
      }
      
      # Calculate memory usage percentage
      ruby {
        code => '
          total = event.get("[memory][total]")
          used = event.get("[memory][used]")
          if total && used && total.to_i > 0
            percent = (used.to_f / total.to_f * 100).round(2)
            event.set("[metrics][system][memory][usage_percent]", percent)
          end
        '
      }
    }

    mutate {
      remove_field => ["memory", "headers"]
    }
  }

  # Process System load/uptime metrics
  if [type] == "opnsense_load_metrics" {
    mutate {
      add_field => { "[host][name]" => "opnsense" }
      add_field => {
        "[data_stream][type]" => "metrics"
        "[data_stream][dataset]" => "opnsense.system"
        "[data_stream][namespace]" => "default"
        "[event][kind]" => "metric"
        "[event][category]" => "host"
        "[event][module]" => "opnsense"
      }
    }

    # Parse load averages from string format "0.12, 0.15, 0.18"
    if [loadavg] {
      ruby {
        code => '
          loadavg = event.get("loadavg")
          if loadavg.is_a?(String)
            parts = loadavg.split(",").map(&:strip)
            if parts.length == 3
              event.set("[metrics][system][load][1m]", parts[0].to_f)
              event.set("[metrics][system][load][5m]", parts[1].to_f)
              event.set("[metrics][system][load][15m]", parts[2].to_f)
            end
          end
        '
      }
    }

    # Copy uptime
    if [uptime] {
      mutate {
        copy => { "[uptime]" => "[metrics][system][uptime]" }
      }
    }

    mutate {
      remove_field => ["loadavg", "uptime", "datetime", "boottime", "config", "headers"]
    }
  }

  # Process Interface statistics (bytes/packets in/out)
  if [type] == "opnsense_interface_metrics" {
    mutate {
      add_field => { "[host][name]" => "opnsense" }
      add_field => {
        "[data_stream][type]" => "metrics"
        "[data_stream][dataset]" => "opnsense.interface"
        "[data_stream][namespace]" => "default"
        "[event][kind]" => "metric"
        "[event][category]" => "network"
        "[event][module]" => "opnsense"
      }
    }

    # Process interface statistics
    if [statistics] {
      ruby {
        code => '
          stats = event.get("statistics")
          if stats.is_a?(Hash)
            stats.each do |iface_key, iface_data|
              if iface_data.is_a?(Hash)
                # Use name field as interface identifier
                iface_name = iface_data["name"] || iface_key
                
                event.set("[metrics][interface][#{iface_name}][bytes_in]", iface_data["received-bytes"])
                event.set("[metrics][interface][#{iface_name}][bytes_out]", iface_data["transmitted-bytes"])
                event.set("[metrics][interface][#{iface_name}][packets_in]", iface_data["received-packets"])
                event.set("[metrics][interface][#{iface_name}][packets_out]", iface_data["transmitted-packets"])
                event.set("[metrics][interface][#{iface_name}][errors_in]", iface_data["input-errors"])
                event.set("[metrics][interface][#{iface_name}][errors_out]", iface_data["output-errors"])
                event.set("[metrics][interface][#{iface_name}][collisions]", iface_data["collisions"])
              end
            end
          end
        '
      }
    }

    mutate {
      remove_field => ["statistics", "headers"]
    }
  }
}

