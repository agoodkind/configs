#!/bin/bash
# Bring up AT&T VLAN interface after 802.1X authentication
# For systemd-networkd - waits for auth file, creates VLAN, sets MAC

set -euo pipefail

ATT_IFACE="{{ mwan_att_iface }}"
VLAN_IFACE="{{ mwan_att_iface }}.{{ mwan_att_vlan_id }}"
AUTH_FILE="/run/wpa_supplicant-mwan.authenticated"
MAX_WAIT=60
CHECK_INTERVAL=2

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | \
        systemd-cat -t bringup-att-vlan
}

log "Starting AT&T VLAN bringup script"

# Wait for authentication file
elapsed=0
while [ $elapsed -lt $MAX_WAIT ]; do
    if [ -f "$AUTH_FILE" ]; then
        log "Authentication success file detected"
        break
    fi
    sleep $CHECK_INTERVAL
    elapsed=$((elapsed + CHECK_INTERVAL))
done

if [ ! -f "$AUTH_FILE" ]; then
    log "ERROR: Authentication file not found after ${MAX_WAIT}s"
    exit 1
fi

log "Authentication successful, bringing up VLAN ${VLAN_IFACE}"

# Create VLAN interface if it doesn't exist
if ! ip link show "${VLAN_IFACE}" >/dev/null 2>&1; then
    log "Creating VLAN interface ${VLAN_IFACE}"
    ip link add link "${ATT_IFACE}" name "${VLAN_IFACE}" \
        type vlan id {{ mwan_att_vlan_id }} || {
        log "ERROR: Failed to create VLAN interface"
        exit 1
    }
fi

# Set MAC address BEFORE bringing up (critical for AT&T DHCP)
log "Setting MAC address to {{ mwan_att_mac }}"
ip link set "${VLAN_IFACE}" address {{ mwan_att_mac }} || {
    log "ERROR: Failed to set MAC address"
    exit 1
}

# Bring up the interface
if ! ip link show "${VLAN_IFACE}" | grep -q "state UP"; then
    log "Bringing up VLAN interface"
    ip link set "${VLAN_IFACE}" up || {
        log "ERROR: Failed to bring up interface"
        exit 1
    }
fi

# Disable reverse path filtering for policy routing
sysctl -w net.ipv4.conf."${VLAN_IFACE}".rp_filter=0 || true

log "VLAN interface ${VLAN_IFACE} is UP with correct MAC"
log "systemd-networkd will now configure DHCP"

exit 0
