#!/usr/sbin/nftables -f
# nftables configuration for mwan multi-WAN load balancer
# Generated by Ansible

flush ruleset

# Define variables
define MGMT_IFACE = "{{ mwan_mgmt_iface }}"
define ATT_IFACE = "{{ mwan_att_iface }}.{{ mwan_att_vlan_id }}"
define WEBPASS_IFACE = "{{ mwan_webpass_iface }}"
define INTERNAL_IFACE = "{{ mwan_internal_iface }}"
{% if mwan_health_checks.monkeybrains.enabled | default(false) %}
define MB_IFACE = "{{ mwan_monkeybrains_iface }}"
{% endif %}

# Internal network (mwan <-> OPNsense link)
define INTERNAL_NET = "10.250.250.0/29"
define INTERNAL_V6_NET = "{{ mwan_internal_prefix }}"

table inet filter {
    chain input {
        type filter hook input priority filter; policy drop;
        
        # Allow established/related
        ct state established,related accept
        
        # Allow loopback
        iif lo accept
        
        # Allow ICMP
        ip protocol icmp accept
        ip6 nexthdr icmpv6 accept
        
        # Allow SSH from management network
        iif $MGMT_IFACE tcp dport 22 accept
        # iif $INTERNAL_IFACE tcp dport 22 accept
        
        # Allow DHCP on management interface
        # iif $MGMT_IFACE udp sport 67 udp dport 68 accept
        # iif $MGMT_IFACE udp sport 547 udp dport 546 accept
        
        # Allow DHCP on WAN interfaces
        iif $ATT_IFACE udp sport 67 udp dport 68 accept
        iif $WEBPASS_IFACE udp sport 67 udp dport 68 accept
        iif $ATT_IFACE udp sport 547 udp dport 546 accept
        iif $WEBPASS_IFACE udp sport 547 udp dport 546 accept
{% if mwan_health_checks.monkeybrains.enabled | default(false) %}
        iif $MB_IFACE udp sport 67 udp dport 68 accept
        iif $MB_IFACE udp sport 547 udp dport 546 accept
{% endif %}
        
        # Log dropped packets
        log prefix "nftables input drop: " drop
    }
    
    chain forward {
        type filter hook forward priority filter; policy drop;
        
        # Allow established/related
        ct state established,related accept
        
        # Allow forwarding from internal to WANs
        iif $INTERNAL_IFACE oif { $ATT_IFACE, $WEBPASS_IFACE{% if mwan_health_checks.monkeybrains.enabled | default(false) %}, $MB_IFACE{% endif %} } accept
        
        # Allow forwarding from WANs to internal (for inbound services)
        iif { $ATT_IFACE, $WEBPASS_IFACE{% if mwan_health_checks.monkeybrains.enabled | default(false) %}, $MB_IFACE{% endif %} } oif $INTERNAL_IFACE accept
        
        # Log dropped packets
        log prefix "nftables forward drop: " drop
    }
    
    chain output {
        type filter hook output priority filter; policy accept;
    }
}

table ip nat {
    # Connection tracking for load balancing
    chain prerouting {
        type nat hook prerouting priority dstnat; policy accept;
        
        # Mark new connections for load balancing (fwmark)
        ct state new meta mark set numgen random mod 2 map { 0 : 1, 1 : 2 }
    }
    
    chain postrouting {
        type nat hook postrouting priority srcnat; policy accept;
        
        # 1:1 NAT for static IPs - AT&T
{% for mapping in mwan_static_mappings.att %}
        oif $ATT_IFACE ip saddr {{ mapping.internal }} snat to {{ mapping.external }}
{% endfor %}
        
        # 1:1 NAT for static IPs - Webpass
{% for mapping in mwan_static_mappings.webpass %}
        oif $WEBPASS_IFACE ip saddr {{ mapping.internal }} snat to {{ mapping.external }}
{% endfor %}
        
        # Default SNAT for other LAN traffic via AT&T (mark 1)
        oif $ATT_IFACE meta mark 1 ip saddr $INTERNAL_NET masquerade
        
        # Default SNAT for other LAN traffic via Webpass (mark 2)
        oif $WEBPASS_IFACE meta mark 2 ip saddr $INTERNAL_NET masquerade
        
{% if mwan_health_checks.monkeybrains.enabled | default(false) %}
        # Monkeybrains SNAT (mark 3 or failover)
        oif $MB_IFACE ip saddr $INTERNAL_NET masquerade
{% endif %}
    }
}

table ip6 nat {
    chain prerouting {
        type nat hook prerouting priority dstnat; policy accept;
        
        # Inbound NPT - translate ISP prefix to internal
        # NOTE: These will be dynamically updated by dhcpcd.exit-hook
        # Placeholder rules - updated at runtime
    }
    
    chain postrouting {
        type nat hook postrouting priority srcnat; policy accept;
        
        # Container's own WAN addresses - DO NOT NPT (1:1 fix rules)
        # These will be dynamically added by dhcpcd.exit-hook
        
        # Outbound NPT - translate internal to ISP prefix
        # NOTE: These will be dynamically updated by dhcpcd.exit-hook
        # Placeholder rules - updated at runtime
    }
}

table inet mangle {
    chain prerouting {
        type filter hook prerouting priority mangle; policy accept;
        
        # Mark traffic from static 1:1 NAT IPs to use specific WAN
        # AT&T static IPs (mark 1 = use AT&T WAN)
{% for mapping in mwan_static_mappings.att %}
        ip saddr {{ mapping.internal }} meta mark set 1
{% endfor %}
        
        # Webpass static IPs (mark 2 = use Webpass WAN)
{% for mapping in mwan_static_mappings.webpass %}
        ip saddr {{ mapping.internal }} meta mark set 2
{% endfor %}
        
        # Pin latency-sensitive traffic to AT&T (mark 1)
        # Failover: If AT&T down, update-routes.sh removes the fwmark rule,
        # and traffic falls through to main table (which uses Webpass)
{% if mwan_att_pinned_dests is defined %}
{% for dest in mwan_att_pinned_dests %}
        ip daddr {{ dest }} meta mark set 1
{% endfor %}
{% endif %}
        
        # General traffic (no mark): Uses main table's multipath routing
        # Kernel automatically:
        #   - Load balances 50/50 when both WANs up
        #   - Fails over to single WAN when one is down
        # update-routes.sh manages the multipath route based on health
        
        # Restore mark for established connections (session affinity)
        ct state established,related meta mark set ct mark
    }
    
    chain postrouting {
        type filter hook postrouting priority mangle; policy accept;
        
        # Save mark to conntrack
        ct mark set meta mark
    }
}

