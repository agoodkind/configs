# dhcpcd configuration for mwan
# Generated by Ansible

# Set DUID - CRITICAL for Webpass identity preservation
# Webpass ISP tracks this DUID and will reject connections if it changes
# This DUID must match the value from the original OPNsense setup
# DO NOT MODIFY - Changing this will cause Webpass to deny service
duid {{ mwan_webpass_duid }}

# Allow users of this group to interact with dhcpcd via the control socket
#controlgroup wheel

# Inform the DHCP server of our hostname for DDNS
hostname

# Use the hardware address of the interface for the Client ID
#clientid

# Persist interface configuration when dhcpcd exits
persistent

# Rapid commit support
option rapid_commit

# A list of options to request from the DHCP server
option domain_name_servers, domain_name, domain_search, host_name
option classless_static_routes
option interface_mtu

# Respect the network MTU
option interface_mtu

# Most distributions have NTP support
#option ntp_servers

# A ServerID is required by RFC2131
require dhcp_server_identifier

# Generate SLAAC address using the Hardware Address of the interface
#slaac hwaddr

# OR generate Stable Private IPv6 Addresses based from the DUID
slaac private

# Deny interfaces that should not be managed by dhcpcd
# Only manage specific interfaces explicitly configured below
denyinterfaces {{ interface_mapping.eth1 }} {{ interface_mapping.eth2 }}

# Management interface - request DHCP IP for DNS registration
# Static IP also configured via /etc/network/interfaces
# Result: Interface will have BOTH static (10.250.0.X) and dynamic IP
interface {{ mwan_mgmt_iface }}
    # Request IPv4 via DHCP (hostname sent automatically)
    ipv4
    # Request IPv6 via DHCPv6  
    ipv6rs
    ia_na 3
    # Don't let DHCP change the default gateway
    nogateway

# Static IP for internal interface (to OPNsense)
interface {{ mwan_internal_iface }}
    noipv4
    noipv6rs
    noipv6

# AT&T interface - DHCPv4 + DHCPv6-PD on VLAN 3242
# wpa_supplicant authenticates on raw interface, traffic appears on VLAN
interface {{ mwan_att_iface }}.{{ mwan_att_vlan_id }}
    ipv4
    ipv6rs
    ia_na 1
    ia_pd 2/::/60 {{ interface_mapping.eth3 }}/0

# Webpass interface - DHCPv4 + DHCPv6-PD, NO SLAAC
interface {{ mwan_webpass_iface }}
    ipv4
    noipv6rs  # Don't accept router advertisements (prevents SLAAC)
    ipv6only  # DHCPv6 only
    ia_na 3
    ia_pd 4/::/56 {{ interface_mapping.eth3 }}/0

{% if mwan_health_checks.monkeybrains.enabled | default(false) %}
# Monkeybrains interface - DHCPv4 + DHCPv6-PD
interface {{ mwan_monkeybrains_iface }}
    ipv4
    noipv6rs
    ipv6only
    ia_na 5
    ia_pd 6/::/56 {{ interface_mapping.eth3 }}/0
{% endif %}

