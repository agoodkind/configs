# dhcpcd configuration for mwan
# Generated by Ansible

# Set DUID - CRITICAL for Webpass identity preservation
# Webpass ISP tracks this DUID and will reject connections if it changes
# This DUID must match the value from the original OPNsense setup
# DO NOT MODIFY - Changing this will cause Webpass to deny service
duid {{ mwan_webpass_duid }}

# Allow users of this group to interact with dhcpcd via the control socket
#controlgroup wheel

# Inform the DHCP server of our hostname for DDNS
hostname

# Use the hardware address of the interface for the Client ID
#clientid

# Persist interface configuration when dhcpcd exits
persistent

# Rapid commit support - DISABLED for IPv6-PD compatibility
# AT&T DHCPv6 server doesn't support rapid commit with delegation
#option rapid_commit

# A list of options to request from the DHCP server
option domain_name_servers, domain_name, domain_search, host_name
option classless_static_routes
option interface_mtu

# Respect the network MTU
option interface_mtu

# Most distributions have NTP support
#option ntp_servers

# A ServerID is required by RFC2131
#require dhcp_server_identifier

# Generate SLAAC address using the Hardware Address of the interface
#slaac hwaddr

# OR generate Stable Private IPv6 Addresses based from the DUID
slaac private

# Deny interfaces that should not be managed by dhcpcd
# ens16 (AT&T base VF): Only VLAN 3242 should be managed, not base
denyinterfaces ens16

# Management interface - request DHCP IP for DNS registration
# Static IP also configured via /etc/network/interfaces
# Result: Interface will have BOTH static (10.250.0.X) and dynamic IP
interface eth0
    # Request IPv4 via DHCP (hostname sent automatically)
    ipv4
    # Request IPv6 via DHCPv6  
    ipv6rs
    ia_na 3
    # Don't let DHCP change the default gateway
    nogateway

# Static IP for internal interface (to OPNsense)
interface ens19
    noipv4
    noipv6rs
    noipv6

# AT&T interface - DHCPv4 + DHCPv6-PD on VLAN 3242
# wpa_supplicant authenticates on raw interface, traffic appears on VLAN
interface ens16.{{ mwan_att_vlan_id }}
    ipv4
    ipv6rs
    ia_na 1
    ia_pd 2/::/60 ens19/0

# Webpass interface - DHCPv6-PD ONLY (IPv4 is static in /etc/network/interfaces)
interface ens17
    noipv4    # Static IPv4 configured in /etc/network/interfaces
    ipv6rs  # Don't accept router advertisements (prevents SLAAC, which breaks webpass for some reason)
    ipv6only  # DHCPv6-PD only
    ia_na 3
    ia_pd 4/::/56 ens19/0

{% if mwan_health_checks.monkeybrains.enabled | default(false) %}
# Monkeybrains interface - DHCPv4 + DHCPv6-PD
interface {{ mwan_monkeybrains_iface }}
    ipv4
    noipv6rs
    ipv6only
    ia_na 5
    ia_pd 6/::/56 ens19/0
{% endif %}

