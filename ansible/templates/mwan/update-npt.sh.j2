#!/bin/sh
# Update nftables NPT (IPv6 prefix translation) rules
# Called by dhcpcd.exit-hook when prefix delegation changes
# Generated by Ansible

set -e

WAN_IFACE="$1"
DELEGATED_PREFIX="$2"

if [ -z "$WAN_IFACE" ] || [ -z "$DELEGATED_PREFIX" ]; then
    echo "Usage: $(basename "$0") <wan_iface> <delegated_prefix>"
    echo "Example: $(basename "$0") {{ mwan_att_iface }}.{{ mwan_att_vlan_id }} 2600:1700:2f71:c80::/60"
    exit 1
fi

readonly INTERNAL_PREFIX="{{ mwan_internal_prefix }}"

log() {
    logger -t update-npt "$1"
    echo "[update-npt] $1"
}

log "Updating NPT rules for $WAN_IFACE"
log "  Delegated prefix: $DELEGATED_PREFIX"

# Delete existing postrouting rules for this iface
for handle in $(nft -a list chain ip6 nat postrouting | grep "oif \"$WAN_IFACE\".*# handle" | sed -e 's/^.* handle //'); do
    nft delete rule ip6 nat postrouting handle "$handle"
done

# Delete existing prerouting rules for this iface
for handle in $(nft -a list chain ip6 nat prerouting | grep "iif \"$WAN_IFACE\".*# handle" | sed -e 's/^.* handle //'); do
    nft delete rule ip6 nat prerouting handle "$handle"
done

# Decide target /60 for this iface
case "$WAN_IFACE" in
    "{{ mwan_att_iface }}.{{ mwan_att_vlan_id }}")
        TARGET_PREFIX="{{ mwan_npt_att_prefix }}"
        WAN_GUA="{{ mwan_att_wan_ipv6 }}"
        MARK=1
        ;;
    "{{ mwan_webpass_iface }}")
        TARGET_PREFIX="{{ mwan_npt_webpass_prefix }}"
        WAN_GUA="{{ mwan_webpass_wan_ipv6 }}"
        MARK=2
        ;;
    *)
        log "Unknown WAN iface $WAN_IFACE; skipping"
        exit 0
        ;;
esac

# Postrouting: 
# - NPT LAN /60 to PD /60 (per WAN)
# - SNAT bridge /64 to WAN GUA (per WAN)
nft add rule ip6 nat postrouting oif "$WAN_IFACE" ip6 saddr "$INTERNAL_PREFIX" meta mark $MARK snat ip6 prefix to "$TARGET_PREFIX"
nft add rule ip6 nat postrouting oif "$WAN_IFACE" ip6 saddr "{{ mwan_internal_ipv6 | regex_replace('/64','') }}/64" meta mark $MARK snat to "$WAN_GUA"

# Prerouting: NPT PD /60 back to LAN /60
nft add rule ip6 nat prerouting iif "$WAN_IFACE" ip6 daddr "$TARGET_PREFIX" dnat ip6 prefix to "$INTERNAL_PREFIX"

# Save current nftables config
nft list ruleset > /etc/nftables.conf.dynamic

log "NPT update complete for $WAN_IFACE"
