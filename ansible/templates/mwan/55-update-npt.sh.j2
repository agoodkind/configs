#!/bin/bash
# networkd-dispatcher hook to update NPT after WAN becomes routable
# Generated by Ansible

IFACE="$1"
STATE="$2"

# Only act when interface is routable
[ "$STATE" = "routable" ] || exit 0

ATT_IFACE="{{ mwan_att_iface }}.{{ mwan_att_vlan_id }}"
WEBPASS_IFACE="{{ mwan_webpass_iface }}"

# Only handle AT&T VLAN or Webpass
if [ "$IFACE" != "$ATT_IFACE" ] && [ "$IFACE" != "$WEBPASS_IFACE" ]; then
    exit 0
fi

log() {
    logger -t networkd-dispatcher "[update-npt] $*"
    echo "[update-npt] $*"
}

PREFIXES=$(ip -6 route show proto dhcp dev "$IFACE" | awk '{print $1}' | grep '/')

if [ -z "$PREFIXES" ]; then
    log "No DHCPv6-PD prefix found on $IFACE; skipping NPT update"
    exit 0
fi

for prefix in $PREFIXES; do
    log "Updating NPT for $IFACE with prefix $prefix"
    /usr/local/bin/update-npt.sh "$IFACE" "$prefix" || \
        log "NPT update failed for $IFACE prefix $prefix"
done
