#!/bin/bash
# networkd-dispatcher hook to update policy routing
# Triggered when WAN interfaces become routable (DHCP lease obtained)
# Generated by Ansible

IFACE=$1
STATE=$2

# Only run for routable state (when IP is obtained and interface is up)
if [ "$STATE" != "routable" ]; then
    exit 0
fi

# Only run for WAN interfaces (AT&T VLAN or Webpass)
ATT_VLAN="{{ mwan_att_iface }}.{{ mwan_att_vlan_id }}"
WEBPASS_IFACE="{{ mwan_webpass_iface }}"

if [ "$IFACE" != "$ATT_VLAN" ] && [ "$IFACE" != "$WEBPASS_IFACE" ]; then
    # Not a WAN interface, skip
    exit 0
fi

logger -t networkd-dispatcher \
    "Interface $IFACE is now routable, updating policy routing"

# Call update-routes.sh to rebuild routing tables
/usr/local/bin/update-routes.sh

exit 0
