#!/bin/bash
# Add altname to network interface
# Usage: add-interface-altname.sh <interface> <altname> [skip_if_same]
set -eo pipefail

CURRENT="$1"
ALTNAME="$2"
SKIP_IF_SAME="${3:-false}"

if [ -z "$CURRENT" ] || [ -z "$ALTNAME" ]; then
    echo "Usage: $0 <interface> <altname> [skip_if_same]" >&2
    exit 1
fi

# Skip if already using desired name
if [ "$SKIP_IF_SAME" = "true" ] && [ "$CURRENT" = "$ALTNAME" ]; then
    exit 0
fi

# Check if altname already exists on this interface
if ip link property show dev "$CURRENT" 2>/dev/null | \
   grep -q "altname $ALTNAME"; then
    echo "already_exists"
    exit 0
fi

# Check if altname is used by another interface
if ip link show "$ALTNAME" >/dev/null 2>&1; then
    other=$(ip -o link show "$ALTNAME" | awk '{print $2}' | \
        sed 's/:$//')
    if [ "$other" != "$CURRENT" ]; then
        echo "ERROR: altname $ALTNAME already in use by $other" >&2
        exit 1
    fi
fi

# Try to add altname (ignore "File exists" error)
output=$(ip link property add dev "$CURRENT" altname "$ALTNAME" 2>&1) \
    || rc=$?
if [ ${rc:-0} -eq 0 ]; then
    echo "changed"
elif echo "$output" | grep -q "File exists"; then
    # "File exists" means altname already exists - that's OK!
    echo "already_exists"
else
    echo "ERROR: Failed to add altname: $output" >&2
    exit 1
fi


