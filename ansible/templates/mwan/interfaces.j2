# Debian network interfaces configuration for mwan VM
# Generated by Ansible - PCI passthrough architecture

auto lo
iface lo inet loopback

# ==============================================================================
# Management Interface - static IP + DHCP for hostname registration
# ==============================================================================
auto {{ mwan_mgmt_iface }}
iface {{ mwan_mgmt_iface }} inet static
    address 10.250.0.{{ mwan_vmid }}
    netmask 255.255.255.0
    gateway 10.250.0.1
    dns-nameservers {{ mwan_dns_servers }}
    dns-search {{ mwan_dns_domain }}
    # Run DHCP client to register hostname in DNS (dhcpcd auto-sends hostname)
    post-up dhcpcd -n {{ mwan_mgmt_iface }} || true
    pre-down killall dhcpcd 2>/dev/null || true

iface {{ mwan_mgmt_iface }} inet6 static
    address 3d06:bad:b01::{{ '%x' | format(mwan_vmid) }}
    netmask 64
    gateway 3d06:bad:b01::1
    # Run DHCPv6 client to register hostname in DNS
    post-up dhcpcd -n -6 {{ mwan_mgmt_iface }} || true

# ==============================================================================
# AT&T WAN - X710 VF passthrough (iavf driver)
# wpa_supplicant authenticates on raw interface, traffic appears on VLAN 3242
# ==============================================================================
auto {{ mwan_att_iface }}
iface {{ mwan_att_iface }} inet manual
    pre-up ip link set {{ mwan_att_iface }} up

# AT&T VLAN 3242 (created after wpa_supplicant authenticates)
auto {{ mwan_att_iface }}.{{ mwan_att_vlan_id }}
iface {{ mwan_att_iface }}.{{ mwan_att_vlan_id }} inet manual
    vlan-raw-device {{ mwan_att_iface }}
    # DHCPv4 and DHCPv6-PD handled by dhcpcd

# ==============================================================================
# Webpass WAN - I226-V NIC passthrough (igc driver)
# CRITICAL: I226-V hardware MAC is wrong, MUST spoof to registered MAC
# ==============================================================================
auto {{ mwan_webpass_iface }}
iface {{ mwan_webpass_iface }} inet manual
    # CRITICAL: Set MAC to Webpass-registered address BEFORE bringing up
    pre-up ip link set dev {{ mwan_webpass_iface }} address {{ mwan_webpass_mac }}
    pre-up ip link set {{ mwan_webpass_iface }} up
    # DHCPv4 and DHCPv6-PD handled by dhcpcd

# ==============================================================================
# Internal Link (to OPNsense) - virtio on mwanbr
# ==============================================================================
auto {{ mwan_internal_iface }}
iface {{ mwan_internal_iface }} inet static
    address {{ mwan_internal_ipv4 }}

iface {{ mwan_internal_iface }} inet6 static
    address {{ mwan_internal_ipv6 }}

{% if mwan_health_checks.monkeybrains.enabled | default(false) %}
# ==============================================================================
# Monkeybrains WAN - virtio on mbrains bridge (optional)
# ==============================================================================
auto {{ mwan_monkeybrains_iface }}
iface {{ mwan_monkeybrains_iface }} inet manual
    pre-up ip link set {{ mwan_monkeybrains_iface }} up
    # DHCPv4 and DHCPv6-PD handled by dhcpcd
{% endif %}