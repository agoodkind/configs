# Debian network interfaces configuration for mwan VM
# Generated by Ansible - uses real kernel interface names
# altnames (eth0-3) configured via udev for convenience

auto lo
iface lo inet loopback

# ==============================================================================
# Management Interface - static IP + DHCP for hostname registration
# ==============================================================================
auto {{ interface_mapping.eth0 }}
iface {{ interface_mapping.eth0 }} inet static
    address 10.250.0.{{ mwan_vmid }}
    netmask 255.255.255.0
    gateway 10.250.0.1
    dns-nameservers {{ mwan_dns_servers }}
    dns-search {{ mwan_dns_domain }}
    # Note: dhcpcd will also request a DHCP IP on this interface
    # Result: Interface will have both static and dynamic IPs

iface {{ interface_mapping.eth0 }} inet6 static
    address 3d06:bad:b01::{{ '%x' | format(mwan_vmid | int) }}
    netmask 64
    gateway 3d06:bad:b01::1
    # Note: dhcpcd will also request DHCPv6 addresses

# ==============================================================================
# AT&T WAN - X710 VF passthrough (iavf driver)
# wpa_supplicant authenticates on raw interface, traffic appears on VLAN 3242
# ==============================================================================
auto {{ interface_mapping.eth1 }}
iface {{ interface_mapping.eth1 }} inet manual
    pre-up ip link set {{ interface_mapping.eth1 }} up

# AT&T VLAN 3242 (created after wpa_supplicant authenticates)
auto {{ interface_mapping.eth1 }}.{{ mwan_att_vlan_id }}
iface {{ interface_mapping.eth1 }}.{{ mwan_att_vlan_id }} inet manual
    vlan-raw-device {{ interface_mapping.eth1 }}
    # DHCPv4 and DHCPv6-PD handled by dhcpcd
    # Disable reverse path filtering for policy routing
    post-up sysctl -w net.ipv4.conf.{{ interface_mapping.eth1 }}.{{ mwan_att_vlan_id }}.rp_filter=0 || true

# ==============================================================================
# Webpass WAN - I226-V NIC passthrough (igc driver)
# CRITICAL: I226-V hardware MAC is wrong, MUST spoof to registered MAC
# ==============================================================================
auto {{ interface_mapping.eth2 }}
iface {{ interface_mapping.eth2 }} inet static
    # CRITICAL: Set MAC to Webpass-registered address BEFORE bringing up
    pre-up ip link set dev {{ interface_mapping.eth2 }} address {{ mwan_webpass_mac }}
    address {{ mwan_webpass_ipv4 }}
    gateway {{ mwan_webpass_gateway }}
    # DHCPv6-PD handled by dhcpcd (IPv6 ONLY)

# ==============================================================================
# Internal Link (to OPNsense) - virtio on mwanbr
# ==============================================================================
auto {{ interface_mapping.eth3 }}
iface {{ interface_mapping.eth3 }} inet static
    address {{ mwan_internal_ipv4 }}

iface {{ interface_mapping.eth3 }} inet6 static
    address {{ mwan_internal_ipv6 }}

{% if mwan_health_checks.monkeybrains.enabled | default(false) %}
# ==============================================================================
# Monkeybrains WAN - virtio on mbrains bridge (optional)
# ==============================================================================
auto {{ mwan_monkeybrains_iface }}
iface {{ mwan_monkeybrains_iface }} inet manual
    pre-up ip link set {{ mwan_monkeybrains_iface }} up
    # DHCPv4 and DHCPv6-PD handled by dhcpcd
{% endif %}