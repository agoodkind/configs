# Debian network interfaces configuration for mwan VM
# Generated by Ansible - uses hardcoded interface names (eth0-3)

auto lo
iface lo inet loopback

# ==============================================================================
# Management Interface - static IP + DHCP for hostname registration
# ==============================================================================
auto eth0

iface eth0 inet manual
    # TODO: figure out why this isn't sending a DHCP release
    pre-down dhcpcd -4 --release eth0
    post-up dhcpcd -4 --rebind eth0

iface eth0:0 inet static
    address 10.250.0.{{ mwan_vmid }}
    netmask 255.255.255.0
    gateway 10.250.0.1
    dns-nameservers {{ mwan_dns_servers }}
    dns-search {{ mwan_dns_domain }}

iface eth0 inet6 manual
    # TODO: figure out why this isn't sending a DHCP release
    pre-down dhcpcd -6 --release eth0
    post-up dhcpcd -6 --rebind eth0

iface eth0:0 inet6 static
    address 3d06:bad:b01::{{ '%x' | format(mwan_vmid | int) }}
    netmask 64
    gateway 3d06:bad:b01::1

# ==============================================================================
# AT&T WAN - X710 VF passthrough (iavf driver)
# wpa_supplicant authenticates on raw interface, traffic appears on VLAN 3242
# ==============================================================================
auto ens16
iface ens16 inet manual
    # CRITICAL: Set MAC for AT&T authentication BEFORE bringing up
    pre-up ip link set ens16 address {{ mwan_att_mac }}
    pre-up ip link set ens16 up

# AT&T VLAN 3242 (created after wpa_supplicant authenticates)
auto ens16.{{ mwan_att_vlan_id }}
iface ens16.{{ mwan_att_vlan_id }} inet manual
    vlan-raw-device ens16
    # CRITICAL: Set MAC for AT&T DHCP authentication AFTER VLAN is created
    post-up ip link set ens16.{{ mwan_att_vlan_id }} address {{ mwan_att_mac }}
    # DHCPv4 and DHCPv6-PD handled by dhcpcd
    # Disable reverse path filtering for policy routing
    post-up sysctl -w net.ipv4.conf.ens16.{{ mwan_att_vlan_id }}.rp_filter=0 || true

# ==============================================================================
# Webpass WAN - I226-V NIC passthrough (igc driver)
# CRITICAL: I226-V hardware MAC is wrong, MUST spoof to registered MAC
# ==============================================================================
auto ens17
iface ens17 inet static
    # CRITICAL: Set MAC to Webpass-registered address BEFORE bringing up
    pre-up ip link set dev ens17 address {{ mwan_webpass_mac }}
    address {{ mwan_webpass_ipv4 }}
    gateway {{ mwan_webpass_gateway }}
    # Specify metric so that this default route doesn't conflict with the one defined for the management interface.
    metric 10
    # Also add gateway to webpass routing table for policy routing
    post-up ip route add default via {{ mwan_webpass_gateway }} dev ens17 table webpass || true
    post-up ip rule add from {{ mwan_webpass_ipv4 | regex_replace('/.*$', '') }} table webpass priority 200 || true
    pre-down ip rule del from {{ mwan_webpass_ipv4 | regex_replace('/.*$', '') }} table webpass priority 200 || true
    pre-down ip route del default via {{ mwan_webpass_gateway }} dev ens17 table webpass || true
    # DHCPv6-PD handled by dhcpcd (IPv6 ONLY)

# ==============================================================================
# Internal Link (to OPNsense) - virtio on mwanbr
# ==============================================================================
auto ens19
iface ens19 inet static
    address {{ mwan_internal_ipv4 }}

iface ens19 inet6 static
    address {{ mwan_internal_ipv6 }}