#!/bin/bash
# MWAN debug helper
# Generated by Ansible

set -euo pipefail

IFACES=(
  "{{ mwan_att_iface }}.{{ mwan_att_vlan_id }}"
  "{{ mwan_webpass_iface }}"
)
PING6_TARGETS=("2606:4700:4700::1111" "2620:fe::9")
CURL_TARGETS=("https://ifconfig.co" "https://api.ipify.org")
LB_ITER=${LB_ITER:-6}
PING4_TARGETS=("1.1.1.1" "8.8.8.8")

usage() {
    cat <<'EOT'
Usage: mwan-debug.sh [command] [args...]
Commands:
  prefixes     Show PDs (routes + journal)
  routes       Show proto dhcp routes
  npt          Show ip6 nat NPT rules
  status       Show networkctl status for WAN ifaces
  stats        Show link stats for WAN ifaces
  ping4 [if]   Ping IPv4 targets from iface (default first WAN)
  ping6 [if]   Ping IPv6 targets from iface (default first WAN)
  curl4 [if]   curl -4 from iface to ifconfig.co/api.ipify.org
  curl6 [if]   curl -6 from iface to ifconfig.co/api.ipify.org
  lb4          Curl -4 repeatedly (main table) to show mix of egress
  lb6          Curl -6 repeatedly (main table) to show mix of egress
  lb4-ifaces   Curl -4 alternating WAN ifaces (no mgmt)
  lb6-ifaces   Curl -6 alternating WAN ifaces (no mgmt)
  policy       Show ip rules, WAN tables, and mangle marks
  sim4         Route-get IPv4 from LAN src (incl. marks 1/2)
  sim6         Route-get IPv6 from LAN src (incl. marks 1/2)
EOT
}

show_pd() {
    echo "== Proto dhcp routes =="
    ip -6 route show proto dhcp || true
    echo
    echo "== Delegated prefixes from journal (last per iface) =="
    for ifc in "${IFACES[@]}"; do
        pref=$(journalctl -u systemd-networkd -b |
            grep "$ifc: DHCP: received delegated prefix" | tail -1 | awk '{print $NF}')
        echo "$ifc: ${pref:-none}"
    done
}

show_routes() {
    ip -6 route show proto dhcp || true
}

show_nft() {
    nft list table ip6 nat || true
}

show_status() {
    for ifc in "${IFACES[@]}"; do
        echo "== $ifc =="
        networkctl status "$ifc" --no-pager || true
        echo
    done
}

show_stats() {
    for ifc in "${IFACES[@]}"; do
        echo "== $ifc =="
        ip -s link show dev "$ifc" || true
        echo
    done
}

run_ping6() {
    local ifc="${1:-${IFACES[0]}}"
    for tgt in "${PING6_TARGETS[@]}"; do
        echo "Ping6 $tgt via $ifc"
        ping -6 -c 3 -I "$ifc" "$tgt" || true
        echo
    done
}

run_ping4() {
    local ifc="${1:-${IFACES[0]}}"
    for tgt in "${PING4_TARGETS[@]}"; do
        echo "Ping4 $tgt via $ifc"
        ping -c 3 -I "$ifc" "$tgt" || true
        echo
    done
}

run_curl4() {
    local ifc="${1:-${IFACES[0]}}"
    for tgt in "${CURL_TARGETS[@]}"; do
        echo "curl4 $tgt via $ifc"
        CURL_IFACE="$ifc" CURL_IP_VERSION=4 curl -4 --interface "$ifc" -s "$tgt" || true
        echo
    done
}

run_curl6() {
    local ifc="${1:-${IFACES[0]}}"
    for tgt in "${CURL_TARGETS[@]}"; do
        echo "curl6 $tgt via $ifc"
        CURL_IFACE="$ifc" CURL_IP_VERSION=6 curl -6 --interface "$ifc" -s "$tgt" || true
        echo
    done
}

run_lb4() {
    for i in $(seq 1 "$LB_ITER"); do
        tgt="${CURL_TARGETS[$(( (i-1) % ${#CURL_TARGETS[@]} ))]}"
        echo "lb4 iter $i -> $tgt (no iface hint)"
        curl -4 -s "$tgt" || true
        echo
    done
}

run_lb6() {
    for i in $(seq 1 "$LB_ITER"); do
        tgt="${CURL_TARGETS[$(( (i-1) % ${#CURL_TARGETS[@]} ))]}"
        echo "lb6 iter $i -> $tgt (no iface hint)"
        curl -6 -s "$tgt" || true
        echo
    done
}

run_lb4_ifaces() {
    for i in $(seq 1 "$LB_ITER"); do
        ifc="${IFACES[$(( (i-1) % ${#IFACES[@]} ))]}"
        tgt="${CURL_TARGETS[$(( (i-1) % ${#CURL_TARGETS[@]} ))]}"
        echo "lb4-ifaces iter $i via $ifc -> $tgt"
        curl -4 --interface "$ifc" -s "$tgt" || true
        echo
    done
}

run_lb6_ifaces() {
    for i in $(seq 1 "$LB_ITER"); do
        ifc="${IFACES[$(( (i-1) % ${#IFACES[@]} ))]}"
        tgt="${CURL_TARGETS[$(( (i-1) % ${#CURL_TARGETS[@]} ))]}"
        echo "lb6-ifaces iter $i via $ifc -> $tgt"
        curl -6 --interface "$ifc" -s "$tgt" || true
        echo
    done
}

show_policy() {
    echo "== ip rule =="
    ip rule show || true
    echo
    echo "== table 100 (att) v4 =="
    ip route show table 100 || true
    echo "== table 100 (att) v6 =="
    ip -6 route show table 100 || true
    echo
    echo "== table 200 (webpass) v4 =="
    ip route show table 200 || true
    echo "== table 200 (webpass) v6 =="
    ip -6 route show table 200 || true
    echo
    echo "== mangle marks =="
    nft list table inet mangle | grep 'meta mark' || true
}

sim4() {
    echo "== ip route get 1.1.1.1 from LAN =="
    ip route get 1.1.1.1 from 10.250.250.2 || true
    echo "-- mark 1 (att) --"
    ip route get 1.1.1.1 from 10.250.250.2 mark 1 || true
    echo "-- mark 2 (webpass) --"
    ip route get 1.1.1.1 from 10.250.250.2 mark 2 || true
}

sim6() {
    echo "== ip -6 route get 2606:4700:4700::1111 from LAN =="
    ip -6 route get 2606:4700:4700::1111 from 3d06:bad:b01:fe::2 || true
    echo "-- mark 1 (att) --"
    ip -6 route get 2606:4700:4700::1111 from 3d06:bad:b01:fe::2 mark 1 || true
    echo "-- mark 2 (webpass) --"
    ip -6 route get 2606:4700:4700::1111 from 3d06:bad:b01:fe::2 mark 2 || true
}

cmd="${1:-}"
shift || true

case "$cmd" in
    prefixes) show_pd ;;
    routes) show_routes ;;
    npt) show_nft ;;
    status) show_status ;;
    stats) show_stats ;;
    ping4) run_ping4 "${1:-}" ;;
    ping6) run_ping6 "${1:-}" ;;
    curl4) run_curl4 "${1:-}" ;;
    curl6) run_curl6 "${1:-}" ;;
    lb4) run_lb4 ;;
    lb6) run_lb6 ;;
    lb4-ifaces) run_lb4_ifaces ;;
    lb6-ifaces) run_lb6_ifaces ;;
    policy) show_policy ;;
    sim4) sim4 ;;
    sim6) sim6 ;;
    ""|help|-h|--help) usage ;;
    *)
        echo "Unknown command: $cmd" >&2
        usage
        exit 1
        ;;
esac
