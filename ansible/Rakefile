# frozen_string_literal: true

require 'dotenv'
require 'fileutils'
require_relative '../lib/rake_common'

# Load .env from current directory and parent directory
Dotenv.load('.env', '../.env')

# Include common helpers
include RakeCommon

ANSIBLE_HOST = ENV.fetch('ANSIBLE_HOST', 'ansible.home.goodkind.io')
ANSIBLE_USER = ENV.fetch('ANSIBLE_USER', 'root')
ANSIBLE_DIR = '/root/ansible'
LOCAL_PLAYBOOKS_DIR = 'playbooks'
LOCAL_ROLES_DIR = 'roles'
LOCAL_INVENTORY_DIR = 'inventory'

##
# Get full Ansible host string (user@host)
#
# @return [String] Ansible host connection string
def ansible_host_string
  "#{ANSIBLE_USER}@#{ANSIBLE_HOST}"
end

##
# Execute command on ansible host and return output
#
# @param args [Array] command and arguments
# @return [String] command output
def ssh_ansible(*args)
  ssh_exec(ansible_host_string, *args)
end

##
# Execute command on ansible host with error handling
#
# @param args [Array] command and arguments
# @return [void]
def ssh_ansible_sh(*)
  ssh_exec_sh(ansible_host_string, *)
end

##
# Upload files to ansible host
#
# @param local_path [String] local file or directory path
# @param remote_path [String] remote destination path
# @return [void]
def scp_to_ansible(local_path, remote_path)
  sh 'scp', '-r', '-q', local_path, "#{ansible_host_string}:#{remote_path}", verbose: verbose?
end

##
# Sync files to ansible host using rsync
#
# @param local_path [String] local directory path
# @param remote_path [String] remote destination path
# @param delete [Boolean] delete files on remote that don't exist locally
# @return [void]
def rsync_to_ansible(local_path, remote_path, delete: false)
  rsync_to_host(local_path, ansible_host_string, remote_path, delete: delete)
end

desc 'Show Ansible version and status'
task :status do
  puts '▶️  Checking Ansible status...'
  ssh_ansible_sh('ansible', '--version')
  puts '✅ Status retrieved'
end

desc 'List deployed playbooks'
task :list do
  puts '▶️  Listing deployed playbooks...'
  ssh_ansible_sh('find', ANSIBLE_DIR, '-name', '*.yml', '-o', '-name', '*.yaml')
end

desc 'Backup current Ansible configs'
task :backup do
  puts '▶️  Creating backup...'
  timestamp = Time.now.strftime('%Y%m%d_%H%M%S')
  backup_dir = "#{ANSIBLE_DIR}.backup.#{timestamp}"

  ssh_ansible_sh('sudo', 'cp', '-r', ANSIBLE_DIR, backup_dir)
  puts "✅ Backup created: #{backup_dir}".green
end

desc 'Clean remote Ansible configs'
task :clean do
  puts '▶️  Cleaning remote configs...'
  ssh_ansible_sh('sudo', 'rm', '-rf', "#{ANSIBLE_DIR}/playbooks")
  ssh_ansible_sh('sudo', 'rm', '-rf', "#{ANSIBLE_DIR}/roles")
  ssh_ansible_sh('sudo', 'rm', '-rf', "#{ANSIBLE_DIR}/inventory")
  puts '✅ Remote configs cleaned'
end

desc 'Deploy playbooks to Ansible host'
task :deploy_playbooks do
  if Dir.empty?(LOCAL_PLAYBOOKS_DIR)
    puts '⚠️  No playbooks to deploy'.yellow
    next
  end

  puts '▶️  Deploying playbooks...'
  ssh_ansible_sh('sudo', 'mkdir', '-p', "#{ANSIBLE_DIR}/playbooks")
  rsync_to_ansible(LOCAL_PLAYBOOKS_DIR, "#{ANSIBLE_DIR}/playbooks", delete: true)
  ssh_ansible_sh('sudo', 'chown', '-R', 'root:root', "#{ANSIBLE_DIR}/playbooks")
  puts '✅ Playbooks deployed'
end

desc 'Deploy roles to Ansible host'
task :deploy_roles do
  if Dir.empty?(LOCAL_ROLES_DIR)
    puts '⚠️  No roles to deploy'.yellow
    next
  end

  puts '▶️  Deploying roles...'
  ssh_ansible_sh('sudo', 'mkdir', '-p', "#{ANSIBLE_DIR}/roles")
  rsync_to_ansible(LOCAL_ROLES_DIR, "#{ANSIBLE_DIR}/roles", delete: true)
  ssh_ansible_sh('sudo', 'chown', '-R', 'root:root', "#{ANSIBLE_DIR}/roles")
  puts '✅ Roles deployed'
end

desc 'Deploy inventory to Ansible host'
task :deploy_inventory do
  if Dir.empty?(LOCAL_INVENTORY_DIR)
    puts '⚠️  No inventory files to deploy'.yellow
    next
  end

  puts '▶️  Deploying inventory...'
  ssh_ansible_sh('sudo', 'mkdir', '-p', "#{ANSIBLE_DIR}/inventory")
  rsync_to_ansible(LOCAL_INVENTORY_DIR, "#{ANSIBLE_DIR}/inventory", delete: true)
  ssh_ansible_sh('sudo', 'chown', '-R', 'root:root', "#{ANSIBLE_DIR}/inventory")
  puts '✅ Inventory deployed'
end

desc 'Run ansible-lint on local playbooks'
task :lint do
  puts '▶️  Linting playbooks...'
  playbooks = Dir.glob("#{LOCAL_PLAYBOOKS_DIR}/*.{yml,yaml}")
  
  if playbooks.empty?
    puts '⚠️  No playbooks to lint'.yellow
    next
  end

  playbooks.each do |playbook|
    puts "  Checking #{File.basename(playbook)}..."
    sh 'ansible-lint', playbook, verbose: verbose?
  end

  puts '✅ Linting complete'
end

desc 'Validate playbook syntax'
task :validate, [:playbook] do |_t, args|
  playbook = args[:playbook]
  
  unless playbook
    puts '❌ Please specify a playbook: rake validate[playbook.yml]'.red
    exit 1
  end

  puts "▶️  Validating #{playbook}..."
  
  # Upload playbook to temp location
  temp_file = "/tmp/ansible_validate_#{Time.now.strftime('%Y%m%d_%H%M%S')}.yml"
  scp_to_ansible("#{LOCAL_PLAYBOOKS_DIR}/#{playbook}", temp_file)
  
  # Run syntax check
  ssh_ansible_sh('ansible-playbook', '--syntax-check', temp_file)
  ssh_ansible_sh('rm', '-f', temp_file)
  
  puts '✅ Syntax valid'
end

desc 'Run a playbook on Ansible host'
task :run, [:playbook] do |_t, args|
  playbook = args[:playbook]
  
  unless playbook
    puts '❌ Please specify a playbook: rake run[playbook.yml]'.red
    exit 1
  end

  puts "▶️  Running playbook: #{playbook}..."
  ssh_ansible_sh('ansible-playbook', "#{ANSIBLE_DIR}/playbooks/#{playbook}")
  puts '✅ Playbook execution complete'
end

desc 'Deploy all Ansible configurations'
task deploy: %i[backup deploy_playbooks deploy_roles deploy_inventory] do
  puts ''
  puts '✅ Deployment complete'
  puts ''
  puts 'Next steps:'.yellow
  puts '  1. rake list        - List deployed files'
  puts '  2. rake run[name]   - Run a playbook'
end

desc 'Run complete workflow (lint, validate, deploy)'
task full_deploy: %i[lint deploy] do
  puts ''
  puts '✅ Full deployment complete'
end

desc 'Show help'
task :help do
  puts 'Ansible Configuration Management'.blue
  puts ''
  puts 'Available tasks:'.green
  puts '  rake status              - Show Ansible version and status'
  puts '  rake list                - List deployed playbooks'
  puts '  rake backup              - Backup current configs'
  puts '  rake lint                - Lint local playbooks'
  puts '  rake validate[playbook]  - Validate playbook syntax'
  puts '  rake deploy              - Deploy all configurations'
  puts '  rake full_deploy         - Lint and deploy'
  puts '  rake run[playbook]       - Run a playbook'
  puts ''
  puts 'Examples:'.yellow
  puts '  rake deploy'
  puts '  rake validate[site.yml]'
  puts '  rake run[site.yml]'
  puts '  ANSIBLE_HOST=other.host rake deploy'
end

task default: :help

