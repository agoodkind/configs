---
# ============================================================================
# AT&T Authentication VM Deployment
# ============================================================================
# Deploys attauth VM for AT&T 802.1X authentication
# Handles X710 dual-port NIC:
#   - Port 1: AT&T auth + VLAN 3242 → "att" bridge
#   - Port 2: OPNsense LAN → "lan" bridge
#
# Required (if VM doesn't exist): -e pci_x710="02:00.0"
# ============================================================================

- name: Setup attauth VM
  ansible.builtin.import_playbook: setup-debian-vm.yml
  vars:
    hostname: "{{ attauth_hostname }}"
    target_node: vault
    disk_size: "4"
    memory: "512"
    cores: "1"
    network_interfaces:
      - "{{ attauth_mgmt_bridge | default('vmbr0') }}"
      - "{{ attauth_att_output_bridge | default('att') }}"
      - "{{ attauth_lan_output_bridge | default('lan') }}"
    hostpci_devices:
      - "{{ pci_x710 | default('') }}"
    vm_tags: "vm,attauth,network"
    mgmt_ip_config: "ip={{ attauth_mgmt_ipv4 }},gw=10.250.0.1,ip6={{ attauth_mgmt_ipv6 }},gw6=3d06:bad:b01::1"
    dns_domain: "{{ attauth_dns_domain }}"
    dns_servers: "{{ attauth_dns_servers }}"
    enable_serial: true
    enable_qemu_agent: true

- name: Configure attauth VM
  hosts: attauth_servers
  become: true

  vars:
    repo_root: "{{ playbook_dir | dirname | dirname }}"

  tasks:
    - name: Wait for VM
      ansible.builtin.wait_for_connection:
        timeout: 60
      register: connection_check
      failed_when: false

    - name: Gather facts
      ansible.builtin.setup:
      when: connection_check.failed is not defined or not connection_check.failed

    - name: Verify Debian
      ansible.builtin.assert:
        that:
          - ansible_os_family == "Debian"
        fail_msg: "This playbook requires Debian. Found: {{ ansible_os_family | default('unknown') }}"
        success_msg: "✓ {{ ansible_distribution }} {{ ansible_distribution_version }}"

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

    - name: Install required packages
      ansible.builtin.apt:
        name:
          - wpasupplicant
          - bridge-utils
          - vlan
        state: present

    - name: Create wpa_supplicant config directory
      ansible.builtin.file:
        path: /etc/wpa_supplicant
        state: directory
        mode: '0755'

    - name: Deploy network interfaces config
      ansible.builtin.template:
        src: "{{ repo_root }}/ansible/templates/attauth/interfaces.j2"
        dest: /etc/network/interfaces
        mode: '0644'
        backup: true
      notify: Restart networking

    - name: Deploy wpa_supplicant config
      ansible.builtin.template:
        src: "{{ repo_root }}/ansible/templates/attauth/wpa_supplicant.conf.j2"
        dest: /etc/wpa_supplicant/wpa_supplicant.conf
        mode: '0600'
      notify: Restart wpa_supplicant

    - name: Check for AT&T certificates
      ansible.builtin.stat:
        path: "/etc/wpa_supplicant/{{ item }}"
      loop:
        - ca_cert.pem
        - client_cert.pem
        - private_key.pem
      register: cert_check

    - name: Warn if certificates missing
      ansible.builtin.debug:
        msg: |
          ⚠️  Certificate {{ item.item }} missing!
          Upload: scp agoodkind@router:/conf/opnatt/wpa/*.pem root@{{ inventory_hostname }}:/etc/wpa_supplicant/
      when: not item.stat.exists
      loop: "{{ cert_check.results }}"

    - name: Deploy wpa_supplicant systemd service
      ansible.builtin.template:
        src: "{{ repo_root }}/ansible/templates/attauth/wpa_supplicant.service.j2"
        dest: /etc/systemd/system/wpa_supplicant-attauth.service
        mode: '0644'
      notify: Reload systemd

    - name: Flush handlers
      ansible.builtin.meta: flush_handlers

    - name: Enable wpa_supplicant service
      ansible.builtin.systemd:
        name: wpa_supplicant-attauth
        enabled: true
        daemon_reload: true

    - name: Start wpa_supplicant
      ansible.builtin.systemd:
        name: wpa_supplicant-attauth
        state: started
      failed_when: false

    - name: Check wpa_supplicant status
      ansible.builtin.command: wpa_cli status
      register: wpa_status
      changed_when: false
      failed_when: false

    - name: Display wpa_supplicant status
      ansible.builtin.debug:
        msg: "{{ wpa_status.stdout_lines | default(['wpa_supplicant not running']) }}"

  handlers:
    - name: Reload systemd
      ansible.builtin.systemd:
        daemon_reload: true

    - name: Restart networking
      ansible.builtin.systemd:
        name: networking
        state: restarted

    - name: Restart wpa_supplicant
      ansible.builtin.systemd:
        name: wpa_supplicant-attauth
        state: restarted
