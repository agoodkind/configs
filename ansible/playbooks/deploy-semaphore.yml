---
# Deploy Semaphore UI on the ansible container

- name: Setup Semaphore container
  ansible.builtin.import_playbook: setup-service-container.yml
  vars:
    container_group: ansible_servers
    group_vars_file: >-
      {{ playbook_dir }}/../inventory/group_vars/ansible_servers.yml
    hostname_var: ansible_hostname
    mac_var: ansible_mac_address
    target_node: vault
    container_vmid: ""
    disk_size: "16"
    memory: "2048"
    cores: "2"
    container_tags: "lxc,ansible,semaphore"

- name: Deploy and Configure Semaphore
  hosts: ansible_servers
  become: true

  vars:
    semaphore_version: "{{ hostvars[inventory_hostname].semaphore_version }}"
    semaphore_user: "{{ hostvars[inventory_hostname].semaphore_user }}"
    semaphore_group: "{{ hostvars[inventory_hostname].semaphore_group }}"
    semaphore_install_dir: >-
      {{ hostvars[inventory_hostname].semaphore_install_dir }}
    semaphore_config_dir: >-
      {{ hostvars[inventory_hostname].semaphore_config_dir }}
    semaphore_data_dir: "{{ hostvars[inventory_hostname].semaphore_data_dir }}"

  tasks:
    - name: Check if Semaphore is installed
      ansible.builtin.stat:
        path: "{{ semaphore_install_dir }}/semaphore"
      register: semaphore_binary

    - name: Get installed Semaphore version
      ansible.builtin.shell:
        cmd: |
          set -o pipefail
          {{ semaphore_install_dir }}/semaphore version |
          grep -oP '^[0-9]+\.[0-9]+\.[0-9]+'
        executable: /bin/bash
      register: semaphore_installed_version
      when: semaphore_binary.stat.exists
      changed_when: false
      failed_when: false

    - name: Display current version
      ansible.builtin.debug:
        msg: >-
          Current Semaphore version:
          {{ semaphore_installed_version.stdout | default('Not installed') }}

    - name: Get latest release version from GitHub API
      ansible.builtin.uri:
        url: >-
          https://api.github.com/repos/semaphoreui/semaphore/releases/latest
        return_content: true
      register: github_release
      when: semaphore_version == 'latest'

    - name: Set target version fact
      ansible.builtin.set_fact:
        semaphore_target_version: >-
          {%- if semaphore_version == 'latest' and
             github_release is defined -%}
          {{- github_release.json.tag_name |
             regex_replace('^v', '') | trim -}}
          {%- else -%}
          {{- semaphore_version | trim -}}
          {%- endif -%}

    - name: Check if update is needed
      ansible.builtin.set_fact:
        update_needed: >-
          {{ not semaphore_binary.stat.exists or
             (semaphore_installed_version.stdout is not defined) or
             (semaphore_target_version !=
              semaphore_installed_version.stdout) }}

    - name: Display update status
      ansible.builtin.debug:
        msg: >-
          {% if update_needed %}
          Updating Semaphore from
          {{ semaphore_installed_version.stdout | default('Not installed') }}
          to {{ semaphore_target_version }}
          {% else %}
          Semaphore is already at version
          {{ semaphore_installed_version.stdout }}
          (target: {{ semaphore_target_version }})
          {% endif %}

    - name: Download and install Semaphore
      when: update_needed | bool
      block:

        - name: Set download base URL
          ansible.builtin.set_fact:
            semaphore_base_url: >-
              {{- 'https://github.com/semaphoreui/semaphore/' -}}
              {{- 'releases/download/v' -}}
              {{- semaphore_target_version -}}
              {{- '/' -}}

        - name: Set download filename
          ansible.builtin.set_fact:
            semaphore_filename: >-
              semaphore_{{ semaphore_target_version }}_linux_amd64.tar.gz

        - name: Set download URL
          ansible.builtin.set_fact:
            semaphore_download_url: >-
              {{ semaphore_base_url }}{{ semaphore_filename }}

        - name: Download Semaphore binary
          ansible.builtin.get_url:
            url: "{{ semaphore_download_url }}"
            dest: /tmp/semaphore.tar.gz
            mode: '0644'

        - name: Cleanup any existing extracted files
          ansible.builtin.file:
            path: /tmp/semaphore_extract
            state: absent

        - name: Create extraction directory
          ansible.builtin.file:
            path: /tmp/semaphore_extract
            state: directory
            mode: '0755'

        - name: Extract Semaphore binary
          ansible.builtin.unarchive:
            src: /tmp/semaphore.tar.gz
            dest: /tmp/semaphore_extract
            remote_src: true

        - name: Find Semaphore binary in extracted files
          ansible.builtin.find:
            paths: /tmp/semaphore_extract
            patterns: semaphore
            file_type: file
            recurse: true
          register: semaphore_binary_file

        - name: Fail if binary not found
          ansible.builtin.fail:
            msg: "Semaphore binary not found in extracted archive"
          when: semaphore_binary_file.files | length == 0

        - name: Check if semaphore path exists and is a directory
          ansible.builtin.stat:
            path: "{{ semaphore_install_dir }}/semaphore"
          register: semaphore_path_stat

        - name: Remove existing semaphore directory if present
          ansible.builtin.file:
            path: "{{ semaphore_install_dir }}/semaphore"
            state: absent
          when: >-
            semaphore_path_stat.stat.exists and
            semaphore_path_stat.stat.isdir

        - name: Install Semaphore binary
          ansible.builtin.copy:
            src: "{{ semaphore_binary_file.files[0].path }}"
            dest: "{{ semaphore_install_dir }}/semaphore"
            owner: root
            group: root
            mode: '0755'
            remote_src: true

        - name: Cleanup download files
          ansible.builtin.file:
            path: "{{ item }}"
            state: absent
          loop:
            - /tmp/semaphore.tar.gz
            - /tmp/semaphore_extract

    - name: Verify installation
      ansible.builtin.shell: |
        set -o pipefail
        {{ semaphore_install_dir }}/semaphore version |
        grep -oP '^[0-9]+\.[0-9]+\.[0-9]+'
      args:
        executable: /bin/bash
      register: semaphore_new_version
      changed_when: false

    - name: Display installed version
      ansible.builtin.debug:
        msg: >-
          Semaphore version {{ semaphore_new_version.stdout }}
          is now installed

    - name: Restart Semaphore service if running
      ansible.builtin.systemd:
        name: semaphore
        state: restarted
      when:
        - update_needed | bool
        - ansible_facts.services['semaphore.service'] is defined
        - ansible_facts.services['semaphore.service'].state == 'running'
      failed_when: false
