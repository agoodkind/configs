---
- name: Deploy PowerDNS Secondary Server
  hosts: powerdns_servers
  become: true
  vars:
    postgres_db: powerdns
    postgres_user: pdns
    bind_primary_ip: 3d06:bad:b01::6
    tsig_key_name: powerdns-xfr
    tsig_algorithm: hmac-sha256
    zone_name: home.goodkind.io

  tasks:
    - name: Check for environment variables from Semaphore
      set_fact:
        env_pdns_postgres_password: "{{ lookup('env', 'PDNS_POSTGRES_PASSWORD', default='') }}"
        env_pdns_api_key: "{{ lookup('env', 'PDNS_API_KEY', default='') }}"
        env_pdns_tsig_secret: "{{ lookup('env', 'PDNS_TSIG_SECRET', default='') }}"

    - name: Generate secrets if not provided via environment variables
      set_fact:
        generated_postgres_password: "{{ lookup('password', '/dev/null length=32 chars=ascii_letters,digits') }}"
        generated_pdns_api_key: "{{ lookup('password', '/dev/null length=32 chars=ascii_letters,digits') }}"
        generated_tsig_secret: "{{ lookup('password', '/dev/null length=44 chars=ascii_letters,digits,+,/=') }}"
      when: >
        env_pdns_postgres_password == '' or
        env_pdns_api_key == '' or
        env_pdns_tsig_secret == ''

    - name: Set final secret values (use env vars if available, otherwise generated)
      set_fact:
        postgres_password: "{{ env_pdns_postgres_password | default(generated_postgres_password | default('changeme')) }}"
        pdns_api_key: "{{ env_pdns_api_key | default(generated_pdns_api_key | default('')) }}"
        tsig_secret: "{{ env_pdns_tsig_secret | default(generated_tsig_secret | default('')) }}"
        secrets_were_generated: "{{ env_pdns_postgres_password == '' or env_pdns_api_key == '' or env_pdns_tsig_secret == '' }}"

    - name: Write generated secrets to secure file (not logged)
      copy:
        content: |
          # Generated PowerDNS secrets - Add these to Semaphore Environment Variables
          # Generated at: {{ ansible_date_time.iso8601 | default('unknown') }}
          # 
          # IMPORTANT: Add these to Semaphore before the next playbook run:
          # 1. Go to Environments → Select your environment
          # 2. Add these as Environment Variables
          # 3. Save and re-run this playbook
          #
          PDNS_POSTGRES_PASSWORD={{ postgres_password }}
          PDNS_API_KEY={{ pdns_api_key }}
          PDNS_TSIG_SECRET={{ tsig_secret }}
        dest: "/tmp/pdns-secrets.txt"
        owner: "{{ ansible_ssh_user | default('root') }}"
        mode: '0600'
      no_log: true
      when: secrets_were_generated | default(false)
      delegate_to: localhost
      run_once: true

    - name: Notify about generated secrets file location
      debug:
        msg:
          - "⚠️  Secrets were generated and written to a secure file"
          - "File location: /tmp/pdns-secrets.txt (on control machine)"
          - "Permissions: 0600 (readable only by owner)"
          - ""
          - "To view secrets: cat /tmp/pdns-secrets.txt"
          - ""
          - "After adding secrets to Semaphore, delete the file for security."
      when: secrets_were_generated | default(false)

    - name: Confirm using existing environment variables
      debug:
        msg:
          - "✓ Using secrets from Semaphore environment variables"
          - "All required environment variables are set: PDNS_POSTGRES_PASSWORD, PDNS_API_KEY, PDNS_TSIG_SECRET"
      when: not (secrets_were_generated | default(false))
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install PostgreSQL
      apt:
        name:
          - postgresql
          - postgresql-contrib
          - python3-psycopg2
        state: present

    - name: Ensure PostgreSQL is started and enabled
      systemd:
        name: postgresql
        state: started
        enabled: yes

    - name: Create PowerDNS database
      become_user: postgres
      community.postgresql.postgresql_db:
        name: "{{ postgres_db }}"
        encoding: UTF-8
        state: present

    - name: Create PowerDNS database user
      become_user: postgres
      community.postgresql.postgresql_user:
        name: "{{ postgres_user }}"
        password: "{{ postgres_password }}"
        state: present

    - name: Grant privileges to PowerDNS user
      become_user: postgres
      community.postgresql.postgresql_query:
        db: "{{ postgres_db }}"
        query: "GRANT ALL PRIVILEGES ON DATABASE {{ postgres_db }} TO {{ postgres_user }}; GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO {{ postgres_user }}; GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO {{ postgres_user }};"

    - name: Install PowerDNS packages
      apt:
        name:
          - pdns-server
          - pdns-backend-pgsql
        state: present

    - name: Stop PowerDNS if running (initial setup)
      systemd:
        name: pdns
        state: stopped
      ignore_errors: yes

    - name: Check if PowerDNS schema is initialized
      become_user: postgres
      community.postgresql.postgresql_query:
        db: "{{ postgres_db }}"
        query: "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema='public' AND table_name='domains'"
      register: schema_check
      ignore_errors: yes

    - name: Download PowerDNS PostgreSQL schema
      get_url:
        url: https://raw.githubusercontent.com/PowerDNS/pdns/master/modules/gpgsqlbackend/schema.pgsql.sql
        dest: /tmp/pdns-schema.sql
        mode: '0644'
      when: schema_check.query_result is not defined or schema_check.query_result[0].count == 0

    - name: Initialize PowerDNS database schema
      become_user: postgres
      shell: psql -d {{ postgres_db }} -f /tmp/pdns-schema.sql
      when: schema_check.query_result is not defined or schema_check.query_result[0].count == 0

    - name: Configure PowerDNS
      template:
        src: ../templates/pdns.conf.j2
        dest: /etc/powerdns/pdns.conf
        owner: root
        group: pdns
        mode: '0640'
      notify: restart pdns

    - name: Create PowerDNS TSIG key directory
      file:
        path: /etc/powerdns/tsig
        state: directory
        owner: pdns
        group: pdns
        mode: '0750'

    - name: Store TSIG key for reference
      copy:
        content: |
          # TSIG Key for zone transfers from BIND9
          # Key name: {{ tsig_key_name }}
          # Algorithm: {{ tsig_algorithm }}
          # Secret: {{ tsig_secret }}
        dest: /etc/powerdns/tsig/{{ tsig_key_name }}.info
        owner: pdns
        group: pdns
        mode: '0640'

    - name: Check if zone already exists
      become_user: postgres
      community.postgresql.postgresql_query:
        db: "{{ postgres_db }}"
        query: "SELECT COUNT(*) FROM domains WHERE name='{{ zone_name }}'"
      register: zone_exists

    - name: Add slave zone to PowerDNS
      become_user: postgres
      community.postgresql.postgresql_query:
        db: "{{ postgres_db }}"
        query: |
          INSERT INTO domains (name, master, type, account)
          VALUES ('{{ zone_name }}', '{{ bind_primary_ip }}', 'SLAVE', 'BIND9 Primary');
      when: zone_exists.query_result[0].count == 0

    - name: Check if TSIG key exists in database
      become_user: postgres
      community.postgresql.postgresql_query:
        db: "{{ postgres_db }}"
        query: "SELECT COUNT(*) FROM tsigkeys WHERE name='{{ tsig_key_name }}'"
      register: tsig_exists

    - name: Add TSIG key to PowerDNS database
      become_user: postgres
      community.postgresql.postgresql_query:
        db: "{{ postgres_db }}"
        query: |
          INSERT INTO tsigkeys (name, algorithm, secret)
          VALUES ('{{ tsig_key_name }}', '{{ tsig_algorithm }}', '{{ tsig_secret }}');
      when: tsig_exists.query_result[0].count == 0

    - name: Link TSIG key to domain
      become_user: postgres
      community.postgresql.postgresql_query:
        db: "{{ postgres_db }}"
        query: |
          UPDATE domains SET master='{{ bind_primary_ip }}' WHERE name='{{ zone_name }}';
      when: zone_exists.query_result[0].count > 0

    - name: Enable and start PowerDNS
      systemd:
        name: pdns
        state: started
        enabled: yes

    - name: Wait for PowerDNS to be ready
      wait_for:
        port: 53
        delay: 2
        timeout: 30

    - name: Display TSIG key for BIND9 configuration
      debug:
        msg:
          - "================================================================================"
          - "✅ PowerDNS Secondary Server Configuration Complete"
          - "================================================================================"
          - ""
          - "Zone: {{ zone_name }}"
          - "BIND9 Primary: {{ bind_primary_ip }}"
          - ""
          - "TSIG key configuration (already applied by second playbook):"
          - "  Key name: {{ tsig_key_name }}"
          - "  Algorithm: {{ tsig_algorithm }}"
          - ""
          - "================================================================================"

  handlers:
    - name: restart pdns
      systemd:
        name: pdns
        state: restarted

- name: Configure BIND9 to allow zone transfers
  hosts: localhost
  gather_facts: false
  vars:
    bind_server: ns.home.goodkind.io
    tsig_key_name: powerdns-xfr
    tsig_algorithm: hmac-sha256
    powerdns_ip: 10.250.0.11
    zone_name: home.goodkind.io

  tasks:
    - name: Get TSIG secret from environment or first play facts
      set_fact:
        tsig_secret: "{{ lookup('env', 'PDNS_TSIG_SECRET', default='') | default(hostvars[groups['powerdns_servers'][0]]['tsig_secret'] | default('')) }}"

    - name: Validate TSIG secret is available
      fail:
        msg: "TSIG secret is not set. Ensure PDNS_TSIG_SECRET environment variable is set in Semaphore, or check that the first play completed successfully."
      when: tsig_secret == ''

    - name: Create TSIG key file on BIND9 server
      delegate_to: "{{ bind_server }}"
      copy:
        content: |
          key "{{ tsig_key_name }}" {
              algorithm {{ tsig_algorithm }};
              secret "{{ tsig_secret }}";
          };
        dest: /etc/bind/keys/{{ tsig_key_name }}.key
        owner: root
        group: bind
        mode: '0640'

    - name: Backup current zone configuration
      delegate_to: "{{ bind_server }}"
      copy:
        src: /etc/bind/zones/goodkind.io/zone.{{ zone_name }}.dynamic-signed
        dest: /etc/bind/zones/goodkind.io/zone.{{ zone_name }}.dynamic-signed.backup-{{ ansible_date_time.epoch }}
        remote_src: yes

    - name: Update zone configuration to allow transfers
      delegate_to: "{{ bind_server }}"
      blockinfile:
        path: /etc/bind/zones/goodkind.io/zone.{{ zone_name }}.dynamic-signed
        marker: "    # {mark} ANSIBLE MANAGED - PowerDNS zone transfer"
        insertafter: "^zone \"{{ zone_name }}\""
        block: |2
              allow-transfer { key {{ tsig_key_name }}; };
              also-notify { {{ powerdns_ip }}; };

    - name: Include TSIG key in named.conf.local
      delegate_to: "{{ bind_server }}"
      lineinfile:
        path: /etc/bind/named.conf.local
        line: 'include "/etc/bind/keys/{{ tsig_key_name }}.key";'
        insertafter: '^include "/etc/bind/keys/'
        state: present

    - name: Check BIND9 configuration
      delegate_to: "{{ bind_server }}"
      command: named-checkconf
      register: checkconf
      changed_when: false

    - name: Reload BIND9
      delegate_to: "{{ bind_server }}"
      systemd:
        name: named
        state: reloaded
      when: checkconf.rc == 0

# TODO ansible_host is a confusing name, should it be powerdns_ip?
# TODO should we use the powerdns_ipv6?
    - name: Trigger zone transfer from PowerDNS
      delegate_to: "{{ hostvars[groups['powerdns_servers'][0]]['ansible_host'] }}"
      command: pdns_control retrieve {{ zone_name }}
      register: zone_transfer
      changed_when: "'Retrieved zone' in zone_transfer.stdout"

    - name: Display zone transfer result
      debug:
        msg: "{{ zone_transfer.stdout_lines }}"

    - name: Test DNS resolution from PowerDNS
      delegate_to: "{{ hostvars[groups['powerdns_servers'][0]]['ansible_host'] }}"
      command: dig @localhost {{ zone_name }} SOA +short
      register: dns_test
      changed_when: false

    - name: Display DNS test result
      debug:
        msg:
          - "DNS Resolution Test:"
          - "{{ dns_test.stdout_lines }}"
          - ""
          - "Next steps:"
          - "1. Add NS record for pdns.{{ zone_name }}"
          - "2. Add A record: pdns.{{ zone_name }} -> {{ powerdns_ip }}"
          - "3. Update DHCP to include {{ powerdns_ip }} in DNS servers"

