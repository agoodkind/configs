---
# Reusable playbook wrapper for service containers
# Simplified to call create-ct.yml directly
#
# Required variables:
#   container_group: Inventory group name (e.g., adguard_servers)
#   group_vars_file: Path to group_vars file (relative to playbook_dir)
#   hostname_var: Variable name in group_vars containing the hostname
#     (e.g., adguard_hostname)
#
# Optional variables:
#   target_node: Proxmox node (default: vault)
#   container_vmid: Specific VMID to use (default: "")
#   disk_size: Container disk size in GB (default: "8")
#   memory: Container memory in MB (default: "2048")
#   cores: Container CPU cores (default: "2")
#   mac_var: Variable name in group_vars containing a stable MAC address
#     (e.g., traefik_mac_address). Used to keep DHCP reservations stable
#     across container recreation.
#   container_tags: Container tags
#     (default: "lxc,{{ container_group | replace('_servers', '') }}")
- name: Load service configuration and create/setup container
  hosts: localhost
  gather_facts: false
  vars:
    target_node: vault
    container_vmid: ""
    disk_size: "8"
    memory: "2048"
    cores: "2"
    container_tags: >-
      lxc,{{ container_group | replace('_servers', '') }}
  vars_files:
    - "{{ group_vars_file }}"
  tasks:
    - name: Validate required variables
      ansible.builtin.assert:
        that:
          - container_group is defined
          - group_vars_file is defined
          - hostname_var is defined
        fail_msg: >-
          container_group, group_vars_file, and hostname_var must be
          provided when importing setup-service-container.yml

    - name: Get container hostname from group_vars
      ansible.builtin.set_fact:
        service_hostname: "{{ lookup('vars', hostname_var) }}"

    - name: Get container MAC address from group_vars (optional)
      ansible.builtin.set_fact:
        service_mac_address: "{{ lookup('vars', mac_var) }}"
      when:
        - mac_var is defined
        - mac_var | string | trim | length > 0

- name: Create or ensure container exists
  ansible.builtin.import_playbook: create-ct.yml
  vars:
    container_hostname: "{{ hostvars['localhost']['service_hostname'] }}"
    target_node: "{{ hostvars['localhost']['target_node'] | default('vault') }}"
    vmid: "{{ hostvars['localhost']['container_vmid'] | default('') }}"
    disk_size: "{{ hostvars['localhost']['disk_size'] | default('8') }}"
    memory: "{{ hostvars['localhost']['memory'] | default('2048') }}"
    cores: "{{ hostvars['localhost']['cores'] | default('2') }}"
    container_tags: "{{ hostvars['localhost']['container_tags'] }}"
    mac_address: "{{ hostvars['localhost']['service_mac_address'] | default('') }}"

- name: Add container to service group
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Ensure container primary IP is available
      ansible.builtin.assert:
        that:
          - hostvars['localhost']['container_primary_ip'] is defined
          - (hostvars['localhost']['container_primary_ip'] | default('') | trim) | length > 0
        fail_msg: >-
          container_primary_ip was not discovered for {{ hostvars['localhost']['service_hostname'] }}.

    - name: Add container to service-specific inventory group
      ansible.builtin.add_host:
        name: "{{ hostvars['localhost']['service_hostname'] }}"
        groups: "{{ container_group }}"
        ansible_host: "{{ hostvars['localhost']['container_primary_ip'] }}"
        ansible_user: root
        ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
        ansible_proxmox_vmid: >-
          {{ hostvars[hostvars['localhost']['service_hostname']].ansible_proxmox_vmid | default('') }}
        ansible_proxmox_host: >-
          {{ hostvars[hostvars['localhost']['service_hostname']].ansible_proxmox_host | default('vault') }}
