---
- name: Ensure targeted CT/VM is running
  hosts: localhost
  gather_facts: false

  vars:
    # Keep targeting logic in sync with the main play below.
    effective_target: >-
      {{
        (target_hosts | default('') | trim)
        if (target_hosts | default('') | trim) | length > 0
        else (
          (hostname | default('') | trim)
          if (hostname | default('') | trim) | length > 0
          else 'proxmox_all_lxc'
        )
      }}
    selected_hosts: >-
      {{
        groups[effective_target]
        if effective_target in groups
        else [effective_target]
      }}

  tasks:
    - name: Build Proxmox start target list
      ansible.builtin.set_fact:
        guest_start_targets: >-
          {{
            (guest_start_targets | default([])) + [
              {
                'name': item,
                'proxmox_host': (hostvars[item].ansible_proxmox_host | default('') | trim),
                'vmid': (hostvars[item].ansible_proxmox_vmid | default('') | string | trim)
              }
            ]
          }}
      loop: "{{ selected_hosts }}"
      loop_control:
        label: "{{ item }}"
      when:
        - item in hostvars
        - (hostvars[item].ansible_proxmox_host | default('') | trim) | length > 0
        - (hostvars[item].ansible_proxmox_vmid | default('') | string | trim) | length > 0

    - name: Ensure LXC guest is running on Proxmox (API best-effort)
      loop: "{{ guest_start_targets | default([]) }}"
      loop_control:
        label: "{{ item.name }} ({{ item.vmid }} on {{ item.proxmox_host }})"
      ansible.builtin.uri:
        url: >-
          https://{{ proxmox_api_host }}:8006/api2/json/nodes/{{ item.proxmox_host -}}/lxc/{{-
          item.vmid }}/status/start
        method: POST
        headers:
          Authorization: >-
            PVEAPIToken={{ proxmox_api_user }}!{{ proxmox_token_id }}={{-
            proxmox_token_secret }}
        validate_certs: false
        return_content: true
        # 404: not an LXC on this node/vmid
        # 500: already running / not startable
        status_code: [200, 401, 403, 404, 500]
      delegate_to: localhost
      register: guest_start_lxc
      changed_when: false
      failed_when: false

    - name: Ensure QEMU guest is running on Proxmox (API best-effort)
      loop: "{{ guest_start_targets | default([]) }}"
      loop_control:
        label: "{{ item.name }} ({{ item.vmid }} on {{ item.proxmox_host }})"
      ansible.builtin.uri:
        url: >-
          https://{{ proxmox_api_host }}:8006/api2/json/nodes/{{ item.proxmox_host -}}/qemu/{{-
          item.vmid }}/status/start
        method: POST
        headers:
          Authorization: >-
            PVEAPIToken={{ proxmox_api_user }}!{{ proxmox_token_id }}={{-
            proxmox_token_secret }}
        validate_certs: false
        return_content: true
        # 404: not a VM on this node/vmid
        # 500: already running / not startable
        status_code: [200, 401, 403, 404, 500]
      delegate_to: localhost
      register: guest_start_qemu
      changed_when: false
      failed_when: false

    - name: Probe SSH on VMID IPv6
      ansible.builtin.wait_for:
        host: "3d06:bad:b01::{{ item.vmid | string | trim }}"
        port: 22
        timeout: 2
        state: started
      loop: "{{ guest_start_targets | default([]) }}"
      loop_control:
        label: "{{ item.name }} -> 3d06:bad:b01::{{ item.vmid | string | trim }}"
      register: ssh_probe_v6
      changed_when: false
      failed_when: false

    - name: Probe SSH on VMID IPv4
      ansible.builtin.wait_for:
        host: "10.250.0.{{ item.vmid | string | trim }}"
        port: 22
        timeout: 2
        state: started
      loop: "{{ guest_start_targets | default([]) }}"
      loop_control:
        label: "{{ item.name }} -> 10.250.0.{{ item.vmid | string | trim }}"
      register: ssh_probe_v4
      changed_when: false
      failed_when: false

    - name: Add VMID-derived targets to in-memory inventory
      ansible.builtin.add_host:
        name: "{{ item.name }}"
        groups: proxmox_api_targets
        ansible_host: "{{ ansible_host_final }}"
        ansible_user: root
        ansible_ssh_common_args: '-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'
        ansible_proxmox_vmid: "{{ item.vmid }}"
        ansible_proxmox_host: "{{ item.proxmox_host }}"
        prep_ct_target_group: "{{ effective_target }}"
        prep_ct_service: >-
          {{
            (
              effective_target
              | regex_replace('_servers$','')
              | trim
            )
            if (effective_target | default('') | trim) | length > 0
            else ''
          }}
      vars:
        vmid_ip_v6: "3d06:bad:b01::{{ item.vmid | string | trim }}"
        vmid_ip_v4: "10.250.0.{{ item.vmid | string | trim }}"
        inv_host_override: >-
          {{
            (hostvars[item.name].ansible_host | default('') | trim)
            if (
              item.name in hostvars
              and (hostvars[item.name].ansible_host | default('') | trim) | length > 0
            )
            else ''
          }}
        ansible_host_final: >-
          {{
            inv_host_override
            if (inv_host_override | default('') | trim) | length > 0
            else (
              vmid_ip_v6
              if not (ssh_probe_v6.results[idx].failed | default(true))
              else (
                vmid_ip_v4
                if not (ssh_probe_v4.results[idx].failed | default(true))
                else vmid_ip_v6
              )
            )
          }}
      loop: "{{ guest_start_targets | default([]) }}"
      loop_control:
        index_var: idx
        label: "{{ item.name }} -> {{ ansible_host_final | default('') | trim }}"
      when:
        - item is defined
        - (ansible_host_final | default('') | trim) | length > 0

- name: Prepare CT/VM guests (common)
  ansible.builtin.import_playbook: prep-host-common.yml
  vars:
    target_hosts: proxmox_api_targets
