---
- name: Update Semaphore
  hosts: ansible_server
  become: true

  vars:
    semaphore_version: "latest"
    semaphore_user: semaphore
    semaphore_group: semaphore
    semaphore_install_dir: /usr/bin
    semaphore_config_dir: /etc/semaphore
    semaphore_data_dir: /var/lib/semaphore

  tasks:
    - name: Check if Semaphore is installed
      ansible.builtin.stat:
        path: "{{ semaphore_install_dir }}/semaphore"
      register: semaphore_binary

    - name: Get installed Semaphore version
      ansible.builtin.shell:
        cmd: |
          set -o pipefail
          {{ semaphore_install_dir }}/semaphore version | grep -oP '^[0-9]+\.[0-9]+\.[0-9]+'
        executable: /bin/bash
      register: semaphore_installed_version
      when: semaphore_binary.stat.exists
      changed_when: false
      failed_when: false

    - name: Display current version
      ansible.builtin.debug:
        msg: "Current Semaphore version: {{ semaphore_installed_version.stdout | default('Not installed') }}"

    - name: Get latest release version from GitHub API
      ansible.builtin.uri:
        url: https://api.github.com/repos/semaphoreui/semaphore/releases/latest
        return_content: true
      register: github_release
      when: semaphore_version == 'latest'

    - name: Set target version fact
      ansible.builtin.set_fact:
        semaphore_target_version: >-
          {% if semaphore_version == 'latest' and github_release is defined %}
          {{ github_release.json.tag_name | regex_replace('^v', '') }}
          {% else %}
          {{ semaphore_version }}
          {% endif %}

    - name: Check if update is needed
      ansible.builtin.set_fact:
        update_needed: >-
          {{ not semaphore_binary.stat.exists or
             (semaphore_installed_version.stdout is not defined) or
             (semaphore_target_version != semaphore_installed_version.stdout) }}

    - name: Display update status
      ansible.builtin.debug:
        msg: >-
          {% if update_needed %}
          Updating Semaphore from {{ semaphore_installed_version.stdout | default('Not installed') }}
          to {{ semaphore_target_version }}
          {% else %}
          Semaphore is already at version {{ semaphore_installed_version.stdout }}
          (target: {{ semaphore_target_version }})
          {% endif %}

    - name: Download and install Semaphore
      when: update_needed | bool
      block:

        - name: Set download base URL
          ansible.builtin.set_fact:
            semaphore_base_url: >-
              https://github.com/semaphoreui/semaphore/releases/download/v{{ semaphore_target_version }}/

        - name: Set download filename
          ansible.builtin.set_fact:
            semaphore_filename: >-
              semaphore_{{ semaphore_target_version }}_linux_amd64.tar.gz

        - name: Set download URL
          ansible.builtin.set_fact:
            semaphore_download_url: "{{ semaphore_base_url }}{{ semaphore_filename }}"

        - name: Download Semaphore binary
          ansible.builtin.get_url:
            url: "{{ semaphore_download_url }}"
            dest: /tmp/semaphore.tar.gz
            mode: '0644'

        - name: Cleanup any existing extracted files
          ansible.builtin.file:
            path: /tmp/semaphore_extract
            state: absent

        - name: Create extraction directory
          ansible.builtin.file:
            path: /tmp/semaphore_extract
            state: directory
            mode: '0755'

        - name: Extract Semaphore binary
          ansible.builtin.unarchive:
            src: /tmp/semaphore.tar.gz
            dest: /tmp/semaphore_extract
            remote_src: true

        - name: Find Semaphore binary in extracted files
          ansible.builtin.find:
            paths: /tmp/semaphore_extract
            patterns: semaphore
            file_type: file
            recurse: true
          register: semaphore_binary_file

        - name: Fail if binary not found
          ansible.builtin.fail:
            msg: "Semaphore binary not found in extracted archive"
          when: semaphore_binary_file.files | length == 0

        - name: Check if semaphore path exists and is a directory
          ansible.builtin.stat:
            path: "{{ semaphore_install_dir }}/semaphore"
          register: semaphore_path_stat

        - name: Remove existing semaphore directory if present
          ansible.builtin.file:
            path: "{{ semaphore_install_dir }}/semaphore"
            state: absent
          when: semaphore_path_stat.stat.exists and semaphore_path_stat.stat.isdir

        - name: Install Semaphore binary
          ansible.builtin.copy:
            src: "{{ semaphore_binary_file.files[0].path }}"
            dest: "{{ semaphore_install_dir }}/semaphore"
            owner: root
            group: root
            mode: '0755'
            remote_src: true

        - name: Cleanup download files
          ansible.builtin.file:
            path: "{{ item }}"
            state: absent
          loop:
            - /tmp/semaphore.tar.gz
            - /tmp/semaphore_extract

    - name: Verify installation
      ansible.builtin.shell: |
        set -o pipefail
        {{ semaphore_install_dir }}/semaphore version | grep -oP '^[0-9]+\.[0-9]+\.[0-9]+'
      args:
        executable: /bin/bash
      register: semaphore_new_version
      changed_when: false

    - name: Display installed version
      ansible.builtin.debug:
        msg: "Semaphore version {{ semaphore_new_version.stdout }} is now installed"

    - name: Reload systemd daemon
      ansible.builtin.systemd:
        daemon_reload: true

    - name: Restart Semaphore service
      ansible.builtin.systemd:
        name: semaphore
        state: restarted

    - name: Ensure Semaphore service is enabled
      ansible.builtin.systemd:
        name: semaphore
        enabled: true

    - name: Verify Semaphore service is running
      ansible.builtin.systemd:
        name: semaphore
        state: started
