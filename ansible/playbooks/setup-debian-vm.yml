---
# Reusable playbook for setting up a Debian 13 VM with cloud-init
#
# Required variables (for VM creation):
#   hostname: VM hostname (e.g., mwan.home.goodkind.io)
#
# Optional variables:
#   proxmox_host: Proxmox node (default: vault)
#   vmid: Specific VMID (default: auto-assign)
#   disk_size: Disk size in GB (default: "8")
#   memory: Memory in MB (default: "1024")
#   cores: CPU cores (default: "1")
#   vm_tags: VM tags (default: "vm,debian")
#   network_interfaces: List of bridge names (default: ["vmbr0"])
#   hostpci_devices: List of PCI devices to pass through (default: [])
#   mgmt_ip_config: Cloud-init IP config (default: "ip=dhcp,ip6=auto")
#   dns_domain: DNS search domain
#   dns_servers: DNS server IPs
#
- name: Setup Debian cloud image template
  hosts: localhost
  gather_facts: false

  vars:
    proxmox_host: vault
    template_vmid: 9000
    debian_cloud_image: "debian-13-generic-amd64.qcow2"
    debian_cloud_url: >-
      https://cloud.debian.org/images/cloud/trixie/latest/debian-13-generic-amd64.qcow2
    storage: "local-lvm"
    template_bridge: "vmbr0"
    recreate_template: true  # Set to true to force template recreation

  tasks:
    - name: Check if Debian cloud image exists on Proxmox
      ansible.builtin.stat:
        path: "/var/lib/vz/template/qemu/{{ debian_cloud_image }}"
      delegate_to: "{{ proxmox_host }}"
      register: image_check

    - name: Create template directory if missing
      ansible.builtin.file:
        path: /var/lib/vz/template/qemu
        state: directory
        mode: '0755'
      delegate_to: "{{ proxmox_host }}"
      when: not image_check.stat.exists

    - name: Download Debian cloud image
      ansible.builtin.get_url:
        url: "{{ debian_cloud_url }}"
        dest: "/var/lib/vz/template/qemu/{{ debian_cloud_image }}"
        mode: '0644'
      delegate_to: "{{ proxmox_host }}"
      when: not image_check.stat.exists

    - name: Check if template VM exists
      ansible.builtin.command: qm status {{ template_vmid }}
      delegate_to: "{{ proxmox_host }}"
      register: template_check
      failed_when: false
      changed_when: false

    - name: Destroy existing template if recreate_template is true
      ansible.builtin.command: qm destroy {{ template_vmid }} --purge
      delegate_to: "{{ proxmox_host }}"
      when:
        - recreate_template | default(false) | bool
        - template_check.rc == 0
      changed_when: true

    - name: Create Debian cloud-init template
      when: (template_check.rc != 0) or (recreate_template | default(false) | bool)
      delegate_to: "{{ proxmox_host }}"
      block:
        - name: Create template VM
          ansible.builtin.command: >
            qm create {{ template_vmid }}
            --name debian-13-cloud-template
            --machine q35
            --bios ovmf
            --memory 512
            --cores 1
            --net0 virtio,bridge={{ template_bridge }}
            --scsihw virtio-scsi-pci
            --serial0 socket
            --vga virtio
            --ostype l26
            --agent enabled=1
          changed_when: true

        - name: Import cloud image as disk
          ansible.builtin.command: >
            qm importdisk {{ template_vmid }}
            /var/lib/vz/template/qemu/{{ debian_cloud_image }}
            {{ storage }}
          changed_when: true

        - name: Attach imported disk
          ansible.builtin.command: >
            qm set {{ template_vmid }}
            --scsi0 {{ storage }}:vm-{{ template_vmid }}-disk-0
          changed_when: true

        - name: Add EFI disk
          ansible.builtin.command: >
            qm set {{ template_vmid }}
            --efidisk0 {{ storage }}:1,efitype=4m,pre-enrolled-keys=1
          changed_when: true

        - name: Add cloud-init drive
          ansible.builtin.command: >
            qm set {{ template_vmid }}
            --ide2 {{ storage }}:cloudinit
          changed_when: true

        - name: Set boot order
          ansible.builtin.command: >
            qm set {{ template_vmid }}
            --boot order=scsi0
          changed_when: true

        - name: Convert to template
          ansible.builtin.command: qm template {{ template_vmid }}
          changed_when: true

    - name: Set template facts
      ansible.builtin.set_fact:
        debian_template_vmid: "{{ template_vmid }}"

- name: Create Debian VM from template
  hosts: localhost
  gather_facts: false

  vars:
    # Repository root for template paths
    repo_root: "{{ playbook_dir | dirname | dirname }}"
    # Proxmox configuration
    proxmox_host: vault
    template_vmid: 9000
    template_storage: "storage"
    template_bridge: "vmbr0"

    # VM specifications (defaults - caller overrides)
    vmid: ""
    disk_size: "8"
    memory: "1024"
    cores: "1"
    storage: "local-lvm"
    vm_tags: "vm,debian"

    # Network (caller should override)
    network_interfaces: ["vmbr0"]
    hostpci_devices: []

    # Cloud-init & Network config
    mgmt_ip_config: "ip=dhcp,ip6=dhcp"
    vm_mgmt_iface: "enmgmt0"
    vm_mgmt_ipv4_prefix: "24"
    vm_mgmt_ipv6_prefix: "64"
    vm_mgmt_gateway_ipv4: "10.250.0.1"
    vm_mgmt_gateway_ipv6: "3d06:bad:b01::1"
    vm_mgmt_dns_servers: "3d06:bad:b01::6 10.250.0.6"
    vm_mgmt_dns_domain: "home.goodkind.io"

    # Serial console & guest agent
    enable_serial: true
    enable_qemu_agent: true

    # Temporary password (can be overridden via -e)
    # ciuser is always root
    temp_password: ""  # If empty, will be auto-generated

    # SSH keys fetched at runtime from GitHub

  tasks:
    - name: Generate hostname if not provided
      ansible.builtin.command: date +%Y%m%d-%H%M%S
      register: generated_hostname_suffix
      changed_when: false
      when: hostname is not defined

    - name: Set generated hostname
      ansible.builtin.set_fact:
        hostname: "{{ generated_hostname_suffix.stdout }}.home.goodkind.io"
      when: hostname is not defined

    - name: Debug - show generated hostname
      ansible.builtin.debug:
        msg: "Auto-generated hostname: {{ hostname }}"
      when: generated_hostname_suffix is defined

    - name: Debug - show all extra vars
      ansible.builtin.debug:
        msg: >-
          hostname={{ hostname }},
          all vars={{ vars.keys() | list | sort }}

    - name: Check if VM already exists
      community.proxmox.proxmox_kvm:
        api_host: "{{ proxmox_api_host }}"
        api_user: "{{ proxmox_api_user }}"
        api_token_id: "{{ proxmox_token_id }}"
        api_token_secret: "{{ proxmox_token_secret }}"
        validate_certs: false
        node: "{{ proxmox_host }}"
        name: "{{ hostname }}"
        state: current
      delegate_to: ansible.home.goodkind.io
      register: vm_check
      failed_when: false

    # - name: Set facts if VM already exists
    #   ansible.builtin.set_fact:
    #     hostname_fact: "{{ hostname }}"
    #     vm_created_fact: false
    #     vm_vmid_fact: "{{ vm_check.vmid }}"
    #   when: vm_check.vmid is defined

    - name: Display VM status
      ansible.builtin.debug:
        msg: >-
          VM {{ hostname }}:
          {{ 'exists (VMID ' + (vm_check.vmid | string) + ')'
          if vm_check.vmid is defined else 'will be created' }}

    - name: Stop existing VM (temporary - for clean redeploy)
      ansible.builtin.command: qm stop {{ vm_check.vmid }}
      delegate_to: "{{ proxmox_host }}"
      when: vm_check.vmid is defined
      changed_when: true
      failed_when: false

    - name: Wait for VM to stop
      ansible.builtin.pause:
        seconds: 3
      when: vm_check.vmid is defined

    - name: Destroy existing VM (temporary - for clean redeploy)
      ansible.builtin.command: qm destroy {{ vm_check.vmid }} --purge
      delegate_to: "{{ proxmox_host }}"
      when: vm_check.vmid is defined
      changed_when: true

    - name: VM creation block
      # when: vm_check.vmid is not defined
      when: true
      block:
        - name: Get next available VMID
          ansible.builtin.command: pvesh get /cluster/nextid
          delegate_to: "{{ proxmox_host }}"
          register: next_vmid
          changed_when: false
          when: not vmid

        - name: Set VMID
          ansible.builtin.set_fact:
            new_vmid: "{{ vmid if vmid else next_vmid.stdout | trim }}"

        - name: Clone template to new VM
          ansible.builtin.command: >
            qm clone {{ template_vmid }} {{ new_vmid }}
            --name {{ hostname }}
            --full 1
            --target {{ proxmox_host }}
          delegate_to: "{{ proxmox_host }}"
          changed_when: true

        - name: Resize disk
          ansible.builtin.command: >
            qm resize {{ new_vmid }} scsi0 {{ disk_size }}G
          delegate_to: "{{ proxmox_host }}"
          changed_when: true

        - name: Configure VM resources
          ansible.builtin.command: >
            qm set {{ new_vmid }}
            --memory {{ memory }}
            --cores {{ cores }}
            --cpu host
            --onboot 1
            --tags {{ vm_tags }}
          delegate_to: "{{ proxmox_host }}"
          changed_when: true

        - name: Remove default network interface
          ansible.builtin.command: qm set {{ new_vmid }} --delete net0
          delegate_to: "{{ proxmox_host }}"
          changed_when: true

        - name: Add network interfaces
          ansible.builtin.command: >
            qm set {{ new_vmid }}
            --net{{ idx }} virtio,bridge={{ item }}
          delegate_to: "{{ proxmox_host }}"
          loop: "{{ network_interfaces }}"
          loop_control:
            index_var: idx
          changed_when: true

        - name: Get MAC address of net0 for .link file
          ansible.builtin.shell: >
            set -o pipefail &&
            qm config {{ new_vmid }} |
            grep '^net0:' |
            sed -n 's/.*virtio=\([^,]*\).*/\1/p'
          delegate_to: "{{ proxmox_host }}"
          register: net0_mac_result
          changed_when: false
          args:
            executable: /bin/bash

        - name: Set vm_mgmt_mac variable
          ansible.builtin.set_fact:
            vm_mgmt_mac: "{{ net0_mac_result.stdout | trim }}"

        - name: Add PCIe passthrough devices
          ansible.builtin.command: >
            qm set {{ new_vmid }}
            --hostpci{{ idx }} {{ item }}
          delegate_to: "{{ proxmox_host }}"
          loop: "{{ hostpci_devices | select() | list }}"
          loop_control:
            index_var: idx
          when: hostpci_devices | select() | list | length > 0
          changed_when: true

        - name: Fetch SSH keys from GitHub
          ansible.builtin.uri:
            url: "https://github.com/agoodkind.keys"
            return_content: true
          register: github_keys
          delegate_to: "{{ proxmox_host }}"
          failed_when: false

        - name: Debug SSH keys
          ansible.builtin.debug:
            msg: >-
              GitHub keys:
              {{ github_keys.content | default('FAILED TO FETCH') | length }}
              bytes

        - name: Calculate static IP addresses based on VMID
          ansible.builtin.set_fact:
            vm_static_ipv4: "10.250.0.{{ new_vmid }}"
            vm_static_ipv6: "3d06:bad:b01::{{ '%x' | format(new_vmid | int) }}"
            vm_mgmt_ipv4: "10.250.0.{{ new_vmid }}"
            vm_mgmt_ipv6: "3d06:bad:b01::{{ '%x' | format(new_vmid | int) }}"

        - name: Build ipconfig string (DRY composition)
          ansible.builtin.set_fact:
            vm_ipconfig_str: >-
              {{ 'ip=' + vm_static_ipv4 + '/24,gw=10.250.0.1,' +
                 'ip6=' + vm_static_ipv6 + '/64,gw6=3d06:bad:b01::1' }}

        - name: Generate temporary password if not provided
          ansible.builtin.shell: |
            set -o pipefail
            openssl rand -base64 12 | tr -d "=+/" | cut -c1-16
          register: temp_password_result
          changed_when: false
          args:
            executable: /bin/bash
          when: temp_password | default('') | length == 0

        - name: Set temporary password
          ansible.builtin.set_fact:
            temp_password: >-
              {{ temp_password
              if temp_password | default('') | length > 0
              else temp_password_result.stdout }}

        - name: Write SSH keys to temp file
          ansible.builtin.copy:
            content: "{{ github_keys.content | trim }}"
            dest: "/tmp/sshkeys_{{ new_vmid }}.pub"
            mode: '0644'
          delegate_to: "{{ proxmox_host }}"
          when: github_keys.content is defined and github_keys.content | trim | length > 0

        - name: Configure cloud-init with static IP and SSH keys
          ansible.builtin.command: >
            qm set {{ new_vmid }}
            --ciuser root
            --cipassword {{ temp_password }}
            --sshkeys /tmp/sshkeys_{{ new_vmid }}.pub
            --ipconfig0 "{{ vm_ipconfig_str }}"
            --searchdomain {{ vm_mgmt_dns_domain }}
            --nameserver '{{ vm_mgmt_dns_servers }}'
          delegate_to: "{{ proxmox_host }}"
          changed_when: true
          when: github_keys.content is defined and github_keys.content | trim | length > 0

        - name: Display temporary credentials
          ansible.builtin.debug:
            msg:
              - "ðŸ”‘ TEMPORARY CREDENTIALS (will be reset at end):"
              - "  Username: root"
              - "  Password: {{ temp_password }}"
              - "  VM: {{ hostname }}"
              - "  IPv4: {{ vm_static_ipv4 }}/24"
              - "  IPv6: {{ vm_static_ipv6 }}/64"
              - ""
              - "âš ï¸  Password will be randomly reset at the end of the playbook"

        - name: Clean up SSH keys temp file
          ansible.builtin.file:
            path: "/tmp/sshkeys_{{ new_vmid }}.pub"
            state: absent
          delegate_to: "{{ proxmox_host }}"
          failed_when: false

        - name: Regenerate cloud-init image
          ansible.builtin.command: qm cloudinit update {{ new_vmid }}
          delegate_to: "{{ proxmox_host }}"
          changed_when: true

        - name: Start VM
          community.proxmox.proxmox_kvm:
            api_host: "{{ proxmox_api_host }}"
            api_user: "{{ proxmox_api_user }}"
            api_token_id: "{{ proxmox_token_id }}"
            api_token_secret: "{{ proxmox_token_secret }}"
            validate_certs: false
            node: "{{ proxmox_host }}"
            vmid: "{{ new_vmid }}"
            state: started
          delegate_to: ansible.home.goodkind.io

        - name: Attempting SSH connection via IPv6
          ansible.builtin.debug:
            msg: "Waiting for VM to be reachable via SSH at {{ vm_static_ipv6 }}:22 (timeout: 120s)"

        - name: Wait for VM to be reachable via SSH (IPv6 first)
          ansible.builtin.wait_for:
            host: "{{ vm_static_ipv6 }}"
            port: 22
            timeout: 120
            state: started
            msg: "Waiting for SSH on {{ vm_static_ipv6 }}:22..."
          register: ssh_wait_v6
          failed_when: false

        - name: Attempting SSH connection via IPv4 (fallback)
          ansible.builtin.debug:
            msg: "IPv6 connection failed, trying IPv4 at {{ vm_static_ipv4 }}:22 (timeout: 30s)"
          when: ssh_wait_v6.failed | default(false)

        - name: Wait for VM to be reachable via SSH (IPv4 fallback)
          ansible.builtin.wait_for:
            host: "{{ vm_static_ipv4 }}"
            port: 22
            timeout: 30
            state: started
            msg: "Waiting for SSH on {{ vm_static_ipv4 }}:22..."
          register: ssh_wait_v4
          when: ssh_wait_v6.failed | default(false)
          failed_when: false

        - name: Set connection IP (IPv6 preferred, IPv4 fallback)
          ansible.builtin.set_fact:
            vm_ip_address: >-
              {{ vm_static_ipv6
              if not (ssh_wait_v6.failed | default(false))
              else vm_static_ipv4 }}

        - name: Wait for cloud-init to complete
          ansible.builtin.command: cloud-init status --wait
          delegate_to: "{{ vm_ip_address }}"
          vars:
            ansible_user: root
            ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
          when: >-
            (not (ssh_wait_v6.failed | default(true))
            or not (ssh_wait_v4.failed | default(true)))
          changed_when: false
          failed_when: false

        - name: Remove cloud-init generated networkd configs
          ansible.builtin.file:
            path: "{{ item }}"
            state: absent
          delegate_to: "{{ vm_ip_address }}"
          vars:
            ansible_user: root
            ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
          loop:
            - /etc/systemd/network/10-cloud-init-eth0.network
            - /etc/systemd/network/10-cloud-init-ens3.network
            - /run/systemd/network/10-netplan-eth0.network
            - /run/systemd/network/10-netplan-ens3.network
            - /etc/netplan/50-cloud-init.yaml
          when: >-
            (not (ssh_wait_v6.failed | default(true))
            or not (ssh_wait_v4.failed | default(true)))
          failed_when: false

        - name: Remove cloud-init network-config.json (all instances)
          ansible.builtin.shell: >
            rm -f /var/lib/cloud/instances/*/network-config.json
          delegate_to: "{{ vm_ip_address }}"
          vars:
            ansible_user: root
            ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
          when: >-
            (not (ssh_wait_v6.failed | default(true))
            or not (ssh_wait_v4.failed | default(true)))
          failed_when: false
          changed_when: false

        - name: Disable cloud-init network management
          ansible.builtin.lineinfile:
            path: /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg
            line: "network: {config: disabled}"
            create: true
            mode: '0644'
          delegate_to: "{{ vm_ip_address }}"
          vars:
            ansible_user: root
            ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
          when: >-
            (not (ssh_wait_v6.failed | default(true))
            or not (ssh_wait_v4.failed | default(true)))
          failed_when: false
          changed_when: false

        - name: Deploy systemd-networkd link file for consistent naming
          ansible.builtin.template:
            src: "{{ repo_root }}/ansible/templates/vm/10-mgmt.link.j2"
            dest: /etc/systemd/network/10-mgmt.link
            mode: '0644'
          delegate_to: "{{ vm_ip_address }}"
          vars:
            ansible_user: root
            ansible_ssh_common_args: '-o StrictHostKeyChecking=no'

        - name: Deploy systemd-networkd network file
          ansible.builtin.template:
            src: "{{ repo_root }}/ansible/templates/vm/10-mgmt.network.j2"
            dest: /etc/systemd/network/10-mgmt.network
            mode: '0644'
          delegate_to: "{{ vm_ip_address }}"
          vars:
            ansible_user: root
            ansible_ssh_common_args: '-o StrictHostKeyChecking=no'

        - name: Configure GRUB for serial console
          when:
            - enable_serial | default(true)
          block:
            - name: Update GRUB config for serial console
              ansible.builtin.lineinfile:
                path: /etc/default/grub
                regexp: '^GRUB_CMDLINE_LINUX='
                line: 'GRUB_CMDLINE_LINUX="console=tty0 console=ttyS0,115200n8"'
                backup: true
              delegate_to: "{{ vm_ip_address }}"
              vars:
                ansible_user: root
                ansible_ssh_common_args: '-o StrictHostKeyChecking=no'

            - name: Enable GRUB serial terminal
              ansible.builtin.blockinfile:
                path: /etc/default/grub
                marker: "# {mark} ANSIBLE MANAGED - Serial Console"
                insertafter: '^GRUB_CMDLINE_LINUX='
                block: |
                  GRUB_TERMINAL="console serial"
                  GRUB_SERIAL_COMMAND="serial --speed=115200 --unit=0 \
                  --word=8 --parity=no --stop=1"
              delegate_to: "{{ vm_ip_address }}"
              vars:
                ansible_user: root
                ansible_ssh_common_args: '-o StrictHostKeyChecking=no'

            - name: Update GRUB
              ansible.builtin.command: update-grub
              delegate_to: "{{ vm_ip_address }}"
              vars:
                ansible_user: root
                ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
              changed_when: true

            - name: Configure getty for serial console
              ansible.builtin.systemd:
                name: serial-getty@ttyS0.service
                enabled: true
                state: started
              delegate_to: "{{ vm_ip_address }}"
              vars:
                ansible_user: root
                ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
              failed_when: false

        - name: Debug - Check network files before restart
          ansible.builtin.shell: >
            ls -la /etc/systemd/network/10-mgmt.* 2>&1 || echo "Files not found"
          delegate_to: "{{ vm_ip_address }}"
          vars:
            ansible_user: root
            ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
          register: network_files_check
          changed_when: false

        - name: Debug - Check systemd-networkd status before restart
          ansible.builtin.command: systemctl status systemd-networkd --no-pager
          delegate_to: "{{ vm_ip_address }}"
          vars:
            ansible_user: root
            ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
          register: networkd_status_before
          changed_when: false
          failed_when: false

        - name: Debug - Show network files and systemd-networkd status
          ansible.builtin.debug:
            msg:
              - "Network files check: {{ network_files_check.stdout }}"
              - "VM IP: {{ vm_ip_address }}"
              - "systemd-networkd status before restart:"
              - "{{ networkd_status_before.stdout_lines | default([]) }}"
              - "About to restart systemd-networkd..."

        - name: Shut down VM to remove cloud-init CD
          community.proxmox.proxmox_kvm:
            api_host: "{{ proxmox_api_host }}"
            api_user: "{{ proxmox_api_user }}"
            api_token_id: "{{ proxmox_token_id }}"
            api_token_secret: "{{ proxmox_token_secret }}"
            validate_certs: false
            node: "{{ proxmox_host }}"
            vmid: "{{ new_vmid }}"
            state: stopped
          delegate_to: ansible.home.goodkind.io
          when: >-
            (not (ssh_wait_v6.failed | default(true))
            or not (ssh_wait_v4.failed | default(true)))

        - name: Wait for VM to fully stop
          ansible.builtin.pause:
            seconds: 5
          when: >-
            (not (ssh_wait_v6.failed | default(true))
            or not (ssh_wait_v4.failed | default(true)))

        - name: Remove cloud-init CD drive
          ansible.builtin.command: >
            qm set {{ new_vmid }} --delete ide2
          delegate_to: "{{ proxmox_host }}"
          changed_when: true
          failed_when: false
          when: >-
            (not (ssh_wait_v6.failed | default(true))
            or not (ssh_wait_v4.failed | default(true)))

        - name: Start VM after CD removal
          community.proxmox.proxmox_kvm:
            api_host: "{{ proxmox_api_host }}"
            api_user: "{{ proxmox_api_user }}"
            api_token_id: "{{ proxmox_token_id }}"
            api_token_secret: "{{ proxmox_token_secret }}"
            validate_certs: false
            node: "{{ proxmox_host }}"
            vmid: "{{ new_vmid }}"
            state: started
          delegate_to: ansible.home.goodkind.io
          when: >-
            (not (ssh_wait_v6.failed | default(true))
            or not (ssh_wait_v4.failed | default(true)))

        - name: Wait for VM to be reachable via SSH after restart
          ansible.builtin.wait_for:
            host: "{{ vm_ip_address }}"
            port: 22
            timeout: 120
            state: started
            msg: "Waiting for SSH on {{ vm_ip_address }}:22 after restart..."
          register: ssh_wait_after_restart
          failed_when: false
          when: >-
            (not (ssh_wait_v6.failed | default(true))
            or not (ssh_wait_v4.failed | default(true)))

        - name: Debug - Check systemd-networkd status after restart
          ansible.builtin.command: systemctl status systemd-networkd --no-pager
          delegate_to: "{{ vm_ip_address }}"
          vars:
            ansible_user: root
            ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
          register: networkd_status
          changed_when: false
          failed_when: false

        - name: Set facts for subsequent playbooks
          ansible.builtin.set_fact:
            hostname_fact: "{{ hostname }}"
            vm_created_fact: true
            vm_vmid_fact: "{{ new_vmid }}"

        - name: Add VM to new_vms group for prep-cts (connect via IP initially)
          ansible.builtin.add_host:
            name: "{{ hostname }}"
            groups: new_vms
            ansible_host: "{{ vm_ip_address }}"
            ansible_user: root
            ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
            ansible_proxmox_vmid: "{{ new_vmid }}"
            ansible_proxmox_host: "{{ proxmox_host }}"
          when: vm_ip_address | default('') | length > 0

        - name: Check if SSH is available
          ansible.builtin.set_fact:
            ssh_available: >-
              {{ not (ssh_wait_v6.failed | default(true)) or
              not (ssh_wait_v4.failed | default(true)) }}

        - name: Display result
          ansible.builtin.debug:
            msg:
              - "âœ… VM {{ hostname }} created (VMID: {{ new_vmid }})"
              - "  - IPv4: {{ vm_static_ipv4 }}/24"
              - "  - IPv6: {{ vm_static_ipv6 }}/64"
              - >-
                {{ 'âœ… SSH available at ' + vm_ip_address
                if ssh_available else 'âš ï¸  SSH not yet available' }}
              - ""
              - "Next: Run deployment playbook to configure services"

- name: Prepare newly created VMs
  import_playbook: prep-cts.yml
  vars:
    target_hosts: new_vms
  when: groups['new_vms'] is defined and groups['new_vms'] | length > 0

- name: Reset temporary passwords at end of playbook
  hosts: localhost
  gather_facts: false
  vars:
    proxmox_host: vault
  tasks:
    - name: Check if VM was created in this run
      ansible.builtin.set_fact:
        should_reset: "{{ hostvars['localhost']['vm_created_fact'] | default(false) | bool }}"
        reset_vmid: "{{ hostvars['localhost']['vm_vmid_fact'] | default('') }}"
        reset_hostname: "{{ hostvars['localhost']['hostname_fact'] | default('') }}"
      when: hostvars['localhost']['vm_created_fact'] is defined

    - name: Generate new random password for reset
      ansible.builtin.shell: |
        set -o pipefail
        openssl rand -base64 12 | tr -d "=+/" | cut -c1-16
      register: new_password_result
      changed_when: false
      args:
        executable: /bin/bash
      when: should_reset | default(false) | bool

    - name: Set new random password
      ansible.builtin.set_fact:
        new_random_password: "{{ new_password_result.stdout }}"
      when: should_reset | default(false) | bool

    - name: Reset password randomly at end of playbook
      ansible.builtin.command: >
        qm set {{ reset_vmid }}
        --cipassword {{ new_random_password }}
      delegate_to: "{{ proxmox_host }}"
      changed_when: true
      failed_when: false
      when: should_reset | default(false) | bool

    - name: Display password reset confirmation
      ansible.builtin.debug:
        msg:
          - "ðŸ”’ Password for root@{{ reset_hostname }} has been reset"
          - "  (Previous temporary password is no longer valid)"
      when: should_reset | default(false) | bool
