---
- name: Deploy and Configure Traefik
  hosts: traefik_servers
  become: true

  vars:
    traefik_version: "3.0.0"
    traefik_user: traefik
    traefik_group: traefik
    traefik_config_dir: /etc/traefik
    traefik_log_dir: /var/log/traefik
    repo_root: /usr/share/configs

  tasks:
    - name: Validate required variables
      ansible.builtin.assert:
        that:
          - cloudflare_api_token is defined
          - cloudflare_api_token | length > 0
          - cloudflare_api_token != ""
        fail_msg: |
          ERROR: CLOUDFLARE_API_TOKEN is not set!

          Set the environment variable:
            export CLOUDFLARE_API_TOKEN="your-token-here"

          Or in Semaphore Environment settings:
            CLOUDFLARE_API_TOKEN: your-token-here
        success_msg: "âœ“ Cloudflare API token is configured"

    - name: Create Traefik user
      ansible.builtin.user:
        name: "{{ traefik_user }}"
        system: true
        shell: /bin/false
        home: "{{ traefik_config_dir }}"
        create_home: false

    - name: Create Traefik directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: "{{ traefik_user }}"
        group: "{{ traefik_group }}"
        mode: '0750'
      loop:
        - "{{ traefik_config_dir }}"
        - "{{ traefik_config_dir }}/dynamic"
        - "{{ traefik_log_dir }}"

    - name: Check if Traefik is installed
      ansible.builtin.stat:
        path: /usr/local/bin/traefik
      register: traefik_binary

    - name: Get installed Traefik version
      ansible.builtin.command: /usr/local/bin/traefik version
      register: traefik_installed_version
      when: traefik_binary.stat.exists
      changed_when: false
      failed_when: false

    - name: Download and install Traefik
      when: not traefik_binary.stat.exists or traefik_version not in traefik_installed_version.stdout
      block:
        - name: Download Traefik
          ansible.builtin.get_url:
            url: "https://github.com/traefik/traefik/releases/download/v{{ traefik_version }}/traefik_v{{ traefik_version }}_linux_amd64.tar.gz"
            dest: /tmp/traefik.tar.gz
            mode: '0644'

        - name: Extract Traefik binary
          ansible.builtin.unarchive:
            src: /tmp/traefik.tar.gz
            dest: /tmp
            remote_src: true

        - name: Install Traefik binary
          ansible.builtin.copy:
            src: /tmp/traefik
            dest: /usr/local/bin/traefik
            owner: root
            group: root
            mode: '0755'
            remote_src: true

        - name: Cleanup download files
          ansible.builtin.file:
            path: "{{ item }}"
            state: absent
          loop:
            - /tmp/traefik.tar.gz
            - /tmp/traefik
            - /tmp/LICENSE.md
            - /tmp/CHANGELOG.md

    - name: Install libcap2-bin for setcap
      ansible.builtin.apt:
        name: libcap2-bin
        state: present

    - name: Set CAP_NET_BIND_SERVICE capability
      ansible.builtin.command: setcap cap_net_bind_service=+ep /usr/local/bin/traefik
      changed_when: false

    - name: Template Traefik static configuration
      ansible.builtin.template:
        src: "{{ repo_root }}/traefik/traefik.yml.j2"
        dest: "{{ traefik_config_dir }}/traefik.yml"
        owner: "{{ traefik_user }}"
        group: "{{ traefik_group }}"
        mode: '0644'
      notify: Restart traefik

    - name: Template Traefik dynamic routes
      ansible.builtin.template:
        src: "{{ repo_root }}/traefik/dynamic/routes.yml.j2"
        dest: "{{ traefik_config_dir }}/dynamic/routes.yml"
        owner: "{{ traefik_user }}"
        group: "{{ traefik_group }}"
        mode: '0644'
      notify: Reload traefik

    - name: Template Traefik dynamic middlewares
      ansible.builtin.template:
        src: "{{ repo_root }}/traefik/dynamic/middlewares.yml.j2"
        dest: "{{ traefik_config_dir }}/dynamic/middlewares.yml"
        owner: "{{ traefik_user }}"
        group: "{{ traefik_group }}"
        mode: '0644'
      notify: Reload traefik

    - name: Set ownership of config files
      ansible.builtin.file:
        path: "{{ traefik_config_dir }}"
        owner: "{{ traefik_user }}"
        group: "{{ traefik_group }}"
        recurse: true

    - name: Create acme.json file
      ansible.builtin.file:
        path: "{{ traefik_config_dir }}/acme.json"
        state: touch
        owner: "{{ traefik_user }}"
        group: "{{ traefik_group }}"
        mode: '0600'
        modification_time: preserve
        access_time: preserve

    - name: Install Traefik systemd service
      ansible.builtin.template:
        src: traefik.service.j2
        dest: /etc/systemd/system/traefik.service
        owner: root
        group: root
        mode: '0644'
      notify:
        - Reload systemd
        - Restart traefik

    - name: Create Cloudflare credentials file
      ansible.builtin.copy:
        content: |
          CF_DNS_API_TOKEN={{ cloudflare_api_token }}
        dest: "{{ traefik_config_dir }}/.cloudflare.env"
        owner: "{{ traefik_user }}"
        group: "{{ traefik_group }}"
        mode: '0600'
      when: cloudflare_api_token is defined
      no_log: true

    - name: Enable and start Traefik service
      ansible.builtin.systemd:
        name: traefik
        enabled: true
        state: started
        daemon_reload: true

  handlers:
    - name: Reload systemd
      ansible.builtin.systemd:
        daemon_reload: true

    - name: Reload traefik
      ansible.builtin.systemd:
        name: traefik
        state: reloaded
      failed_when: false

    - name: Restart traefik
      ansible.builtin.systemd:
        name: traefik
        state: restarted
