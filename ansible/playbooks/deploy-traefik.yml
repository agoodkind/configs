---
- name: Deploy and Configure Traefik
  hosts: traefik_servers
  become: true

  vars:
    traefik_version: "3.0.0"
    traefik_user: traefik
    traefik_group: traefik
    traefik_config_dir: /etc/traefik
    traefik_log_dir: /var/log/traefik
    repo_root: "{{ playbook_dir | dirname | dirname }}"
    cloudflare_ips_v4_url: "https://www.cloudflare.com/ips-v4"
    cloudflare_ips_v6_url: "https://www.cloudflare.com/ips-v6"

  tasks:
    - name: Create Traefik user
      ansible.builtin.user:
        name: "{{ traefik_user }}"
        system: true
        shell: /bin/false
        home: "{{ traefik_config_dir }}"
        create_home: false

    - name: Create Traefik directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: "{{ traefik_user }}"
        group: "{{ traefik_group }}"
        mode: '0750'
      loop:
        - "{{ traefik_config_dir }}"
        - "{{ traefik_config_dir }}/dynamic"
        - "{{ traefik_log_dir }}"

    - name: Check if Traefik is installed
      ansible.builtin.stat:
        path: /usr/local/bin/traefik
      register: traefik_binary

    - name: Get installed Traefik version
      ansible.builtin.command: /usr/local/bin/traefik version
      register: traefik_installed_version
      when: traefik_binary.stat.exists
      changed_when: false
      failed_when: false

    - name: Download and install Traefik
      when: not traefik_binary.stat.exists or traefik_version not in traefik_installed_version.stdout
      block:
        - name: Download Traefik
          ansible.builtin.get_url:
            url: "https://github.com/traefik/traefik/releases/download/v{{ traefik_version }}/traefik_v{{ traefik_version }}_linux_amd64.tar.gz"
            dest: /tmp/traefik.tar.gz
            mode: '0644'

        - name: Extract Traefik binary
          ansible.builtin.unarchive:
            src: /tmp/traefik.tar.gz
            dest: /tmp
            remote_src: true

        - name: Install Traefik binary
          ansible.builtin.copy:
            src: /tmp/traefik
            dest: /usr/local/bin/traefik
            owner: root
            group: root
            mode: '0755'
            remote_src: true

        - name: Cleanup download files
          ansible.builtin.file:
            path: "{{ item }}"
            state: absent
          loop:
            - /tmp/traefik.tar.gz
            - /tmp/traefik
            - /tmp/LICENSE.md
            - /tmp/CHANGELOG.md

    - name: Install libcap2-bin for setcap
      ansible.builtin.apt:
        name: libcap2-bin
        state: present

    - name: Set CAP_NET_BIND_SERVICE capability
      ansible.builtin.command: setcap cap_net_bind_service=+ep /usr/local/bin/traefik
      changed_when: false

    - name: Set ownership of config files
      ansible.builtin.file:
        path: "{{ traefik_config_dir }}"
        owner: "{{ traefik_user }}"
        group: "{{ traefik_group }}"
        recurse: true

    - name: Create acme.json file
      ansible.builtin.file:
        path: "{{ traefik_config_dir }}/acme.json"
        state: touch
        owner: "{{ traefik_user }}"
        group: "{{ traefik_group }}"
        mode: '0600'
        modification_time: preserve
        access_time: preserve

    - name: Install Traefik systemd service
      ansible.builtin.template:
        src: "{{ repo_root }}/ansible/templates/traefik.service.j2"
        dest: /etc/systemd/system/traefik.service
        owner: root
        group: root
        mode: '0644'
      notify:
        - Reload systemd
        - Restart traefik

    - name: Create Cloudflare credentials file
      ansible.builtin.copy:
        content: |
          CF_DNS_API_TOKEN={{ cloudflare_api_token }}
        dest: "{{ traefik_config_dir }}/.cloudflare.env"
        owner: "{{ traefik_user }}"
        group: "{{ traefik_group }}"
        mode: '0600'
      when: cloudflare_api_token is defined
      no_log: true

    - name: Install apache2-utils for htpasswd
      ansible.builtin.apt:
        name: apache2-utils
        state: present

    - name: Create Traefik auth directory
      ansible.builtin.file:
        path: "{{ traefik_config_dir }}/auth"
        state: directory
        owner: "{{ traefik_user }}"
        group: "{{ traefik_group }}"
        mode: '0750'

    - name: Generate dashboard authentication file
      ansible.builtin.shell: |
        htpasswd -nb "{{ traefik_dashboard_user }}" "{{ traefik_dashboard_pass }}" > {{ traefik_config_dir }}/auth/dashboard-users
        chown {{ traefik_user }}:{{ traefik_group }} {{ traefik_config_dir }}/auth/dashboard-users
        chmod 600 {{ traefik_config_dir }}/auth/dashboard-users
      when:
        - traefik_dashboard_user is defined
        - traefik_dashboard_pass is defined
      no_log: true
      changed_when: true

    - name: Enable Traefik service
      ansible.builtin.systemd:
        name: traefik
        enabled: true
        daemon_reload: true

  handlers:
    - name: Reload systemd
      ansible.builtin.systemd:
        daemon_reload: true

# Deploy Traefik configuration by calling update playbook
- name: Deploy Traefik Configuration
  ansible.builtin.import_playbook: update-traefik-config.yml
