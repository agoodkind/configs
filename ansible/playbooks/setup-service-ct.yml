---
# Reusable playbook wrapper for service containers
#
# Required variables:
#   container_group: Inventory group name (e.g., adguard_servers)
#   group_vars_file: Path to group_vars file (relative to playbook_dir)
#   hostname_var: Variable name in group_vars containing the hostname
#     (e.g., adguard_hostname)
#
# Optional variables:
#   target_node: Proxmox node (default: vault)
#   container_vmid: Specific VMID to use (default: "")
#   ipv4_var: Variable name in group_vars containing IPv4 CIDR (e.g., adguard_ipv4)
#   ipv6_var: Variable name in group_vars containing IPv6 CIDR (e.g., adguard_ipv6)
#   disk_size: Container disk size in GB (default: "8")
#   memory: Container memory in MB (default: "2048")
#   cores: Container CPU cores (default: "2")
#   mac_var: Variable name in group_vars containing a stable MAC address
#     (e.g., traefik_mac_address). Used to keep DHCP reservations stable
#     across container recreation.
#   container_tags: Container tags
#     (default: "lxc,{{ container_group | replace('_servers', '') }}")
- name: Load service configuration and create/setup container
  hosts: localhost
  gather_facts: false
  vars:
    target_node_default: vault
    container_vmid_default: ""
    disk_size_default: "8"
    memory_default: "2048"
    cores_default: "2"
    container_tags_default: >-
      lxc,{{ container_group | replace('_servers', '') }}
  vars_files:
    - "{{ group_vars_file }}"
  tasks:
    - name: Validate required variables
      ansible.builtin.assert:
        that:
          - container_group is defined
          - group_vars_file is defined
          - hostname_var is defined
        fail_msg: >-
          container_group, group_vars_file, and hostname_var must be
          provided when importing setup-service-ct.yml

    - name: Get container hostname from group_vars
      ansible.builtin.set_fact:
        service_hostname: "{{ lookup('vars', hostname_var) }}"

    - name: Get static IPs from group_vars (optional)
      ansible.builtin.set_fact:
        service_ip_address: "{{ lookup('vars', ipv4_var) }}"
      when:
        - ipv4_var is defined
        - (ipv4_var | default('') | trim) | length > 0

    - name: Get static IPv6 from group_vars (optional)
      ansible.builtin.set_fact:
        service_ipv6_address: "{{ lookup('vars', ipv6_var) }}"
      when:
        - ipv6_var is defined
        - (ipv6_var | default('') | trim) | length > 0

    - name: Set IPv6-only flag
      ansible.builtin.set_fact:
        service_ipv6_only: "{{ ipv6_only | default(true) | bool }}"

    - name: Compute effective container settings (caller overrides defaults)
      ansible.builtin.set_fact:
        service_target_node: >-
          {{
            (target_node | default('') | trim)
            if (target_node | default('') | trim) | length > 0
            else (target_node_default | string)
          }}
        service_container_vmid: >-
          {{
            (container_vmid | default('') | string | trim)
            if (container_vmid | default('') | string | trim) | length > 0
            else (container_vmid_default | default('') | string | trim)
          }}
        service_disk_size: >-
          {{
            (disk_size | default('') | string | trim)
            if (disk_size | default('') | string | trim) | length > 0
            else (disk_size_default | string)
          }}
        service_memory: >-
          {{
            (memory | default('') | string | trim)
            if (memory | default('') | string | trim) | length > 0
            else (memory_default | string)
          }}
        service_cores: >-
          {{
            (cores | default('') | string | trim)
            if (cores | default('') | string | trim) | length > 0
            else (cores_default | string)
          }}
        service_container_tags: >-
          {{
            (container_tags | default('') | string | trim)
            if (container_tags | default('') | string | trim) | length > 0
            else (container_tags_default | string)
          }}

    - name: Get container MAC address from group_vars (optional)
      ansible.builtin.set_fact:
        service_mac_address: "{{ lookup('vars', mac_var) }}"
      when:
        - mac_var is defined
        - mac_var | string | trim | length > 0

- name: Create or ensure container exists
  ansible.builtin.import_playbook: create-ct.yml
  vars:
    container_hostname: "{{ hostvars['localhost']['service_hostname'] }}"
    target_node: "{{ hostvars['localhost']['service_target_node'] | default('vault') }}"
    vmid: "{{ hostvars['localhost']['service_container_vmid'] | default('') }}"
    ip_address: "{{ hostvars['localhost']['service_ip_address'] | default('') }}"
    ipv6_address: "{{ hostvars['localhost']['service_ipv6_address'] | default('') }}"
    ipv6_only: "{{ hostvars['localhost']['service_ipv6_only'] | default(false) | bool }}"
    disk_size: "{{ hostvars['localhost']['service_disk_size'] | default('8') }}"
    memory: "{{ hostvars['localhost']['service_memory'] | default('2048') }}"
    cores: "{{ hostvars['localhost']['service_cores'] | default('2') }}"
    container_tags: "{{ hostvars['localhost']['service_container_tags'] }}"
    mac_address: "{{ hostvars['localhost']['service_mac_address'] | default('') }}"

- name: Add container to service group
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Ensure container primary IP is available
      ansible.builtin.assert:
        that:
          - hostvars['localhost']['container_primary_ip'] is defined
          - (hostvars['localhost']['container_primary_ip'] | default('') | trim) | length > 0
        fail_msg: >-
          container_primary_ip was not discovered for {{ hostvars['localhost']['service_hostname'] }}.
      when: not ansible_check_mode

    - name: Add container to service-specific inventory group
      ansible.builtin.add_host:
        name: "{{ hostvars['localhost']['service_hostname'] }}"
        groups: "{{ container_group }}"
        ansible_host: "{{ hostvars['localhost']['container_primary_ip'] }}"
        ansible_user: root
        ansible_ssh_common_args: >-
          -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null
        ansible_proxmox_vmid: >-
          {{ hostvars[hostvars['localhost']['service_hostname']].ansible_proxmox_vmid | default('') }}
        ansible_proxmox_host: >-
          {{ hostvars[hostvars['localhost']['service_hostname']].ansible_proxmox_host | default('vault') }}
