---
# ============================================================================
# MWAN Multi-WAN Load Balancer Deployment
# ============================================================================
# Deploys mwan VM for multi-WAN load balancing with PCI passthrough
#   - X710 VF (trust mode) for AT&T 802.1X authentication
#   - I226-V NIC for Webpass (full passthrough to avoid MAC issues)
#   - Virtio for management and OPNsense link
#
# Required: VF must be created on Proxmox host first (x710-vf-setup.service)
# ============================================================================

- name: Add MWAN to inventory
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../inventory/group_vars/all/service_mapping.yml
    - ../inventory/group_vars/mwan_servers.yml
  tasks:
    - name: Add MWAN VM to mwan_servers group
      ansible.builtin.include_tasks: tasks/add-service-to-group.yml
      vars:
        service_name: mwan
        service_vmid: "{{ mwan_vmid }}"
        service_proxmox_node: "{{ mwan_proxmox_node }}"

- name: Prepare MWAN VM (base packages, SSH keys, etc.)
  ansible.builtin.import_playbook: prep-guests.yml
  vars:
    target_hosts: mwan_servers

- name: Configure MWAN VM
  hosts: mwan_servers
  become: false

  vars_files:
    - ../inventory/group_vars/mwan_servers.yml

  vars:
    mwan_config_dir: /etc/mwan
    repo_root: "{{ playbook_dir | dirname | dirname }}"

  tasks:
    - name: Generate deploy trace ID (early)
      ansible.builtin.set_fact:
        mwan_deploy_trace_id: "{{ lookup('pipe', 'date +%Y%m%d-%H%M%S') }}-deploy-{{ 999999 | random }}"

    - name: Ensure MWAN trace state directory exists
      ansible.builtin.file:
        path: /var/lib/mwan
        state: directory
        mode: "0755"
      changed_when: false
      failed_when: false

    - name: Write deploy trace ID file (run)
      ansible.builtin.copy:
        dest: /run/mwan-trace-id
        content: "{{ mwan_deploy_trace_id }}\n"
        mode: "0644"
      changed_when: false
      failed_when: false

    - name: Write deploy trace ID file (persistent)
      ansible.builtin.copy:
        dest: /var/lib/mwan/trace-id
        content: "{{ mwan_deploy_trace_id }}\n"
        mode: "0644"
      changed_when: false
      failed_when: false

    - name: Verify Debian
      ansible.builtin.assert:
        that:
          - ansible_os_family == "Debian"
        fail_msg: >-
          This playbook requires Debian.
          Found: {{ ansible_os_family | default('unknown') }}
        success_msg: >-
          ✓ {{ ansible_distribution }}
          {{ ansible_distribution_version }}

    - name: Get actual VMID from Proxmox
      delegate_to: vault
      ansible.builtin.shell:
        cmd: |
          set -o pipefail
          qm list | awk '$2 == "{{ inventory_hostname }}" {print $1}'
        executable: /bin/bash
      register: vmid_lookup
      changed_when: false
      failed_when: vmid_lookup.stdout | length == 0

    - name: Set actual VMID
      ansible.builtin.set_fact:
        actual_vmid: "{{ vmid_lookup.stdout | trim }}"
        mwan_vmid: "{{ vmid_lookup.stdout | trim }}" # Override group_vars

    # ============================================================================
    # PRE-DEPLOY: Auto-rollback setup
    # ============================================================================

    - name: Verify internet connectivity before deploy
      delegate_to: vault
      ansible.builtin.shell: |
        ping6 -c 2 -W 3 2606:4700:4700::1111 >/dev/null 2>&1 || \
        ping -c 2 -W 3 1.1.1.1 >/dev/null 2>&1
      register: pre_deploy_connectivity
      changed_when: false
      failed_when: false

    - name: Create pre-deploy snapshot on Proxmox
      delegate_to: vault
      ansible.builtin.command:
        cmd: >-
          qm snapshot {{ actual_vmid }}
          pre-deploy-{{ ansible_date_time.iso8601_basic_short }}
          --description "Pre-deploy snapshot for auto-rollback"
      register: snapshot_result
      changed_when: snapshot_result.rc == 0
      when: pre_deploy_connectivity.rc == 0

    - name: Warn if skipping snapshot due to broken connectivity
      ansible.builtin.debug:
        msg: "⚠️  Skipping pre-deploy snapshot - connectivity already broken!"
      when: pre_deploy_connectivity.rc != 0

    - name: Write deploy timestamp to MWAN VM
      ansible.builtin.copy:
        content: "{{ ansible_date_time.epoch }}"
        dest: /var/run/mwan-last-deploy
        mode: "0644"

    # ============================================================================
    # WATCHDOG: Deploy auto-rollback monitor
    # ============================================================================

    - name: Create watchdog config directory on Proxmox
      delegate_to: vault
      ansible.builtin.file:
        path: /etc/mwan-watchdog
        state: directory
        mode: "0755"

    - name: Deploy watchdog environment file to Proxmox
      delegate_to: vault
      ansible.builtin.template:
        src: "{{ repo_root }}/proxmox/config/mwan-watchdog.env.j2"
        dest: /etc/mwan-watchdog/watchdog.env
        mode: "0644"

    - name: Deploy mwan-watchdog script to Proxmox
      delegate_to: vault
      ansible.builtin.copy:
        src: "{{ repo_root }}/proxmox/scripts/mwan-watchdog.sh"
        dest: /usr/local/bin/mwan-watchdog.sh
        mode: "0755"

    - name: Deploy mwan-watchdog service to Proxmox
      delegate_to: vault
      ansible.builtin.template:
        src: "{{ repo_root }}/proxmox/services/mwan-watchdog.service.j2"
        dest: /etc/systemd/system/mwan-watchdog.service
        mode: "0644"

    - name: Enable mwan-watchdog service on Proxmox
      delegate_to: vault
      ansible.builtin.systemd:
        name: mwan-watchdog
        enabled: true
        state: started
        daemon_reload: true

    # ============================================================================
    # DEPLOY: MWAN configuration
    # ============================================================================

    - name: Install and configure cloudflared
      ansible.builtin.include_tasks: tasks/install-cloudflared.yml

    - name: Install required packages
      ansible.builtin.apt:
        name:
          - wpasupplicant
          - nftables
          - iproute2
          - iptables
          - bash
          - curl
          - jq
          - vlan
          - bridge-utils
          - networkd-dispatcher
          - telnet
          - sipcalc
          - ipcalc-ng
          - ipcalc
          - ipv6calc
          - fping
        state: present

    - name: Create MWAN runtime config directory
      ansible.builtin.file:
        path: /etc/mwan
        state: directory
        mode: "0755"

    - name: Deploy MWAN runtime environment file
      ansible.builtin.template:
        src: "{{ repo_root }}/mwan/config/mwan.env.j2"
        dest: /etc/mwan/mwan.env
        mode: "0644"

    - name: Get VM network config from Proxmox
      delegate_to: vault
      ansible.builtin.command:
        cmd: qm config {{ actual_vmid }}
      register: vm_config
      changed_when: false

    - name: Parse virtio MAC addresses from VM config
      delegate_to: localhost
      ansible.builtin.set_fact:
        mwan_net1_mac: >-
          {{
            vm_config.stdout_lines
            | select('match', '^net1:.*virtio')
            | first
            | regex_replace('^.*virtio=([0-9A-Fa-f:]+).*$', '\1')
            | upper
          }}
        parsed_mwan_net2_mac: >-
          {{
            vm_config.stdout_lines
            | select('match', '^net2:.*virtio')
            | list
            | first
            | default('')
            | regex_replace('^.*virtio=([0-9A-Fa-f:]+).*$', '\1')
            | upper
          }}
        mwan_net2_present: >-
          {{
            (vm_config.stdout_lines | select('match', '^net2:.*') | list | length) > 0
          }}
        vm_mgmt_mac: >-
          {{
            vm_config.stdout_lines
            | select('match', '^net0:.*virtio')
            | first
            | regex_replace('^.*virtio=([0-9A-Fa-f:]+).*$', '\1')
            | upper
          }}

    - name: Select Monkeybrains MAC (prefer inventory override)
      delegate_to: localhost
      ansible.builtin.set_fact:
        mwan_mbrains_mac: >-
          {{
            ((mwan_mbrains_mac | default('')) | length > 0)
            | ternary(mwan_mbrains_mac, parsed_mwan_net2_mac)
          }}

    - name: Ensure Monkeybrains NIC exists when enabled
      ansible.builtin.fail:
        msg: >-
          Monkeybrains fallback is enabled, but no virtio net2 interface was found in Proxmox
          config for VM {{ actual_vmid }}. Add net2 (virtio) attached to the Monkeybrains network
          or disable mwan_health_checks.monkeybrains.enabled.
      when:
        - mwan_health_checks.monkeybrains.enabled | default(false)
        - not mwan_net2_present

    - name: Create configuration directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - "{{ mwan_config_dir }}"
        - /etc/sysctl.d
        - /etc/iproute2
        - /usr/local/bin
        - /etc/wpa_supplicant
        - /etc/dhcp
        - /etc/systemd/network
        - /etc/networkd-dispatcher/routable.d

    - name: Deploy wpa_supplicant config for AT&T 802.1X
      ansible.builtin.template:
        src: "{{ repo_root }}/mwan/config/wpa_supplicant.conf.j2"
        dest: /etc/wpa_supplicant/wpa_supplicant.conf
        mode: "0600"

    - name: Check for AT&T certificates on Ansible host
      delegate_to: localhost
      ansible.builtin.stat:
        path: "{{ mwan_att_certs_path }}/{{ item }}"
      loop:
        - ca_cert.pem
        - client_cert.pem
        - private_key.pem
      register: local_cert_check

    - name: Copy AT&T certificates from Ansible host
      ansible.builtin.copy:
        src: "{{ mwan_att_certs_path }}/{{ item.item }}"
        dest: "/etc/wpa_supplicant/{{ item.item }}"
        mode: "0600"
        owner: root
        group: root
      when: item.stat.exists
      loop: "{{ local_cert_check.results }}"

    - name: Check for AT&T certificates on target
      ansible.builtin.stat:
        path: "/etc/wpa_supplicant/{{ item }}"
      loop:
        - ca_cert.pem
        - client_cert.pem
        - private_key.pem
      register: cert_check

    - name: Warn if certificates missing
      ansible.builtin.debug:
        msg: |
          ⚠️  Certificate {{ item.item }} missing!
          Place certificates on Ansible controller at:
            {{ mwan_att_certs_path }}/
          Or manually upload to target:
            scp 'agoodkind@router:/conf/opnatt/wpa/*.pem' \
              root@{{ inventory_hostname }}:/etc/wpa_supplicant/
          Then restart: systemctl restart wpa_supplicant-mwan
      when: not item.stat.exists
      loop: "{{ cert_check.results }}"

    - name: Deploy OpenSSL config for legacy provider support
      ansible.builtin.copy:
        src: "{{ repo_root }}/mwan/config/openssl.cnf"
        dest: /etc/wpa_supplicant/openssl.cnf
        mode: "0644"
      notify: Restart wpa_supplicant

    - name: Deploy wpa_supplicant systemd service
      ansible.builtin.copy:
        src: "{{ repo_root }}/mwan/services/wpa_supplicant.service"
        dest: /etc/systemd/system/wpa_supplicant-mwan.service
        mode: "0644"

    - name: Enable wpa_supplicant service
      ansible.builtin.systemd:
        name: wpa_supplicant-mwan
        enabled: true
        daemon_reload: true

    - name: Deploy wpa-cli-action service
      ansible.builtin.copy:
        src: "{{ repo_root }}/mwan/services/wpa-cli-action.service"
        dest: /etc/systemd/system/wpa-cli-action.service
        mode: "0644"

    - name: Enable wpa-cli-action service
      ansible.builtin.systemd:
        name: wpa-cli-action
        enabled: true
        daemon_reload: true

    - name: Deploy wpa_supplicant action script
      ansible.builtin.copy:
        src: "{{ repo_root }}/mwan/scripts/wpa-action.sh"
        dest: /usr/local/bin/wpa-action.sh
        mode: "0755"

    - name: Deploy wpa-authenticated path unit
      ansible.builtin.copy:
        src: "{{ repo_root }}/mwan/paths/wpa-authenticated.path"
        dest: /etc/systemd/system/wpa-authenticated.path
        mode: "0644"

    - name: Deploy wpa-authenticated service unit
      ansible.builtin.copy:
        src: "{{ repo_root }}/mwan/services/wpa-authenticated.service"
        dest: /etc/systemd/system/wpa-authenticated.service
        mode: "0644"

    - name: Enable wpa-authenticated path unit
      ansible.builtin.systemd:
        name: wpa-authenticated.path
        enabled: true
        daemon_reload: true

    - name: Deploy AT&T VLAN bringup script
      ansible.builtin.copy:
        src: "{{ repo_root }}/mwan/scripts/bringup-att-vlan.sh"
        dest: /usr/local/bin/bringup-att-vlan.sh
        mode: "0755"

    - name: Deploy AT&T VLAN bringup systemd service
      ansible.builtin.copy:
        src: "{{ repo_root }}/mwan/services/bringup-att-vlan.service"
        dest: /etc/systemd/system/bringup-att-vlan.service
        mode: "0644"

    - name: Enable AT&T VLAN bringup service
      ansible.builtin.systemd:
        name: bringup-att-vlan
        enabled: true
        daemon_reload: true

    - name: Empty systemd-networkd directory
      ansible.builtin.file:
        path: /etc/systemd/network
        state: absent

    - name: Ensure systemd-networkd directory exists
      ansible.builtin.file:
        path: /etc/systemd/network
        state: directory
        mode: "0755"

    - name: Set variables for management interface templates
      ansible.builtin.set_fact:
        vm_mgmt_iface: "{{ mwan_mgmt_iface }}"
        vm_mgmt_ipv6_prefix: "64"
        vm_mgmt_dns_servers: "{{ mwan_dns_servers }}"
        vm_mgmt_dns_domain: "{{ mwan_dns_domain }}"
        vm_mgmt_ipv6: "3d06:bad:b01::{{ actual_vmid | string | trim }}"
        hostname: "{{ service_hostname }}"

    - name: Deploy management interface networkd configuration
      ansible.builtin.template:
        src: "{{ repo_root }}/ansible/templates/vm/{{ item }}.j2"
        dest: /etc/systemd/network/{{ item }}
        mode: "0644"
      loop:
        - 10-mgmt.link
        - 10-mgmt.network

    - name: Deploy systemd-networkd configuration files
      ansible.builtin.template:
        src: "{{ repo_root }}/mwan/networkd/{{ item }}.j2"
        dest: /etc/systemd/network/{{ item }}
        mode: "0644"
      loop:
        - 20-att.link
        - 20-att.network
        - 20-webpass.link
        - 20-webpass.network
        - 30-monkeybrains.link
        - 30-monkeybrains.network
        - 21-att-vlan.netdev
        - 21-att-vlan.network
        - 40-mwanbr.link
        - 40-mwanbr.network

    - name: Reload udev rules
      ansible.builtin.command: udevadm control --reload
      changed_when: false
      failed_when: false

    - name: Trigger net udev events
      ansible.builtin.command: udevadm trigger --action=add --subsystem-match=net
      changed_when: false
      failed_when: false

    - name: Deploy networkd-dispatcher hook for route updates
      ansible.builtin.copy:
        src: "{{ repo_root }}/mwan/hooks/50-update-routes.sh"
        dest: /etc/networkd-dispatcher/routable.d/50-update-routes.sh
        mode: "0755"

    - name: Deploy networkd-dispatcher hook for NPT updates
      ansible.builtin.copy:
        src: "{{ repo_root }}/mwan/hooks/55-update-npt.sh"
        dest: /etc/networkd-dispatcher/routable.d/55-update-npt.sh
        mode: "0755"

    - name: Enable networkd-dispatcher
      ansible.builtin.systemd:
        name: networkd-dispatcher
        enabled: true
        daemon_reload: true

    - name: Deploy sysctl config
      ansible.builtin.template:
        src: "{{ repo_root }}/mwan/config/sysctl-mwan.conf.j2"
        dest: /etc/sysctl.d/99-mwan.conf
        mode: "0644"

    - name: Deploy quiet console sysctl config to prevent nftables logging noise
      ansible.builtin.copy:
        src: "{{ repo_root }}/mwan/config/99-quiet-console.conf"
        dest: /etc/sysctl.d/99-quiet-console.conf
        mode: "0644"

    - name: Deploy routing tables
      ansible.builtin.template:
        src: "{{ repo_root }}/mwan/config/rt_tables.j2"
        dest: /etc/iproute2/rt_tables
        mode: "0644"

    - name: Deploy nftables config
      ansible.builtin.template:
        src: "{{ repo_root }}/mwan/config/nftables.conf.j2"
        dest: /etc/nftables.conf
        mode: "0644"
        backup: true
      vars:
        actual_mgmt_iface: "{{ mwan_mgmt_iface }}"
        actual_att_iface: "{{ mwan_att_iface }}"
        actual_webpass_iface: "{{ mwan_webpass_iface }}"
        actual_internal_iface: "{{ mwan_internal_iface }}"

    - name: Create systemd override for nftables
      ansible.builtin.file:
        path: /etc/systemd/system/nftables.service.d
        state: directory
        mode: "0755"

    - name: Deploy nftables systemd override
      ansible.builtin.copy:
        src: "{{ repo_root }}/mwan/overrides/nftables.service.d-override.conf"
        dest: /etc/systemd/system/nftables.service.d/override.conf
        mode: "0644"

    - name: Create systemd override for systemd-networkd
      ansible.builtin.file:
        path: /etc/systemd/system/systemd-networkd.service.d
        state: directory
        mode: "0755"

    - name: Deploy systemd-networkd debug override
      ansible.builtin.copy:
        src: "{{ repo_root }}/mwan/overrides/systemd-networkd.service.d-override.conf"
        dest: /etc/systemd/system/systemd-networkd.service.d/override.conf
        mode: "0644"

    - name: Create systemd override for getty@tty1 (physical console auto-login)
      ansible.builtin.file:
        path: /etc/systemd/system/getty@tty1.service.d
        state: directory
        mode: "0755"

    - name: Deploy getty@tty1 systemd override (physical console auto-login)
      ansible.builtin.copy:
        src: "{{ repo_root }}/mwan/overrides/getty@tty1.service.d-override.conf"
        dest: /etc/systemd/system/getty@tty1.service.d/override.conf
        mode: "0644"

    - name: Create systemd override for serial-getty@ttyS0 (serial console auto-login)
      ansible.builtin.file:
        path: /etc/systemd/system/serial-getty@ttyS0.service.d
        state: directory
        mode: "0755"

    - name: Deploy serial-getty@ttyS0 systemd override (serial console auto-login)
      ansible.builtin.copy:
        src: "{{ repo_root }}/mwan/overrides/serial-getty@ttyS0.service.d-override.conf"
        dest: /etc/systemd/system/serial-getty@ttyS0.service.d/override.conf
        mode: "0644"

    - name: Deploy templated helper scripts
      ansible.builtin.template:
        src: "{{ repo_root }}/mwan/{{ item }}.j2"
        dest: /usr/local/bin/{{ item | basename }}
        mode: "0755"
      loop: []

    - name: Deploy static helper scripts
      ansible.builtin.copy:
        src: "{{ repo_root }}/mwan/{{ item }}"
        dest: /usr/local/bin/{{ item | basename }}
        mode: "0755"
      loop:
        - scripts/update-routes.sh
        - scripts/health-check.sh
        - scripts/update-npt.sh
        - scripts/mwan-update-npt-all.sh
        - scripts/mwan-wait-npt-prereqs.sh
        - scripts/mwan-wait-routes-prereqs.sh
        - scripts/mwan-trace-boot.sh
        - scripts/wpa-wait-att-iface.sh

    - name: Ensure /usr/local/share/mwan exists
      ansible.builtin.file:
        path: /usr/local/share/mwan
        state: directory
        mode: "0755"

    - name: Deploy jq helper for `mwan trace-tail`
      ansible.builtin.copy:
        src: "{{ repo_root }}/mwan/scripts/trace-tail.jq"
        dest: /usr/local/share/mwan/trace-tail.jq
        mode: "0644"

    - name: Deploy mwan debug helper (single entrypoint)
      ansible.builtin.copy:
        src: "{{ repo_root }}/mwan/scripts/mwan-debug.sh"
        dest: /usr/local/bin/mwan
        mode: "0755"

    - name: Deploy DHCPv6-PD prefix finder helper
      ansible.builtin.copy:
        src: "{{ repo_root }}/mwan/scripts/find-pd-prefixes.sh"
        dest: /usr/local/bin/find-pd-prefixes.sh
        mode: "0755"

    - name: Deploy pinned destination refresher (nft set)
      ansible.builtin.copy:
        src: "{{ repo_root }}/mwan/scripts/update-att-pinned-dests.sh"
        dest: /usr/local/bin/update-att-pinned-dests.sh
        mode: "0755"

    - name: Deploy pinned destination updater service
      ansible.builtin.copy:
        src: "{{ repo_root }}/mwan/services/mwan-update-att-pinned-dests.service"
        dest: /etc/systemd/system/mwan-update-att-pinned-dests.service
        mode: "0644"

    - name: Deploy pinned destination updater timer
      ansible.builtin.copy:
        src: "{{ repo_root }}/mwan/timers/mwan-update-att-pinned-dests.timer"
        dest: /etc/systemd/system/mwan-update-att-pinned-dests.timer
        mode: "0644"

    - name: Deploy mwan update-routes oneshot service
      ansible.builtin.copy:
        src: "{{ repo_root }}/mwan/services/mwan-update-routes.service"
        dest: /etc/systemd/system/mwan-update-routes.service
        mode: "0644"

    - name: Deploy mwan update-npt oneshot service
      ansible.builtin.copy:
        src: "{{ repo_root }}/mwan/services/mwan-update-npt.service"
        dest: /etc/systemd/system/mwan-update-npt.service
        mode: "0644"

    - name: Deploy mwan boot trace service
      ansible.builtin.copy:
        src: "{{ repo_root }}/mwan/services/mwan-trace-boot.service"
        dest: /etc/systemd/system/mwan-trace-boot.service
        mode: "0644"

    - name: Enable mwan update-routes oneshot service
      ansible.builtin.systemd:
        name: mwan-update-routes
        enabled: true
        daemon_reload: true

    - name: Deploy mwan-health systemd service
      ansible.builtin.copy:
        src: "{{ repo_root }}/mwan/services/mwan-health.service"
        dest: /etc/systemd/system/mwan-health.service
        mode: "0644"

    - name: Enable services
      ansible.builtin.systemd:
        name: "{{ item }}"
        enabled: true
        daemon_reload: true
      loop:
        - mwan-trace-boot
        - mwan-update-npt
        - mwan-update-att-pinned-dests.timer
        - bringup-att-vlan
        - systemd-networkd
        - networkd-dispatcher
        - nftables
        - mwan-health
        - wpa_supplicant-mwan
        - wpa-cli-action
        - wpa-authenticated.path

    # ============================================================================
    # POST-DEPLOY: Reboot for clean state
    # ============================================================================
    # All services are enabled and will start on boot.
    # Watchdog monitors post-reboot and auto-rolls back if connectivity fails.

    - name: Register service with Consul
      ansible.builtin.template:
        src: "{{ repo_root }}/consul/services/service-definition.json.j2"
        dest: /etc/consul.d/mwan.json
        owner: consul
        group: consul
        mode: "0640"
      vars:
        consul_service_name: mwan
        consul_service_tags: ["gateway", "vm"]
        consul_service_port: 22
        consul_service_checks:
          - tcp: "localhost:22"
            interval: "30s"
            timeout: "5s"
      notify: Reload Consul
      when: consul_agent_enabled | default(true) | bool

    - name: Deploy complete - scheduling reboot
      ansible.builtin.debug:
        msg: >-
          ✓ All configs deployed (traceId={{ mwan_deploy_trace_id }})
          ✓ Scheduling reboot in 5 seconds to apply changes cleanly
          ✓ Timestamp preserved: /var/run/mwan-last-deploy
          ✓ Watchdog will monitor post-reboot and auto-rollback if needed

    - name: Schedule reboot to apply all changes
      ansible.builtin.shell:
        cmd: nohup sh -c 'sleep 5 && reboot' &>/dev/null &
      changed_when: true
      async: 1
      poll: 0

    - name: Playbook complete
      ansible.builtin.debug:
        msg: >-
          Deploy playbook complete. MWAN VM will reboot in ~5 seconds.
          Monitor watchdog logs: ssh root@3d06:bad:b01::254 "tail -f /var/log/mwan-watchdog.log"

  handlers:
    - name: Restart wpa_supplicant
      ansible.builtin.systemd:
        name: wpa_supplicant-mwan
        state: restarted
        daemon_reload: true

    - name: Restart cloudflared
      ansible.builtin.systemd:
        name: cloudflared
        state: restarted
        daemon_reload: true

    - name: Reload Consul
      ansible.builtin.systemd:
        name: consul
        state: reloaded
