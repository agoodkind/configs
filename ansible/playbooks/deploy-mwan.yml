---
# ============================================================================
# MWAN Multi-WAN Load Balancer Deployment
# ============================================================================
# Deploys mwan VM for multi-WAN load balancing with PCI passthrough
#   - X710 VF (trust mode) for AT&T 802.1X authentication
#   - I226-V NIC for Webpass (full passthrough to avoid MAC issues)
#   - Virtio for management and OPNsense link
#
# Required: VF must be created on Proxmox host first (x710-vf-setup.service)
# ============================================================================

- name: Load mwan configuration and setup VM
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../inventory/group_vars/mwan_servers.yml
  tasks:
    - name: Set variables for VM creation
      ansible.builtin.set_fact:
        vm_hostname: "{{ mwan_hostname }}"
        vm_mgmt_bridge: "{{ mwan_mgmt_bridge | default('vmbr0') }}"
        vm_internal_bridge: "{{ mwan_bridge_name | default('mwanbr') }}"
        vm_x710_vf: "{{ pci_x710_vf | default('') }}"
        vm_webpass_nic: "{{ pci_webpass_nic | default('') }}"
        vm_dns_domain: "{{ mwan_dns_domain }}"
        vm_dns_servers: "{{ mwan_dns_servers }}"
        vm_mgmt_ip_config: "{{ mwan_mgmt_ip_config | default('ip=dhcp,ip6=dhcp') }}"

- name: Setup mwan VM
  ansible.builtin.import_playbook: create-vm.yml
  vars:
    hostname: "{{ hostvars['localhost']['vm_hostname'] }}"
    target_node: vault
    disk_size: "16"
    memory: "2048"
    cores: "2"
    network_interfaces:
      - "{{ hostvars['localhost']['vm_mgmt_bridge'] }}"
      - "{{ hostvars['localhost']['vm_internal_bridge'] }}"
    hostpci_devices:
      - "{{ hostvars['localhost']['vm_x710_vf'] }}"
      - "{{ hostvars['localhost']['vm_webpass_nic'] }}"
    vm_tags: "vm,mwan,network"
    mgmt_ip_config: "{{ hostvars['localhost']['vm_mgmt_ip_config'] }}"
    dns_domain: "{{ hostvars['localhost']['vm_dns_domain'] }}"
    dns_servers: "{{ hostvars['localhost']['vm_dns_servers'] }}"
    delete_existing_vm: "{{ delete_existing_vm | default(false) | bool }}"
    skip_password_reset: "{{ skip_password_reset | default(false) | bool }}"

- name: Configure MWAN VM
  hosts: mwan_servers
  become: false

  vars:
    mwan_config_dir: /etc/mwan
    repo_root: "{{ playbook_dir | dirname | dirname }}"

  tasks:
    # - name: Reboot VM to apply initial network configuration
    #   ansible.builtin.reboot:
    #     msg: "Rebooting VM to apply initial network configuration"
    #     connect_timeout: 5
    #     pre_reboot_delay: 0
    #     post_reboot_delay: 0
    #   when: not ansible_check_mode

    - name: Wait for VM
      ansible.builtin.wait_for_connection:
        timeout: 120
      register: connection_check
      failed_when: false

    - name: Gather facts
      ansible.builtin.setup:
      when: connection_check.failed is not defined or not connection_check.failed

    - name: Verify Debian
      ansible.builtin.assert:
        that:
          - ansible_os_family == "Debian"
        fail_msg: >-
          This playbook requires Debian.
          Found: {{ ansible_os_family | default('unknown') }}
        success_msg: >-
          ✓ {{ ansible_distribution }}
          {{ ansible_distribution_version }}

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

    - name: Install required packages
      ansible.builtin.apt:
        name:
          - wpasupplicant
          - nftables
          - iproute2
          - iptables
          - bash
          - curl
          - vlan
          - bridge-utils
          - networkd-dispatcher
          - telnet
        state: present

    - name: Get actual VMID from Proxmox
      delegate_to: vault.home.goodkind.io
      ansible.builtin.shell:
        cmd: |
          set -o pipefail
          qm list | awk '$2 == "{{ inventory_hostname }}" {print $1}'
        executable: /bin/bash
      register: vmid_lookup
      changed_when: false
      failed_when: vmid_lookup.stdout | length == 0

    - name: Set actual VMID
      ansible.builtin.set_fact:
        actual_vmid: "{{ vmid_lookup.stdout | trim }}"
        mwan_vmid: "{{ vmid_lookup.stdout | trim }}"  # Override group_vars

    - name: Get VM network config from Proxmox
      delegate_to: vault.home.goodkind.io
      ansible.builtin.command:
        cmd: qm config {{ actual_vmid }}
      register: vm_config
      changed_when: false

    - name: Parse virtio MAC addresses from VM config
      delegate_to: localhost
      ansible.builtin.set_fact:
        mwan_net1_mac: >-
          {{
            vm_config.stdout_lines
            | select('match', '^net1:.*virtio')
            | first
            | regex_replace('^.*virtio=([0-9A-Fa-f:]+).*$', '\1')
            | upper
          }}
        vm_mgmt_mac: >-
          {{
            vm_config.stdout_lines
            | select('match', '^net0:.*virtio')
            | first
            | regex_replace('^.*virtio=([0-9A-Fa-f:]+).*$', '\1')
            | upper
          }}

    - name: Create configuration directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ mwan_config_dir }}"
        - /etc/sysctl.d
        - /etc/iproute2
        - /usr/local/bin
        - /etc/wpa_supplicant
        - /etc/dhcp
        - /etc/systemd/network
        - /etc/networkd-dispatcher/routable.d

    - name: Deploy wpa_supplicant config for AT&T 802.1X
      ansible.builtin.template:
        src: "{{ repo_root }}/ansible/templates/mwan/wpa_supplicant.conf.j2"
        dest: /etc/wpa_supplicant/wpa_supplicant.conf
        mode: '0600'

    - name: Check for AT&T certificates on Ansible host
      delegate_to: localhost
      ansible.builtin.stat:
        path: "{{ mwan_att_certs_path }}/{{ item }}"
      loop:
        - ca_cert.pem
        - client_cert.pem
        - private_key.pem
      register: local_cert_check

    - name: Copy AT&T certificates from Ansible host
      ansible.builtin.copy:
        src: "{{ mwan_att_certs_path }}/{{ item.item }}"
        dest: "/etc/wpa_supplicant/{{ item.item }}"
        mode: '0600'
        owner: root
        group: root
      when: item.stat.exists
      loop: "{{ local_cert_check.results }}"

    - name: Check for AT&T certificates on target
      ansible.builtin.stat:
        path: "/etc/wpa_supplicant/{{ item }}"
      loop:
        - ca_cert.pem
        - client_cert.pem
        - private_key.pem
      register: cert_check

    - name: Warn if certificates missing
      ansible.builtin.debug:
        msg: |
          ⚠️  Certificate {{ item.item }} missing!
          Place certificates on Ansible controller at:
            {{ mwan_att_certs_path }}/
          Or manually upload to target:
            scp 'agoodkind@router:/conf/opnatt/wpa/*.pem' \
              root@{{ inventory_hostname }}:/etc/wpa_supplicant/
          Then restart: systemctl restart wpa_supplicant-mwan
      when: not item.stat.exists
      loop: "{{ cert_check.results }}"

    - name: Deploy wpa_supplicant systemd service
      ansible.builtin.template:
        src: "{{ repo_root }}/ansible/templates/mwan/wpa_supplicant.service.j2"
        dest: /etc/systemd/system/wpa_supplicant-mwan.service
        mode: '0644'

    - name: Enable wpa_supplicant service
      ansible.builtin.systemd:
        name: wpa_supplicant-mwan
        enabled: true
        daemon_reload: true

    - name: Deploy wpa-cli-action service
      ansible.builtin.template:
        src: "{{ repo_root }}/ansible/templates/mwan/wpa-cli-action.service.j2"
        dest: /etc/systemd/system/wpa-cli-action.service
        mode: '0644'

    - name: Enable wpa-cli-action service
      ansible.builtin.systemd:
        name: wpa-cli-action
        enabled: true
        daemon_reload: true

    - name: Deploy wpa_supplicant action script
      ansible.builtin.template:
        src: "{{ repo_root }}/ansible/templates/mwan/wpa-action.sh.j2"
        dest: /usr/local/bin/wpa-action.sh
        mode: '0755'

    - name: Deploy wpa-authenticated path unit
      ansible.builtin.template:
        src: "{{ repo_root }}/ansible/templates/mwan/wpa-authenticated.path.j2"
        dest: /etc/systemd/system/wpa-authenticated.path
        mode: '0644'

    - name: Deploy wpa-authenticated service unit
      ansible.builtin.template:
        src: "{{ repo_root }}/ansible/templates/mwan/wpa-authenticated.service.j2"
        dest: /etc/systemd/system/wpa-authenticated.service
        mode: '0644'

    - name: Enable wpa-authenticated path unit
      ansible.builtin.systemd:
        name: wpa-authenticated.path
        enabled: true
        daemon_reload: true

    - name: Deploy AT&T VLAN bringup script
      ansible.builtin.template:
        src: "{{ repo_root }}/ansible/templates/mwan/bringup-att-vlan.sh.j2"
        dest: /usr/local/bin/bringup-att-vlan.sh
        mode: '0755'

    - name: Deploy AT&T VLAN bringup systemd service
      ansible.builtin.template:
        src: "{{ repo_root }}/ansible/templates/mwan/bringup-att-vlan.service.j2"
        dest: /etc/systemd/system/bringup-att-vlan.service
        mode: '0644'

    - name: Enable AT&T VLAN bringup service
      ansible.builtin.systemd:
        name: bringup-att-vlan
        enabled: true
        daemon_reload: true

    - name: Empty systemd-networkd directory
      ansible.builtin.file:
        path: /etc/systemd/network
        state: absent

    - name: Ensure systemd-networkd directory exists
      ansible.builtin.file:
        path: /etc/systemd/network
        state: directory
        mode: '0755'

    - name: Set variables for management interface templates
      ansible.builtin.set_fact:
        vm_mgmt_iface: "{{ mwan_mgmt_iface }}"
        vm_mgmt_ipv4_prefix: "24"
        vm_mgmt_ipv6_prefix: "64"
        vm_mgmt_gateway_ipv4: "10.250.0.1"
        vm_mgmt_gateway_ipv6: "3d06:bad:b01::1"
        vm_mgmt_dns_servers: "{{ mwan_dns_servers }}"
        vm_mgmt_dns_domain: "{{ mwan_dns_domain }}"
        vm_mgmt_ipv4: "10.250.0.{{ actual_vmid }}"
        vm_mgmt_ipv6: "3d06:bad:b01::{{ '%x' | format(actual_vmid | int) }}"
        hostname: "{{ mwan_hostname }}"

    - name: Deploy management interface networkd configuration
      ansible.builtin.template:
        src: "{{ repo_root }}/ansible/templates/vm/{{ item }}.j2"
        dest: /etc/systemd/network/{{ item }}
        mode: '0644'
      loop:
        - 10-mgmt.link
        - 10-mgmt.network

    - name: Deploy systemd-networkd configuration files
      ansible.builtin.template:
        src: "{{ repo_root }}/ansible/templates/mwan/networkd/{{ item }}.j2"
        dest: /etc/systemd/network/{{ item }}
        mode: '0644'
      loop:
        - 20-att.link
        - 20-att.network
        - 20-webpass.link
        - 20-webpass.network
        - 21-att-vlan.netdev
        - 21-att-vlan.network
        - 40-mwanbr.link
        - 40-mwanbr.network

    - name: Deploy networkd-dispatcher hook for route updates
      ansible.builtin.template:
        src: "{{ repo_root }}/ansible/templates/mwan/50-update-routes.sh.j2"
        dest: /etc/networkd-dispatcher/routable.d/50-update-routes.sh
        mode: '0755'

    - name: Enable networkd-dispatcher
      ansible.builtin.systemd:
        name: networkd-dispatcher
        enabled: true
        daemon_reload: true

    - name: Deploy sysctl config
      ansible.builtin.template:
        src: "{{ repo_root }}/ansible/templates/mwan/sysctl-mwan.conf.j2"
        dest: /etc/sysctl.d/99-mwan.conf
        mode: '0644'

    - name: Deploy routing tables
      ansible.builtin.template:
        src: "{{ repo_root }}/ansible/templates/mwan/rt_tables.j2"
        dest: /etc/iproute2/rt_tables
        mode: '0644'

    - name: Deploy nftables config
      ansible.builtin.template:
        src: "{{ repo_root }}/ansible/templates/mwan/nftables.conf.j2"
        dest: /etc/nftables.conf
        mode: '0644'
        backup: true
      vars:
        actual_mgmt_iface: "{{ mwan_mgmt_iface }}"
        actual_att_iface: "{{ mwan_att_iface }}"
        actual_webpass_iface: "{{ mwan_webpass_iface }}"
        actual_internal_iface: "{{ mwan_internal_iface }}"

    - name: Create systemd override for nftables
      ansible.builtin.file:
        path: /etc/systemd/system/nftables.service.d
        state: directory
        mode: '0755'

    - name: Deploy nftables systemd override
      ansible.builtin.template:
        src: "{{ repo_root }}/ansible/templates/mwan/nftables.service.d-override.conf.j2"
        dest: /etc/systemd/system/nftables.service.d/override.conf
        mode: '0644'

    - name: Deploy templated helper scripts
      ansible.builtin.template:
        src: "{{ repo_root }}/ansible/templates/mwan/{{ item }}.j2"
        dest: /usr/local/bin/{{ item }}
        mode: '0755'
      loop:
        - update-routes.sh
        - health-check.sh
        - update-npt.sh

    - name: Deploy static helper scripts
      ansible.builtin.copy:
        src: "{{ repo_root }}/mwan/usr/local/bin/{{ item }}"
        dest: /usr/local/bin/{{ item }}
        mode: '0755'
      loop:
        - test-wan-connectivity.sh

    - name: Deploy mwan-health systemd service
      ansible.builtin.template:
        src: "{{ repo_root }}/ansible/templates/mwan/mwan-health.service.j2"
        dest: /etc/systemd/system/mwan-health.service
        mode: '0644'

    - name: Wait for WAN interfaces to settle
      ansible.builtin.pause:
        seconds: 5

    - name: Enable services
      ansible.builtin.systemd:
        name: "{{ item }}"
        enabled: true
        daemon_reload: true
      loop:
        - bringup-att-vlan
        - systemd-networkd
        - networkd-dispatcher
        - nftables
        - mwan-health
        - wpa_supplicant-mwan
        - wpa-cli-action
        - wpa-authenticated.path

    # - name: Reboot VM
    #   ansible.builtin.reboot:
    #     msg: "Rebooting VM to apply network configuration"
    #     connect_timeout: 5
    #     pre_reboot_delay: 0
    #     post_reboot_delay: 0

    - name: Wait for VM to be reachable via SSH
      ansible.builtin.wait_for_connection:
        timeout: 120
      register: ssh_wait_after_restart
      failed_when: false

    - name: Ensure systemd-networkd is running
      ansible.builtin.systemd:
        name: systemd-networkd
        state: started
        enabled: true

    - name: Ensure networkd-dispatcher is running
      ansible.builtin.systemd:
        name: networkd-dispatcher
        state: started
        enabled: true

    - name: Reload systemd
      ansible.builtin.systemd:
        daemon_reload: true

    - name: Restart systemd-networkd
      ansible.builtin.systemd:
        name: systemd-networkd
        state: restarted

    - name: Wait for internal interface to be created by systemd-networkd
      ansible.builtin.wait_for:
        path: /sys/class/net/{{ mwan_internal_iface }}
        timeout: 10
      failed_when: false
      register: internal_iface_wait

    - name: Load nf_conntrack module
      ansible.builtin.command:
        cmd: modprobe nf_conntrack
      failed_when: false
      changed_when: false

    - name: Apply sysctl
      ansible.builtin.command:
        cmd: sysctl -p /etc/sysctl.d/99-mwan.conf
      changed_when: false
      failed_when: false
      register: sysctl_result

    - name: Reload nftables
      ansible.builtin.systemd:
        name: nftables
        state: reloaded
      failed_when: false

    - name: Check health status
      ansible.builtin.command: /usr/local/bin/health-check.sh --status
      register: health_status
      changed_when: false
      failed_when: false

    - name: Wait for AT&T interface to be created by systemd-networkd
      ansible.builtin.wait_for:
        path: /sys/class/net/{{ mwan_att_iface }}
        timeout: 10
      failed_when: >
        att_iface_wait.failed is defined and att_iface_wait.failed
      register: att_iface_wait

    - name: Verify AT&T interface exists
      ansible.builtin.fail:
        msg: >
          AT&T interface {{ mwan_att_iface }} not found after
          systemd-networkd restart. Check PCI passthrough and iavf driver.
      when: att_iface_wait.failed is defined and att_iface_wait.failed

    - name: Start wpa_supplicant (if certs present)
      ansible.builtin.systemd:
        name: wpa_supplicant-mwan
        state: started
      when: cert_check.results | selectattr('stat.exists') | list | length == 3
      failed_when: false

    - name: Start AT&T VLAN bringup service (if certs present)
      ansible.builtin.systemd:
        name: bringup-att-vlan
        state: started
      when: cert_check.results | selectattr('stat.exists') | list | length == 3
      failed_when: false

    - name: Start wpa-authenticated path unit (if certs present)
      ansible.builtin.systemd:
        name: wpa-authenticated.path
        state: started
      when: cert_check.results | selectattr('stat.exists') | list | length == 3
      failed_when: false

    - name: Get service statuses
      ansible.builtin.systemd:
        name: "{{ item }}"
      register: service_statuses
      loop:
        - bringup-att-vlan
        - systemd-networkd
        - networkd-dispatcher
        - nftables
        - mwan-health
        - wpa_supplicant-mwan
        - wpa-cli-action
        - wpa-authenticated.path
      changed_when: false
      failed_when: false

    - name: Display status
      ansible.builtin.debug:
        msg: |

          ╔══════════════════════════════════════════════════════════════╗
          ║                    Service Status Summary                    ║
          ╠══════════════════════════════════════════════════════════════╣
          ║ Service                      │ ActiveState │ SubState      ║
          ╠══════════════════════════════════════════════════════════════╣
          {% for result in service_statuses.results %}
          ║ {{ ("%-28s" | format(result.item)) ~ " │ " ~
            ("%-11s" | format(result.status.ActiveState | default('unknown'))) ~ " │ " ~
            ("%-13s" | format(result.status.SubState | default('unknown'))) }} ║
          {% endfor %}
          ╚══════════════════════════════════════════════════════════════╝

          Legend:
            ActiveState: active = running, inactive = stopped,
                         failed = error, activating = starting
            SubState:    running, dead, exited, etc.
