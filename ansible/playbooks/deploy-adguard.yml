---
- name: Check if AdGuard container exists
  hosts: localhost
  gather_facts: false
  vars:
    adguard_hostname: adguard.home.goodkind.io
    target_node: vault
    container_vmid: ""
  tasks:
    - name: List all LXC containers on Proxmox node
      ansible.builtin.command: pct list
      register: proxmox_containers_list
      delegate_to: "{{ target_node }}"
      changed_when: false
      failed_when: false

    - name: Find AdGuard container by hostname
      ansible.builtin.set_fact:
        adguard_container_line: "{{ proxmox_containers_list.stdout_lines | select('search', adguard_hostname) | list | first | default('') }}"
      changed_when: false

    - name: Extract VMID from container line
      ansible.builtin.set_fact:
        existing_vmid: "{{ adguard_container_line.split()[0] | default('') }}"
      when: adguard_container_line != ""
      changed_when: false

    - name: Check if container exists
      ansible.builtin.set_fact:
        container_exists: "{{ existing_vmid | default('') | length > 0 }}"
        existing_vmid: "{{ existing_vmid | default('') }}"
      changed_when: false

    - name: Display container status
      ansible.builtin.debug:
        msg: "Container {{ adguard_hostname }} {{ 'exists' if container_exists else 'does not exist' }}{{ ' with VMID ' + existing_vmid if container_exists else '' }}"

    - name: Set variables for container creation
      ansible.builtin.set_fact:
        adguard_hostname_fact: "{{ adguard_hostname }}"
        target_node_fact: "{{ target_node }}"
        container_vmid_fact: "{{ container_vmid }}"

- name: Create AdGuard container if it doesn't exist
  ansible.builtin.import_playbook: create-ct.yml
  vars:
    container_hostname: "{{ hostvars['localhost']['adguard_hostname_fact'] }}"
    target_node: "{{ hostvars['localhost']['target_node_fact'] }}"
    vmid: "{{ hostvars['localhost']['container_vmid_fact'] }}"
    disk_size: "8"
    memory: "2048"
    cores: "2"
    container_tags: "lxc,adguard"
  when: not container_exists | default(false)

- name: Set up container inventory
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Set local variables from hostvars
      ansible.builtin.set_fact:
        adguard_hostname: "{{ hostvars['localhost']['adguard_hostname_fact'] }}"
        target_node: "{{ hostvars['localhost']['target_node_fact'] }}"

    - name: Check if container was just created (in new_containers group)
      ansible.builtin.set_fact:
        container_just_created: "{{ groups['new_containers'] is defined and groups['new_containers'] | length > 0 and adguard_hostname in groups['new_containers'] }}"
      changed_when: false

    - name: Add container from new_containers to adguard_servers group
      ansible.builtin.add_host:
        name: "{{ adguard_hostname }}"
        groups: adguard_servers
        ansible_user: root
        ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
        ansible_proxmox_vmid: "{{ hostvars[adguard_hostname].ansible_proxmox_vmid | default('') }}"
        ansible_proxmox_host: "{{ hostvars[adguard_hostname].ansible_proxmox_host | default(target_node) }}"
      when: container_just_created | default(false)

    - name: Add existing container to adguard_servers group
      ansible.builtin.add_host:
        name: "{{ adguard_hostname }}"
        groups: adguard_servers
        ansible_user: root
        ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
        ansible_proxmox_vmid: "{{ hostvars['localhost']['existing_vmid'] | default('') }}"
        ansible_proxmox_host: "{{ target_node }}"
      when: hostvars['localhost']['container_exists'] | default(false) and not container_just_created | default(false)

- name: Deploy and Configure AdGuard Home
  hosts: adguard_servers
  become: true

  vars:
    adguard_version: "release"
    repo_root: "{{ playbook_dir | dirname | dirname }}"

  tasks:
    - name: Create AdGuard user
      ansible.builtin.user:
        name: "{{ adguard_user }}"
        system: true
        shell: /bin/false
        home: "{{ adguard_config_dir }}"
        create_home: false

    - name: Create AdGuard directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: "{{ adguard_user }}"
        group: "{{ adguard_group }}"
        mode: '0750'
      loop:
        - "{{ adguard_config_dir }}"
        - "{{ adguard_work_dir }}"
        - "{{ adguard_data_dir }}"

    - name: Check if AdGuard Home is installed
      ansible.builtin.stat:
        path: /opt/AdGuardHome/AdGuardHome
      register: adguard_binary

    - name: Get installed AdGuard Home version
      ansible.builtin.command: /opt/AdGuardHome/AdGuardHome --version
      register: adguard_installed_version
      when: adguard_binary.stat.exists
      changed_when: false
      failed_when: false

    - name: Parse installed version number
      ansible.builtin.set_fact:
        installed_version: "{{ adguard_installed_version.stdout | regex_search('v[0-9]+\\.[0-9]+\\.[0-9]+') | first | default('') }}"
      when: adguard_binary.stat.exists and adguard_installed_version.stdout is defined

    - name: Get available version from release channel
      ansible.builtin.uri:
        url: "https://static.adtidy.org/adguardhome/{{ adguard_version }}/version.json"
        return_content: true
      register: version_info
      changed_when: false
      failed_when: false

    - name: Parse available version from version.json
      ansible.builtin.set_fact:
        available_version: "{{ version_info.json.version | default('') }}"
      when: version_info.json is defined and version_info.json.version is defined

    - name: Install or update AdGuard Home using official install script
      when: >-
        not adguard_binary.stat.exists or
        (installed_version is defined and available_version is defined and installed_version != available_version)
      block:
        - name: Download and run AdGuard Home install script
          ansible.builtin.shell: |
            curl -s -S -L https://raw.githubusercontent.com/AdguardTeam/AdGuardHome/master/scripts/install.sh | sh -s -- -v -c {{ adguard_version }}
          register: install_result
          changed_when: install_result.rc == 0

        - name: Verify AdGuard Home binary was installed
          ansible.builtin.stat:
            path: /opt/AdGuardHome/AdGuardHome
          register: verify_binary

        - name: Assert AdGuard Home binary exists
          ansible.builtin.assert:
            that:
              - verify_binary.stat.exists
            fail_msg: "AdGuard Home binary was not installed successfully"

        - name: Create symlink to /usr/local/bin for systemd service
          ansible.builtin.file:
            src: /opt/AdGuardHome/AdGuardHome
            dest: /usr/local/bin/AdGuardHome
            state: link

    - name: Install libcap2-bin for setcap
      ansible.builtin.apt:
        name: libcap2-bin
        state: present

    - name: Set CAP_NET_BIND_SERVICE capability for DNS port
      ansible.builtin.command: setcap cap_net_bind_service=+ep /opt/AdGuardHome/AdGuardHome
      changed_when: false

    - name: Install AdGuard Home systemd service
      ansible.builtin.template:
        src: "{{ repo_root }}/ansible/templates/adguard.service.j2"
        dest: /etc/systemd/system/adguard.service
        owner: root
        group: root
        mode: '0644'
      notify:
        - Reload systemd
        - Restart adguard

    - name: Set ownership of config directories
      ansible.builtin.file:
        path: "{{ item }}"
        owner: "{{ adguard_user }}"
        group: "{{ adguard_group }}"
        recurse: true
      loop:
        - "{{ adguard_config_dir }}"
        - "{{ adguard_work_dir }}"
        - "{{ adguard_data_dir }}"

    - name: Template AdGuard Home configuration
      ansible.builtin.template:
        src: "{{ repo_root }}/adguard/AdGuardHome.yaml.j2"
        dest: "{{ adguard_config_dir }}/AdGuardHome.yaml"
        owner: "{{ adguard_user }}"
        group: "{{ adguard_group }}"
        mode: '0640'
      notify: Restart adguard

    - name: Enable AdGuard Home service
      ansible.builtin.systemd:
        name: adguard
        enabled: true
        daemon_reload: true

    - name: Ensure AdGuard Home service is running
      ansible.builtin.systemd:
        name: adguard
        state: started

    - name: Flush handlers to ensure AdGuard Home is restarted
      ansible.builtin.meta: flush_handlers

    - name: Wait for AdGuard Home to start
      ansible.builtin.pause:
        seconds: 5

    - name: Verify AdGuard Home service status
      ansible.builtin.systemd:
        name: adguard
      register: adguard_status

    - name: Display AdGuard Home service status
      ansible.builtin.debug:
        msg: "✓ AdGuard Home service is {{ adguard_status.status.ActiveState }}"

    - name: Check AdGuard Home web interface
      ansible.builtin.uri:
        url: "http://localhost:{{ adguard_port }}"
        follow_redirects: none
        validate_certs: false
        status_code: [200, 301, 302, 308]
        timeout: 5
      register: health_check
      retries: 3
      delay: 2
      until: health_check.status is defined
      failed_when: false

    - name: Report health check result
      ansible.builtin.debug:
        msg: >-
          {% if health_check.status is defined %}
          ✓ AdGuard Home is responding (HTTP {{ health_check.status }})
          {% else %}
          ⚠ AdGuard Home health check returned: {{ health_check.msg }}
          {% endif %}

  handlers:
    - name: Reload systemd
      ansible.builtin.systemd:
        daemon_reload: true

    - name: Restart adguard
      ansible.builtin.systemd:
        name: adguard
        state: restarted

- name: Summary
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Display completion message
      ansible.builtin.debug:
        msg: "✅ AdGuard Home deployed successfully on {{ hostvars['localhost']['adguard_hostname_fact'] }}"

