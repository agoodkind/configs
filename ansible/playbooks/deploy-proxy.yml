---
# Deploy Traefik + SSHPiper on the proxy container
#
# NOTE: After initial deployment, sshpiper runs on port 22 and sshd moves to 2222.
# For subsequent runs, you'll need to connect to the proxy container on port 2222:
#   ansible-playbook deploy-proxy.yml -e "ansible_port=2222"
# Or uncomment `ansible_port: 2222` in inventory/group_vars/proxy_servers.yml
#
# To manually SSH to the proxy container after deployment:
#   ssh -p 2222 root@proxy.home.goodkind.io
#   (or ssh -p 2222 root@10.250.0.10)

- name: Setup Traefik container
  ansible.builtin.import_playbook: setup-service-ct.yml
  vars:
    container_group: proxy_servers
    group_vars_file: "{{ playbook_dir }}/../inventory/group_vars/proxy_servers.yml"
    hostname_var: traefik_hostname
    mac_var: traefik_mac_address
    target_node: vault
    container_vmid: ""
    disk_size: "8"
    memory: "2048"
    cores: "2"
    container_tags: "lxc,traefik"

- name: Configure connection method for proxy container
  hosts: localhost
  gather_facts: false
  vars:
    proxy_hostname: "{{ hostvars['localhost']['service_hostname'] }}"
    proxy_ip: "{{ hostvars[proxy_hostname]['ansible_host'] | default('') }}"
  tasks:
    - name: Update proxy container with multi-port SSH config
      ansible.builtin.add_host:
        name: "{{ proxy_hostname }}"
        groups: proxy_servers
        ansible_host: "{{ proxy_ip }}"
        ansible_user: root
        ansible_ssh_common_args: >-
          -o StrictHostKeyChecking=no
          -o UserKnownHostsFile=/dev/null
          -o ConnectTimeout=5
          -o ConnectionAttempts=3
          -o Port=22
      when: proxy_ip | length > 0

- name: Deploy and Configure Traefik
  hosts: proxy_servers
  become: true

  vars:
    traefik_version: "3.0.0"
    traefik_user: traefik
    traefik_group: traefik
    traefik_config_dir: /etc/traefik
    traefik_log_dir: /var/log/traefik
    sshpiper_version: "1.3.6"
    sshpiper_user: sshpiper
    sshpiper_group: sshpiper
    sshpiper_config_dir: /etc/sshpiper
    repo_root: "{{ playbook_dir | dirname | dirname }}"
    cloudflare_ips_v4_url: "https://www.cloudflare.com/ips-v4"
    cloudflare_ips_v6_url: "https://www.cloudflare.com/ips-v6"

  tasks:
    - name: Create Traefik user
      ansible.builtin.user:
        name: "{{ traefik_user }}"
        system: true
        shell: /bin/false
        home: "{{ traefik_config_dir }}"
        create_home: false

    - name: Create Traefik directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: "{{ traefik_user }}"
        group: "{{ traefik_group }}"
        mode: '0750'
      loop:
        - "{{ traefik_config_dir }}"
        - "{{ traefik_config_dir }}/dynamic"
        - "{{ traefik_log_dir }}"

    - name: Check if Traefik is installed
      ansible.builtin.stat:
        path: /usr/local/bin/traefik
      register: traefik_binary

    - name: Get installed Traefik version
      ansible.builtin.command: /usr/local/bin/traefik version
      register: traefik_installed_version
      when: traefik_binary.stat.exists
      changed_when: false
      failed_when: false

    - name: Download and install Traefik
      when: >-
        not traefik_binary.stat.exists or
        traefik_version not in traefik_installed_version.stdout
      block:
        - name: Download Traefik
          ansible.builtin.get_url:
            url: >-
              https://github.com/traefik/traefik/releases/download/v{{ traefik_version }}/traefik_v{{-
              traefik_version }}_linux_amd64.tar.gz
            dest: /tmp/traefik.tar.gz
            mode: '0644'

        - name: Extract Traefik binary
          ansible.builtin.unarchive:
            src: /tmp/traefik.tar.gz
            dest: /tmp
            remote_src: true

        - name: Install Traefik binary
          ansible.builtin.copy:
            src: /tmp/traefik
            dest: /usr/local/bin/traefik
            owner: root
            group: root
            mode: '0755'
            remote_src: true

        - name: Cleanup download files
          ansible.builtin.file:
            path: "{{ item }}"
            state: absent
          loop:
            - /tmp/traefik.tar.gz
            - /tmp/traefik
            - /tmp/LICENSE.md
            - /tmp/CHANGELOG.md

    - name: Install libcap2-bin for setcap
      ansible.builtin.apt:
        name: libcap2-bin
        state: present

    - name: Set CAP_NET_BIND_SERVICE capability
      ansible.builtin.command: setcap cap_net_bind_service=+ep /usr/local/bin/traefik
      changed_when: false

    - name: Set ownership of config files
      ansible.builtin.file:
        path: "{{ traefik_config_dir }}"
        owner: "{{ traefik_user }}"
        group: "{{ traefik_group }}"
        recurse: true

    - name: Create acme.json file
      ansible.builtin.file:
        path: "{{ traefik_config_dir }}/acme.json"
        state: touch
        owner: "{{ traefik_user }}"
        group: "{{ traefik_group }}"
        mode: '0600'
        modification_time: preserve
        access_time: preserve

    - name: Install Traefik systemd service
      ansible.builtin.template:
        src: "{{ repo_root }}/traefik/traefik.service.j2"
        dest: /etc/systemd/system/traefik.service
        owner: root
        group: root
        mode: '0644'
      notify:
        - Reload systemd
        - Restart traefik

    - name: Create Cloudflare credentials file
      ansible.builtin.copy:
        content: |
          CF_DNS_API_TOKEN={{ cloudflare_api_token }}
        dest: "{{ traefik_config_dir }}/.cloudflare.env"
        owner: "{{ traefik_user }}"
        group: "{{ traefik_group }}"
        mode: '0600'
      when:
        - traefik_acme_dns_provider | default('cloudflare') == 'cloudflare'
        - cloudflare_api_token is defined
        - (cloudflare_api_token | default('') | trim) | length > 0
      no_log: true

    - name: Create RFC2136 credentials file
      ansible.builtin.copy:
        content: |
          RFC2136_NAMESERVER={{ traefik_rfc2136_nameserver }}
          RFC2136_TSIG_ALGORITHM={{ traefik_rfc2136_tsig_algorithm }}
          RFC2136_TSIG_KEY={{ traefik_rfc2136_tsig_key }}
          RFC2136_TSIG_SECRET={{ traefik_rfc2136_tsig_secret }}
        dest: "{{ traefik_config_dir }}/.rfc2136.env"
        owner: "{{ traefik_user }}"
        group: "{{ traefik_group }}"
        mode: '0600'
      when:
        - traefik_acme_dns_provider | default('cloudflare') == 'rfc2136'
        - traefik_rfc2136_tsig_key is defined
        - (traefik_rfc2136_tsig_key | default('') | trim) | length > 0
      no_log: true

    - name: Install apache2-utils for htpasswd
      ansible.builtin.apt:
        name: apache2-utils
        state: present

    - name: Create Traefik auth directory
      ansible.builtin.file:
        path: "{{ traefik_config_dir }}/auth"
        state: directory
        owner: "{{ traefik_user }}"
        group: "{{ traefik_group }}"
        mode: '0750'

    - name: Validate Traefik dashboard credentials are configured (if dashboard enabled)
      ansible.builtin.assert:
        that:
          - (traefik_dashboard_user | default('') | trim) | length > 0
          - (traefik_dashboard_pass | default('') | trim) | length > 0
        fail_msg: |
          ERROR: Traefik dashboard is enabled but credentials are not set!

          Set the environment variables in Semaphore:
            TRAEFIK_DASHBOARD_USER
            TRAEFIK_DASHBOARD_PASS
      when: traefik_dashboard_enabled | default(false)

    - name: Generate dashboard htpasswd entry (dashboard enabled)
      ansible.builtin.command:
        argv:
          - htpasswd
          - -nbB
          - "{{ traefik_dashboard_user }}"
          - "{{ traefik_dashboard_pass }}"
      register: traefik_dashboard_htpasswd
      when: traefik_dashboard_enabled | default(false)
      no_log: true
      changed_when: false

    - name: Write dashboard authentication file (dashboard enabled)
      ansible.builtin.copy:
        dest: "{{ traefik_config_dir }}/auth/dashboard-users"
        content: "{{ traefik_dashboard_htpasswd.stdout }}\n"
        owner: "{{ traefik_user }}"
        group: "{{ traefik_group }}"
        mode: '0600'
      when:
        - traefik_dashboard_enabled | default(false)
        - traefik_dashboard_htpasswd.stdout is defined
        - (traefik_dashboard_htpasswd.stdout | trim) | length > 0
      no_log: true

    - name: Fetch Cloudflare IPv4 ranges
      ansible.builtin.uri:
        url: "{{ cloudflare_ips_v4_url }}"
        return_content: true
      register: cloudflare_ipv4_response
      delegate_to: localhost

    - name: Parse Cloudflare IPv4 ranges
      ansible.builtin.set_fact:
        cloudflare_ipv4_ranges: "{{ cloudflare_ipv4_response.content.splitlines() | select('match', '^[0-9]') | list }}"

    - name: Fetch Cloudflare IPv6 ranges
      ansible.builtin.uri:
        url: "{{ cloudflare_ips_v6_url }}"
        return_content: true
      register: cloudflare_ipv6_response
      delegate_to: localhost

    - name: Parse Cloudflare IPv6 ranges
      ansible.builtin.set_fact:
        cloudflare_ipv6_ranges: "{{ cloudflare_ipv6_response.content.splitlines() | select('match', '^[0-9a-f:]') | list }}"

    - name: Validate RFC2136 credentials are configured
      ansible.builtin.assert:
        that:
          - traefik_rfc2136_tsig_key is defined
          - traefik_rfc2136_tsig_key | length > 0
          - traefik_rfc2136_tsig_secret is defined
          - traefik_rfc2136_tsig_secret | length > 0
        fail_msg: |
          ERROR: RFC2136 TSIG credentials are not set!

          Set the environment variables in Semaphore:
            TRAEFIK_RFC2136_TSIG_KEY: "letsencrypt"
            TRAEFIK_RFC2136_TSIG_SECRET: "your-tsig-secret-here"
            TRAEFIK_RFC2136_NAMESERVER: >-
              "ns1.home.goodkind.io:53" (optional, defaults to this)
            TRAEFIK_RFC2136_TSIG_ALGORITHM: "hmac-sha256." (optional, defaults to this)
        success_msg: "✓ RFC2136 TSIG credentials are configured"
      when: traefik_acme_dns_provider | default('cloudflare') == 'rfc2136'

    - name: Validate Cloudflare API token is configured
      ansible.builtin.assert:
        that:
          - cloudflare_api_token is defined
          - (cloudflare_api_token | default('') | trim) | length > 0
        fail_msg: |
          ERROR: Cloudflare API token is not set!

          Set one of these environment variables in Semaphore:
            CLOUDFLARE_API_TOKEN (preferred)
            CF_DNS_API_TOKEN
        success_msg: "✓ Cloudflare API token is configured"
      when: traefik_acme_dns_provider | default('cloudflare') == 'cloudflare'

    - name: Ensure Cloudflare IP ranges were retrieved
      ansible.builtin.assert:
        that:
          - cloudflare_ipv4_ranges is defined
          - cloudflare_ipv4_ranges | length > 0
          - cloudflare_ipv6_ranges is defined
          - cloudflare_ipv6_ranges | length > 0
        fail_msg: |
          ERROR: Unable to download Cloudflare IP ranges.

          Check controller connectivity to:
            - {{ cloudflare_ips_v4_url }}
            - {{ cloudflare_ips_v6_url }}
        success_msg: "✓ Cloudflare IPv4/IPv6 ranges downloaded"

    - name: Template Traefik static configuration
      ansible.builtin.template:
        src: "{{ repo_root }}/traefik/traefik.yml.j2"
        dest: "{{ traefik_config_dir }}/traefik.yml"
        owner: "{{ traefik_user }}"
        group: "{{ traefik_group }}"
        mode: '0644'
      notify: Restart traefik

    - name: Template Traefik dynamic routes
      ansible.builtin.template:
        src: "{{ repo_root }}/traefik/dynamic/routes.yml.j2"
        dest: "{{ traefik_config_dir }}/dynamic/routes.yml"
        owner: "{{ traefik_user }}"
        group: "{{ traefik_group }}"
        mode: '0644'
      notify: Restart traefik

    - name: Template Traefik dynamic middlewares
      ansible.builtin.template:
        src: "{{ repo_root }}/traefik/dynamic/middlewares.yml.j2"
        dest: "{{ traefik_config_dir }}/dynamic/middlewares.yml"
        owner: "{{ traefik_user }}"
        group: "{{ traefik_group }}"
        mode: '0644'
      notify: Restart traefik

    - name: Enable Traefik service
      ansible.builtin.systemd:
        name: traefik
        enabled: true
        daemon_reload: true

    - name: Flush handlers to ensure Traefik is restarted
      ansible.builtin.meta: flush_handlers

    - name: Wait for Traefik to start
      ansible.builtin.pause:
        seconds: 5

    - name: Verify Traefik service status
      ansible.builtin.systemd:
        name: traefik
      register: traefik_status

    - name: Display Traefik service status
      ansible.builtin.debug:
        msg: "✓ Traefik service is {{ traefik_status.status.ActiveState }}"

    - name: Check Traefik health endpoint
      ansible.builtin.uri:
        url: "http://localhost:80"
        follow_redirects: none
        validate_certs: false
        status_code: [200, 301, 302, 308]
        timeout: 5
      register: health_check
      retries: 3
      delay: 2
      until: health_check.status is defined
      failed_when: false

    - name: Report health check result
      ansible.builtin.debug:
        msg: >-
          {% if health_check.status is defined %}
          ✓ Traefik is responding (HTTP {{ health_check.status }})
          {% else %}
          ⚠ Traefik health check returned: {{ health_check.msg }}
          {% endif %}

  handlers:
    - name: Reload systemd
      ansible.builtin.systemd:
        daemon_reload: true

    - name: Restart traefik
      ansible.builtin.systemd:
        name: traefik
        state: restarted

- name: Deploy and Configure SSHPiper
  hosts: proxy_servers
  become: true
  tags: [sshpiper]

  vars:
    sshpiper_user: sshpiper
    sshpiper_group: sshpiper
    sshpiper_config_dir: /etc/sshpiper
    repo_root: "{{ playbook_dir | dirname | dirname }}"

  tasks:
    - name: Create sshpiper user
      ansible.builtin.user:
        name: "{{ sshpiper_user }}"
        system: true
        shell: /bin/false
        home: "{{ sshpiper_config_dir }}"
        create_home: false

    - name: Create sshpiper directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: "{{ sshpiper_user }}"
        group: "{{ sshpiper_group }}"
        mode: '0750'
      loop:
        - "{{ sshpiper_config_dir }}"

    - name: Get latest sshpiper release version
      ansible.builtin.uri:
        url: https://api.github.com/repos/tg123/sshpiper/releases/latest
        return_content: true
      register: sshpiper_latest_release
      delegate_to: localhost
      become: false

    - name: Set sshpiper version to latest
      ansible.builtin.set_fact:
        sshpiper_version_resolved: >-
          {{ sshpiper_latest_release.json.tag_name | regex_replace('^v', '') }}

    - name: Check if sshpiper is installed
      ansible.builtin.stat:
        path: /usr/local/bin/sshpiperd
      register: sshpiper_binary

    - name: Get installed sshpiper version
      ansible.builtin.shell: >-
        set -o pipefail && /usr/local/bin/sshpiperd --version 2>&1 | head -1
      args:
        executable: /bin/bash
      register: sshpiper_installed_version
      when: sshpiper_binary.stat.exists
      changed_when: false
      failed_when: false

    - name: Download and install sshpiper
      when: >-
        not sshpiper_binary.stat.exists or
        sshpiper_version_resolved not in sshpiper_installed_version.stdout | default('')
      block:
        - name: Download sshpiper
          ansible.builtin.get_url:
            url: >-
              https://github.com/tg123/sshpiper/releases/download/v{{-
              sshpiper_version_resolved }}/sshpiperd_with_plugins_linux_x86_64.tar.gz
            dest: /tmp/sshpiper.tar.gz
            mode: '0644'

        - name: Extract sshpiper
          ansible.builtin.unarchive:
            src: /tmp/sshpiper.tar.gz
            dest: /tmp
            remote_src: true

        - name: Install sshpiper binary
          ansible.builtin.copy:
            src: /tmp/sshpiperd
            dest: /usr/local/bin/sshpiperd
            owner: root
            group: root
            mode: '0755'
            remote_src: true

        - name: Create plugins directory
          ansible.builtin.file:
            path: /usr/local/bin/plugins
            state: directory
            mode: '0755'

        - name: Install yaml plugin
          ansible.builtin.copy:
            src: /tmp/plugins/yaml
            dest: /usr/local/bin/plugins/yaml
            owner: root
            group: root
            mode: '0755'
            remote_src: true

        - name: Cleanup download files
          ansible.builtin.file:
            path: "{{ item }}"
            state: absent
          loop:
            - /tmp/sshpiper.tar.gz
            - /tmp/sshpiperd
            - /tmp/plugins

    - name: Check if upstream keypair exists
      ansible.builtin.stat:
        path: "{{ sshpiper_config_dir }}/upstream_id_ed25519"
      register: upstream_key

    - name: Generate upstream keypair for sshpiper
      ansible.builtin.command:
        argv:
          - ssh-keygen
          - -t
          - ed25519
          - -f
          - "{{ sshpiper_config_dir }}/upstream_id_ed25519"
          - -N
          - ""
          - -C
          - sshpiper-upstream
      when: not upstream_key.stat.exists
      changed_when: true

    - name: Set upstream key permissions
      ansible.builtin.file:
        path: "{{ item }}"
        owner: "{{ sshpiper_user }}"
        group: "{{ sshpiper_group }}"
        mode: '0600'
      loop:
        - "{{ sshpiper_config_dir }}/upstream_id_ed25519"
        - "{{ sshpiper_config_dir }}/upstream_id_ed25519.pub"

    - name: Read sshpiper upstream public key
      ansible.builtin.slurp:
        src: "{{ sshpiper_config_dir }}/upstream_id_ed25519.pub"
      register: sshpiper_upstream_pubkey
      changed_when: false

    - name: Ensure global authorized_keys directory exists
      ansible.builtin.file:
        path: /etc/ssh/authorized_keys.d
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Authorize sshpiper upstream key via global authorized_keys file
      ansible.builtin.copy:
        content: "{{ sshpiper_upstream_pubkey.content | b64decode | trim }}\n"
        dest: /etc/ssh/authorized_keys.d/sshpiper_upstream
        owner: root
        group: root
        mode: '0644'

    - name: Fetch local SSH keys for authorized_keys
      ansible.builtin.set_fact:
        ssh_key_from_file: "{{
          lookup('file', '~/.ssh/id_ed25519.pub', errors='ignore') |
          default('') }}"

    - name: Fetch GitHub SSH keys
      ansible.builtin.get_url:
        url: https://github.com/agoodkind.keys
        dest: /tmp/github_keys
        force: true
      delegate_to: localhost
      become: false

    - name: Read GitHub SSH keys
      ansible.builtin.command: cat /tmp/github_keys
      register: github_keys_content
      delegate_to: localhost
      become: false
      changed_when: false

    - name: Combine SSH keys
      ansible.builtin.set_fact:
        combined_ssh_keys: "{{
          (ssh_key_from_file + '\n' if ssh_key_from_file else '') +
          github_keys_content.stdout }}"

    - name: Create authorized_keys for sshpiper
      ansible.builtin.copy:
        content: "{{ combined_ssh_keys }}\n"
        dest: "{{ sshpiper_config_dir }}/authorized_keys"
        owner: "{{ sshpiper_user }}"
        group: "{{ sshpiper_group }}"
        mode: '0600'

    - name: Template sshpiper routing configuration
      ansible.builtin.template:
        src: "{{ repo_root }}/sshpiper/sshpiperd.yaml.j2"
        dest: "{{ sshpiper_config_dir }}/sshpiperd.yaml"
        owner: "{{ sshpiper_user }}"
        group: "{{ sshpiper_group }}"
        mode: '0600'
      notify: Restart sshpiper

    - name: Configure sshd to listen on port 2222 only
      ansible.builtin.copy:
        dest: /etc/ssh/sshd_config.d/99-sshpiper-port.conf
        mode: '0644'
        content: |
          # Managed by Ansible (deploy-proxy.yml)
          # sshd on port 2222 for direct access
          # sshpiper on port 22 for routing
          Port 2222
      notify: Restart sshd

    - name: Install sshpiper systemd service
      ansible.builtin.copy:
        src: "{{ repo_root }}/sshpiper/sshpiper.service"
        dest: /etc/systemd/system/sshpiper.service
        owner: root
        group: root
        mode: '0644'
      notify:
        - Reload systemd
        - Restart sshpiper

    - name: Enable sshpiper service
      ansible.builtin.systemd:
        name: sshpiper
        enabled: true
        daemon_reload: true

    - name: Flush handlers
      ansible.builtin.meta: flush_handlers

    - name: Wait for sshpiper to start
      ansible.builtin.pause:
        seconds: 3

    - name: Verify sshpiper service status
      ansible.builtin.systemd:
        name: sshpiper
      register: sshpiper_status

    - name: Display sshpiper service status
      ansible.builtin.debug:
        msg: "✓ SSHPiper service is {{ sshpiper_status.status.ActiveState }}"

  handlers:
    - name: Reload systemd
      ansible.builtin.systemd:
        daemon_reload: true

    - name: Restart sshpiper
      ansible.builtin.systemd:
        name: sshpiper
        state: restarted

    - name: Restart sshd
      ansible.builtin.systemd:
        name: ssh
        state: restarted

- name: Deploy and Configure Cloudflared
  hosts: proxy_servers
  become: true

  vars:
    repo_root: "{{ playbook_dir | dirname | dirname }}"

  tasks:
    - name: Install and configure cloudflared
      ansible.builtin.include_tasks: tasks/install-cloudflared.yml

    - name: Verify cloudflared service status
      ansible.builtin.systemd:
        name: cloudflared
      register: cloudflared_status

    - name: Display cloudflared service status
      ansible.builtin.debug:
        msg: "✓ Cloudflared service is {{ cloudflared_status.status.ActiveState }}"

  handlers:
    - name: Restart cloudflared
      ansible.builtin.systemd:
        name: cloudflared
        state: restarted
        daemon_reload: true

- name: Summary
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Display completion message
      ansible.builtin.debug:
        msg: >-
          ✅ Traefik, SSHPiper, and Cloudflared deployed successfully on
          {{ hostvars['localhost'].get('service_hostname', 'proxy.home.goodkind.io') }}
