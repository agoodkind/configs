---
- name: Update Traefik Configuration
  hosts: traefik_servers
  become: true

  vars:
    traefik_config_dir: /etc/traefik
    traefik_user: traefik
    traefik_group: traefik
    repo_root: "{{ playbook_dir | dirname | dirname }}"
    cloudflare_ips_v4_url: "https://www.cloudflare.com/ips-v4"
    cloudflare_ips_v6_url: "https://www.cloudflare.com/ips-v6"

  tasks:
    - name: Fetch Cloudflare IPv4 raw
      ansible.builtin.set_fact:
        cf_ipv4_raw: "{{ lookup('url', cloudflare_ips_v4_url) }}"

    - name: Debug raw content
      ansible.builtin.debug:
        msg:
          - "Raw contains newlines: {{ '\n' in cf_ipv4_raw }}"
          - "Raw length: {{ cf_ipv4_raw | length }}"
          - "First 100 chars: {{ cf_ipv4_raw[:100] }}"

    - name: Fetch Cloudflare IPv4 ranges
      ansible.builtin.set_fact:
        cloudflare_ipv4_ranges: "{{ lookup('url', cloudflare_ips_v4_url).split('\n') | reject('equalto', '') | list }}"

    - name: Fetch Cloudflare IPv6 ranges
      ansible.builtin.set_fact:
        cloudflare_ipv6_ranges: "{{ lookup('url', cloudflare_ips_v6_url).split('\n') | reject('equalto', '') | list }}"

    - name: Debug Cloudflare IP ranges type
      ansible.builtin.debug:
        msg:
          - "IPv4 type: {{ cloudflare_ipv4_ranges | type_debug }}"
          - "IPv4 first item: {{ cloudflare_ipv4_ranges[0] }}"
          - "IPv4 length: {{ cloudflare_ipv4_ranges | length }}"
          - "Split test: {{ cf_ipv4_raw.split('\n') | length }}"

    - name: Validate required variables
      ansible.builtin.assert:
        that:
          - cloudflare_api_token is defined
          - cloudflare_api_token | length > 0
          - cloudflare_api_token != ""
        fail_msg: |
          ERROR: CLOUDFLARE_API_TOKEN is not set!

          Set the environment variable:
            export CLOUDFLARE_API_TOKEN="your-token-here"

          Or in Semaphore Environment settings:
            CLOUDFLARE_API_TOKEN: your-token-here
        success_msg: "✓ Cloudflare API token is configured"

    - name: Ensure Cloudflare IP ranges were retrieved
      ansible.builtin.assert:
        that:
          - cloudflare_ipv4_ranges is defined
          - cloudflare_ipv4_ranges | length > 0
          - cloudflare_ipv6_ranges is defined
          - cloudflare_ipv6_ranges | length > 0
        fail_msg: |
          ERROR: Unable to download Cloudflare IP ranges.

          Check controller connectivity to:
            - {{ cloudflare_ips_v4_url }}
            - {{ cloudflare_ips_v6_url }}
        success_msg: "✓ Cloudflare IPv4/IPv6 ranges downloaded"

    - name: Template Traefik static configuration
      ansible.builtin.template:
        src: "{{ repo_root }}/traefik/traefik.yml.j2"
        dest: "{{ traefik_config_dir }}/traefik.yml"
        owner: "{{ traefik_user }}"
        group: "{{ traefik_group }}"
        mode: '0644'
      notify: Restart traefik

    - name: Template Traefik dynamic routes
      ansible.builtin.template:
        src: "{{ repo_root }}/traefik/dynamic/routes.yml.j2"
        dest: "{{ traefik_config_dir }}/dynamic/routes.yml"
        owner: "{{ traefik_user }}"
        group: "{{ traefik_group }}"
        mode: '0644'

    - name: Template Traefik dynamic middlewares
      ansible.builtin.template:
        src: "{{ repo_root }}/traefik/dynamic/middlewares.yml.j2"
        dest: "{{ traefik_config_dir }}/dynamic/middlewares.yml"
        owner: "{{ traefik_user }}"
        group: "{{ traefik_group }}"
        mode: '0644'

    - name: Flush handlers to ensure Traefik is restarted
      ansible.builtin.meta: flush_handlers

    - name: Wait for Traefik to start
      ansible.builtin.pause:
        seconds: 5

    - name: Verify Traefik service status
      ansible.builtin.systemd:
        name: traefik
      register: traefik_status

    - name: Display Traefik service status
      ansible.builtin.debug:
        msg: "✓ Traefik service is {{ traefik_status.status.ActiveState }}"

    - name: Check Traefik health endpoint
      ansible.builtin.uri:
        url: "http://localhost:80"
        follow_redirects: none
        validate_certs: false
        status_code: [200, 301, 302, 308]
        timeout: 5
      register: health_check
      retries: 3
      delay: 2
      until: health_check.status is defined
      failed_when: false

    - name: Report health check result
      ansible.builtin.debug:
        msg: >-
          {% if health_check.status is defined %}
          ✓ Traefik is responding (HTTP {{ health_check.status }})
          {% else %}
          ⚠ Traefik health check returned: {{ health_check.msg }}
          {% endif %}

  handlers:
    - name: Restart traefik
      ansible.builtin.systemd:
        name: traefik
        state: restarted
