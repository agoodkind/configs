---
- name: Update Traefik Configuration
  hosts: traefik_servers
  become: true

  vars:
    traefik_config_dir: /etc/traefik
    traefik_user: traefik
    traefik_group: traefik
    repo_root: /usr/share/configs
    cloudflare_ips_v4_url: "https://www.cloudflare.com/ips-v4"
    cloudflare_ips_v6_url: "https://www.cloudflare.com/ips-v6"
    cloudflare_ipv4_ranges: "{{ lookup('url', cloudflare_ips_v4_url) | splitlines() }}"
    cloudflare_ipv6_ranges: "{{ lookup('url', cloudflare_ips_v6_url) | splitlines() }}"

  tasks:
    - name: Validate required variables
      assert:
        that:
          - cloudflare_api_token is defined
          - cloudflare_api_token | length > 0
          - cloudflare_api_token != ""
        fail_msg: |
          ERROR: CLOUDFLARE_API_TOKEN is not set!

          Set the environment variable:
            export CLOUDFLARE_API_TOKEN="your-token-here"

          Or in Semaphore Environment settings:
            CLOUDFLARE_API_TOKEN: your-token-here
        success_msg: "✓ Cloudflare API token is configured"

    - name: Ensure Cloudflare IP ranges were retrieved
      assert:
        that:
          - cloudflare_ipv4_ranges is defined
          - cloudflare_ipv4_ranges | length > 0
          - cloudflare_ipv6_ranges is defined
          - cloudflare_ipv6_ranges | length > 0
        fail_msg: |
          ERROR: Unable to download Cloudflare IP ranges.

          Check controller connectivity to:
            - {{ cloudflare_ips_v4_url }}
            - {{ cloudflare_ips_v6_url }}
        success_msg: "✓ Cloudflare IPv4/IPv6 ranges downloaded"

    - name: Pull latest configs from git
      git:
        repo: https://github.com/agoodkind/configs.git
        dest: "{{ repo_root }}"
        version: main
        force: yes
      become: no
      delegate_to: localhost
      run_once: true

    - name: Template Traefik static configuration
      template:
        src: "{{ repo_root }}/traefik/traefik.yml.j2"
        dest: "{{ traefik_config_dir }}/traefik.yml"
        owner: "{{ traefik_user }}"
        group: "{{ traefik_group }}"
        mode: '0644'
        validate: '/usr/local/bin/traefik version || true'
      notify: restart traefik

    - name: Template Traefik dynamic routes
      template:
        src: "{{ repo_root }}/traefik/dynamic/routes.yml.j2"
        dest: "{{ traefik_config_dir }}/dynamic/routes.yml"
        owner: "{{ traefik_user }}"
        group: "{{ traefik_group }}"
        mode: '0644'

    - name: Template Traefik dynamic middlewares
      template:
        src: "{{ repo_root }}/traefik/dynamic/middlewares.yml.j2"
        dest: "{{ traefik_config_dir }}/dynamic/middlewares.yml"
        owner: "{{ traefik_user }}"
        group: "{{ traefik_group }}"
        mode: '0644'

    - name: Validate Traefik configuration
      command: /usr/local/bin/traefik version
      changed_when: false

  handlers:
    - name: restart traefik
      systemd:
        name: traefik
        state: restarted
