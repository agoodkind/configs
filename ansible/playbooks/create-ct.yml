---
- name: Create new LXC container
  hosts: localhost
  gather_facts: false
  vars:
    target_node: vault
    container_hostname: ""
    vmid: ""
    template_storage: "storage"
    template_name: "ubuntu-24.04-standard_24.04-2_amd64.tar.zst"
    disk_size: "8"
    memory: "512"
    cores: "1"
    storage: "local-lvm"
    network_bridge: "vmbr0"
    mac_address: ""
    ip_address: ""
    # Note: If using DHCP, mac_address should be set to ensure stable reservations
    gateway: ""
    ipv6_address: ""
    ipv6_gateway: ""
    ipv4_prefix: "24"
    ipv6_prefix: "64"
    ipv6_only: true
    container_tags: "lxc"
    allow_dhcp: false

  tasks:
    - name: Validate container hostname is set
      ansible.builtin.assert:
        that:
          - container_hostname != ""
          - container_hostname is defined
        fail_msg: >-
          container_hostname must be provided as a variable
          (use -e container_hostname=hostname or pass via vars in import_playbook)
        success_msg: "✓ Container hostname: {{ container_hostname }}"

    - name: Build container name candidates (FQDN + short)
      ansible.builtin.set_fact:
        container_name_candidates: >-
          {{
            [
              container_hostname,
              (container_hostname.split('.')[0] if ('.' in container_hostname) else container_hostname)
            ]
            | unique
          }}

    - name: Debug container name candidates
      ansible.builtin.debug:
        msg: "Container name candidates: {{ container_name_candidates }}"

    - name: Lookup existing CT VMID by hostname
      ansible.builtin.uri:
        url: "https://[{{ proxmox_api_host }}]:8006/api2/json/cluster/resources?type=vm"
        method: GET
        headers:
          Authorization: "PVEAPIToken={{ proxmox_api_user }}!{{ proxmox_token_id }}={{ proxmox_token_secret }}"
        validate_certs: false
        return_content: true
        status_code: [200]
      register: proxmox_cluster_resources
      changed_when: false
      failed_when: false

    - name: Set VMID list fact (if found)
      ansible.builtin.set_fact:
        vmid_list: >-
          {{
            (
              proxmox_cluster_resources.json.data
              | default([])
              | selectattr('type', 'equalto', 'lxc')
              | selectattr('name', 'in', container_name_candidates)
              | selectattr('node', 'equalto', target_node)
              | map(attribute='vmid')
              | list
            )
            | default([])
          }}
      when: proxmox_cluster_resources.json.data is defined

    - name: Select VMID from filtered results
      ansible.builtin.set_fact:
        existing_vmid: "{{ (vmid_list | default([]))[0] if ((vmid_list | default([])) | length > 0) else '' }}"
      when:
        - proxmox_cluster_resources.json.data is defined
        - vmid_list is defined

    - name: Set existing_vmid to empty if not found
      ansible.builtin.set_fact:
        existing_vmid: ""
      when: existing_vmid is not defined

    - name: Debug existing VMID lookup
      ansible.builtin.debug:
        msg: "Existing VMID found: {{ existing_vmid | default('none') }}"

    - name: Read existing container config (if MAC not provided)
      ansible.builtin.command:
        argv:
          - pct
          - config
          - "{{ existing_vmid }}"
      register: existing_pct_config
      delegate_to: "{{ target_node }}"
      when:
        - existing_vmid is defined
        - (existing_vmid | default('') | string | trim) | length > 0
        - (mac_address | default('') | trim) | length == 0
      changed_when: false
      failed_when: false

    - name: Set MAC address from existing container if not provided
      ansible.builtin.set_fact:
        mac_address: >-
          {{
            (existing_pct_config.stdout | default(''))
            | regex_search('(?m)^net0:.*hwaddr=([^,\\n]+)', '\\1')
            | default('')
            | trim
          }}
      when:
        - existing_vmid is defined
        - (existing_vmid | default('') | string | trim) | length > 0
        - (mac_address | default('') | trim) | length == 0
        - existing_pct_config.stdout is defined
        - (existing_pct_config.stdout | default('') | trim) | length > 0

    - name: Debug MAC address preservation
      ansible.builtin.debug:
        msg: >-
          MAC address: {{ mac_address | default('not set') }}
          {% if existing_vmid is defined and (existing_vmid | default('') | string | trim) | length > 0 %}
          (preserved from existing container {{ existing_vmid }})
          {% endif %}
      when:
        - existing_vmid is defined
        - (existing_vmid | default('') | string | trim) | length > 0

    - name: Generate random password
      ansible.builtin.set_fact:
        actual_password: >-
          {{ lookup('password',
             '/dev/null length=20 chars=ascii_letters,digits') }}

    - name: Get next available VMID (if not provided and container not found)
      ansible.builtin.uri:
        url: "https://[{{ proxmox_api_host }}]:8006/api2/json/cluster/nextid"
        method: GET
        headers:
          Authorization: >-
            PVEAPIToken={{ proxmox_api_user }}!{{ proxmox_token_id }}={{-
            proxmox_token_secret }}
        validate_certs: false
        return_content: true
        status_code: [200]
      delegate_to: localhost
      register: next_vmid
      changed_when: false
      when:
        - (vmid | default('') | string | trim) | length == 0
        - (existing_vmid | default('') | string | trim) | length == 0

    - name: Set effective VMID (provided, existing, or nextid)
      ansible.builtin.set_fact:
        actual_vmid: >-
          {{
            (vmid | string | trim)
            if (vmid | default('') | string | trim) | length > 0
            else (
              (existing_vmid | string | trim)
              if (existing_vmid | default('') | string | trim) | length > 0
              else (next_vmid.json.data | default('') | string | trim)
            )
          }}

    - name: Debug VMID selection
      ansible.builtin.debug:
        msg: "Selected VMID: {{ actual_vmid | default('auto-assign') }}"

    - name: Fail if requested VMID conflicts with existing container VMID
      ansible.builtin.assert:
        that:
          - (vmid | default('') | string | trim) | length == 0
            or (existing_vmid | default('') | string | trim) | length == 0
            or (existing_vmid | string | trim) == (vmid | string | trim)
        fail_msg: >-
          Container {{ container_hostname }} already exists with VMID {{ existing_vmid }}.
          You requested vmid={{ vmid }}. Delete/recreate the existing container or
          omit vmid to reuse the current VMID.

    - name: Set container exists flag
      ansible.builtin.set_fact:
        container_already_exists: >-
          {{ (existing_vmid | default('') | string | trim) | length > 0 }}

    - name: Show existing container status
      ansible.builtin.debug:
        msg: >-
          Container {{ container_hostname }} already exists with VMID
          {{ existing_vmid }}. Skipping creation, will configure existing container.
      when: container_already_exists | bool

    - name: Compute default management IPs from VMID (decimal string, not hex)
      ansible.builtin.set_fact:
        default_ipv4_host: "10.250.0.{{ actual_vmid | string | trim }}"
        default_ipv6_host: "3d06:bad:b01::{{ actual_vmid | string | trim }}"

    - name: Set effective IP configuration (defaults, override-able via input vars)
      ansible.builtin.set_fact:
        effective_ipv4_value: >-
          {{
            ''
            if (ipv6_only | default(true) | bool)
            else (
              (ip_address | trim)
              if (ip_address | default('') | trim) | length > 0
              else default_ipv4_host
            )
          }}
        effective_ipv6_value: >-
          {{
            (ipv6_address | trim)
            if (ipv6_address | default('') | trim) | length > 0
            else default_ipv6_host
          }}

    - name: Enforce static addressing for containers (no DHCP by default)
      ansible.builtin.assert:
        that:
          - >-
            allow_dhcp | bool or
            (ipv6_only | default(true) | bool) or
            (effective_ipv4_value | default('') | lower) != 'dhcp'
          - allow_dhcp | bool or (effective_ipv6_value | default('') | lower) != 'dhcp'
        fail_msg: >-
          DHCP is disabled for containers. Provide a static ip_address/ipv6_address
          (or omit them to use the VMID-derived defaults).
          To explicitly allow DHCP for this container, set allow_dhcp=true.
          For IPv6-only containers, set ipv6_only=true.

    - name: Normalize effective IPs (add prefixes unless DHCP or already CIDR)
      ansible.builtin.set_fact:
        effective_ipv4_cidr: >-
          {{
            ''
            if (ipv6_only | default(true) | bool)
            else (
              'dhcp'
              if (effective_ipv4_value | default('') | lower) == 'dhcp'
              else (
                effective_ipv4_value
                if '/' in (effective_ipv4_value | default(''))
                else (effective_ipv4_value ~ '/' ~ (ipv4_prefix | default('24') | string))
              )
            )
          }}
        effective_ipv6_cidr: >-
          {{
            'dhcp'
            if (effective_ipv6_value | default('') | lower) == 'dhcp'
            else (
              effective_ipv6_value
              if '/' in (effective_ipv6_value | default(''))
              else (effective_ipv6_value ~ '/' ~ (ipv6_prefix | default('64') | string))
            )
          }}

    - name: Set effective gateways (defaults, override-able via input vars)
      ansible.builtin.set_fact:
        effective_gateway_v4: >-
          {{
            (gateway | trim)
            if (gateway | default('') | trim) | length > 0
            else ('10.250.0.1' if effective_ipv4_cidr != 'dhcp' else '')
          }}
        effective_gateway_v6: >-
          {{
            (ipv6_gateway | trim)
            if (ipv6_gateway | default('') | trim) | length > 0
            else ('3d06:bad:b01::1' if effective_ipv6_cidr != 'dhcp' else '')
          }}

    - name: Warn if DHCP is used without MAC address
      ansible.builtin.debug:
        msg: >-
          WARNING: Using DHCP without a pinned MAC address. This may cause
          IP address changes if the container is recreated. Consider setting
          mac_address variable for stable container identity.
      when:
        - allow_dhcp | default(false) | bool
        - (effective_ipv4_cidr == 'dhcp' or effective_ipv6_cidr == 'dhcp')
        - (mac_address | default('') | trim) | length == 0

    - name: Validate MAC address format (if provided)
      ansible.builtin.set_fact:
        mac_address_valid: >-
          {{
            (mac_address | default('') | trim | regex_search('^([0-9A-Fa-f]{2}:){5}[0-9A-Fa-f]{2}$'))
            if (mac_address | default('') | trim) | length > 0
            else false
          }}

    - name: Build network interface configuration
      ansible.builtin.set_fact:
        net0_config: >-
          name=eth0,bridge={{ network_bridge -}}
          {{- ',hwaddr=' + mac_address
              if (mac_address_valid | default(false) | bool)
              else '' -}}
          {{- ',ip=' + effective_ipv4_cidr
              if (not (ipv6_only | default(true) | bool) and (effective_ipv4_cidr | length > 0))
              else '' -}}
          {{- ',gw=' + effective_gateway_v4
              if (
                (effective_gateway_v4 | default('') | trim) | length > 0
                and effective_ipv4_cidr != 'dhcp'
                and (effective_ipv4_cidr | length > 0)
              ) else '' -}}
          ,ip6={{ effective_ipv6_cidr -}}
          {{- ',gw6=' + effective_gateway_v6
              if (
                (effective_gateway_v6 | default('') | trim) | length > 0
                and effective_ipv6_cidr != 'dhcp'
              ) else '' -}}

    - name: Debug network interface configuration
      ansible.builtin.debug:
        msg:
          - "Network bridge: {{ network_bridge }}"
          - "MAC address: {{ mac_address | default('auto') }}"
          - "IPv4: {{ effective_ipv4_cidr }}"
          - "IPv6: {{ effective_ipv6_cidr }}"
          - "net0 config: {{ net0_config }}"

    - name: Get SSH public keys from GitHub
      ansible.builtin.uri:
        url: https://github.com/agoodkind.keys
        return_content: true
      register: github_keys
      delegate_to: localhost

    - name: Check if controller ~/.ssh exists
      ansible.builtin.stat:
        path: "{{ lookup('env', 'HOME') }}/.ssh"
      register: controller_ssh_dir
      delegate_to: localhost
      changed_when: false

    - name: Find controller SSH public keys
      ansible.builtin.find:
        paths: "{{ lookup('env', 'HOME') }}/.ssh"
        patterns: "id_*.pub"
      register: ssh_key_files
      delegate_to: localhost
      when:
        - controller_ssh_dir.stat.exists | default(false)
        - controller_ssh_dir.stat.isdir | default(false)

    - name: Get controller SSH public key
      ansible.builtin.slurp:
        src: "{{ ssh_key_files.files[0].path }}"
      register: ansible_key
      delegate_to: localhost
      when:
        - ssh_key_files is defined
        - ssh_key_files.files | default([]) | length > 0

    - name: Combine all SSH keys
      ansible.builtin.set_fact:
        all_ssh_keys: >-
          {{- (github_keys.content | default('')) if (github_keys is defined
          and github_keys.content is defined) else '' -}}
          {{- (ansible_key.content | b64decode) if (ssh_key_files is defined
          and (ssh_key_files.files | default([]) | length > 0)
          and ansible_key is defined and ansible_key.content is defined)
          else '' -}}

    - name: Create LXC container
      community.proxmox.proxmox:
        api_host: "{{ proxmox_api_host }}"
        api_user: "{{ proxmox_api_user }}"
        api_token_id: "{{ proxmox_token_id }}"
        api_token_secret: "{{ proxmox_token_secret }}"
        validate_certs: false
        node: "{{ target_node }}"
        hostname: "{{ container_hostname }}"
        vmid: >-
          {{
            (actual_vmid | int)
            if (actual_vmid | default('') | trim) | length > 0
            else omit
          }}
        ostemplate: "storage:vztmpl/{{ template_name }}"
        password: "{{ actual_password }}"
        pubkey: "{{ all_ssh_keys }}"
        disk: "local-lvm:{{ disk_size }}"
        memory: "{{ memory }}"
        cores: "{{ cores }}"
        netif: "{{ {'net0': net0_config} }}"
        onboot: true
        unprivileged: true
        state: present
        tags: "{{ container_tags.split(',') }}"
      delegate_to: localhost
      register: container_result
      when: not (container_already_exists | default(false) | bool)

    - name: Set container result for existing container
      ansible.builtin.set_fact:
        container_result:
          changed: false
          msg: "Container already exists"
          vmid: "{{ existing_vmid }}"
        effective_vmid: "{{ existing_vmid }}"
      when: container_already_exists | default(false) | bool

    - name: Set effective VMID from container result or actual
      ansible.builtin.set_fact:
        effective_vmid: >-
          {{
            (container_result.vmid | string | trim)
            if (container_result is defined and container_result.vmid is defined)
            else (actual_vmid | default('') | string | trim)
          }}

    - name: Debug container creation result
      ansible.builtin.debug:
        msg:
          - "Container created/updated: {{ container_result.changed | default(false) }}"
          - "Container VMID: {{ container_result.vmid | default(actual_vmid | default('auto-assign')) }}"
          - "Container hostname: {{ container_hostname }}"
          - "Container tags: {{ container_tags.split(',') }}"

    - name: Start container
      community.proxmox.proxmox:
        api_host: "{{ proxmox_api_host }}"
        api_user: "{{ proxmox_api_user }}"
        api_token_id: "{{ proxmox_token_id }}"
        api_token_secret: "{{ proxmox_token_secret }}"
        validate_certs: false
        node: "{{ target_node }}"
        hostname: "{{ container_hostname }}"
        vmid: >-
          {{
            (container_result.vmid | int)
            if (container_result.vmid is defined)
            else (
              (actual_vmid | int)
              if (actual_vmid | default('') | trim) | length > 0
              else omit
            )
          }}
        state: started
      delegate_to: localhost

    - name: Wait for pct exec to be ready
      ansible.builtin.command:
        argv:
          - pct
          - exec
          - "{{ effective_vmid }}"
          - --
          - /bin/true
      delegate_to: "{{ target_node }}"
      register: pct_exec_ready
      changed_when: false
      retries: 30
      delay: 1
      until: pct_exec_ready is succeeded

    - name: Wait for container to get network interfaces
      ansible.builtin.uri:
        url: >-
          https://[{{ proxmox_api_host }}]:8006/api2/json/nodes/{{ target_node -}}/lxc/{{-
          effective_vmid }}/interfaces
        method: GET
        headers:
          Authorization: >-
            PVEAPIToken={{ proxmox_api_user }}!{{ proxmox_token_id }}={{-
            proxmox_token_secret }}
        validate_certs: false
        return_content: true
        status_code: [200]
      register: container_boot_check
      delegate_to: localhost
      changed_when: false
      failed_when: false
      retries: 20
      delay: 1
      until: >-
        container_boot_check.json is defined and
        container_boot_check.json.data is defined and
        (container_boot_check.json.data | length) > 1 and
        (container_boot_check.json.data | selectattr('name', 'equalto', 'eth0') | list | length) > 0

    - name: Fetch container network interfaces (discover IPs)
      ansible.builtin.uri:
        url: >-
          https://[{{ proxmox_api_host }}]:8006/api2/json/nodes/{{ target_node -}}/lxc/{{-
          effective_vmid }}/interfaces
        method: GET
        headers:
          Authorization: >-
            PVEAPIToken={{ proxmox_api_user }}!{{ proxmox_token_id }}={{-
            proxmox_token_secret }}
        validate_certs: false
        return_content: true
        status_code: [200]
      register: container_interfaces
      delegate_to: localhost
      changed_when: false
      retries: 30
      delay: 5
      until: >-
        container_interfaces.json is defined and
        container_interfaces.json.data is defined and
        (container_interfaces.json.data | length) > 0

    - name: Debug raw container interfaces API response
      ansible.builtin.debug:
        msg:
          - "Container interfaces API response:"
          - "{{ container_interfaces.json | default('NOT_DEFINED') }}"

    - name: Extract non-loopback IP addresses
      ansible.builtin.set_fact:
        all_ip_addresses: >-
          {{
            container_interfaces.json.data
            | default([])
            | rejectattr('name', 'equalto', 'lo')
            | map(attribute='ip-addresses')
            | select('defined')
            | flatten
            | list
          }}

    - name: Gather container IP candidates (v4/v6)
      ansible.builtin.set_fact:
        container_ipv4_candidates: >-
          {{
            all_ip_addresses
            | selectattr('ip-address-type', 'equalto', 'inet')
            | map(attribute='ip-address')
            | reject('equalto', '127.0.0.1')
            | list
            | unique
          }}
        container_ipv6_candidates: >-
          {{
            all_ip_addresses
            | selectattr('ip-address-type', 'equalto', 'inet6')
            | map(attribute='ip-address')
            | reject('equalto', '::1')
            | list
            | unique
          }}

    - name: Debug IP candidates
      ansible.builtin.debug:
        msg:
          - "IPv4 candidates: {{ container_ipv4_candidates }}"
          - "IPv6 candidates: {{ container_ipv6_candidates }}"

    - name: Select container IP for SSH (first global IPv6, else IPv4)
      ansible.builtin.set_fact:
        filtered_ipv6: >-
          {{
            container_ipv6_candidates
            | reject('match', '^fe80:')
            | reject('equalto', '::1')
            | list
          }}
        filtered_ipv4: >-
          {{
            container_ipv4_candidates
            | reject('equalto', '127.0.0.1')
            | list
          }}

    - name: Select container primary IP from filtered candidates
      ansible.builtin.set_fact:
        container_primary_ip: >-
          {{
            filtered_ipv6[0]
            if (filtered_ipv6 | length > 0)
            else (
              filtered_ipv4[0]
              if (filtered_ipv4 | length > 0)
              else ''
            )
          }}

    - name: Debug filtered IP candidates and selection
      ansible.builtin.debug:
        msg:
          - "Filtered IPv6 candidates: {{ filtered_ipv6 }}"
          - "Filtered IPv4 candidates: {{ filtered_ipv4 }}"
          - "Selected primary IP: {{ container_primary_ip }}"

    - name: Ensure container IP was discovered
      ansible.builtin.assert:
        that:
          - container_primary_ip is defined
          - container_primary_ip | string | trim | length > 0
        fail_msg: >-
          Unable to discover an IP address for {{ container_hostname }}
          (VMID {{ effective_vmid | default('unknown') }}) from Proxmox.
          This usually means DHCP hasn't assigned an address yet or the CT
          is not attached to the expected bridge ({{ network_bridge }}).
      when: not ansible_check_mode

    - name: Display container info
      ansible.builtin.debug:
        msg:
          - >-
            Container {{ container_hostname }} created with VMID:
            {{ effective_vmid | default('unknown') }}
          - >-
            Ansible will connect to {{ container_hostname }} via
            {{ container_primary_ip }}

    - name: Add container to in-memory inventory
      ansible.builtin.add_host:
        name: "{{ container_hostname }}"
        groups: new_containers
        ansible_host: "{{ container_primary_ip }}"
        ansible_user: root
        ansible_ssh_common_args: >-
          -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null
        ansible_proxmox_vmid: "{{ effective_vmid | default('') }}"
        ansible_proxmox_host: "{{ target_node }}"

- name: Prepare new container (deploy keys and initialize)
  import_playbook: prep-guests.yml
  vars:
    target_hosts: new_containers
    ipv6_only: "{{ ipv6_only | default(true) | bool }}"

- name: Summary
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Display completion message
      ansible.builtin.debug:
        msg: >-
          ✅ Container
          {{ hostvars[groups['new_containers'][0]].inventory_hostname }}
          created and prepped successfully!
