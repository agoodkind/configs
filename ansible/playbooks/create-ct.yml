---
- name: Create new LXC container
  hosts: localhost
  gather_facts: false
  vars:
    target_node: vault
    container_hostname: ""
    vmid: ""
    template_storage: "storage"
    template_name: "ubuntu-24.04-standard_24.04-2_amd64.tar.zst"
    disk_size: "8"
    memory: "512"
    cores: "1"
    storage: "local-lvm"
    network_bridge: "vmbr0"
    mac_address: ""
    ip_address: "dhcp"
    gateway: ""
    ipv6_address: "dhcp"
    ipv6_gateway: ""
    container_tags: "lxc"

  tasks:
    - name: Validate container hostname is set
      ansible.builtin.assert:
        that:
          - container_hostname != ""
          - container_hostname is defined
        fail_msg: >-
          container_hostname must be provided as a variable
          (use -e container_hostname=hostname or pass via vars in import_playbook)
        success_msg: "✓ Container hostname: {{ container_hostname }}"

    - name: Build container name candidates (FQDN + short)
      ansible.builtin.set_fact:
        container_name_candidates: >-
          {{
            [
              container_hostname,
              (container_hostname.split('.')[0] if ('.' in container_hostname) else container_hostname)
            ]
            | unique
          }}

    - name: Lookup existing CT VMID by hostname (best-effort)
      ansible.builtin.uri:
        url: "https://{{ proxmox_api_host }}:8006/api2/json/cluster/resources?type=vm"
        method: GET
        headers:
          Authorization: >-
            PVEAPIToken={{ proxmox_api_user }}!{{ proxmox_token_id }}={{ proxmox_token_secret }}
        validate_certs: false
        return_content: true
        status_code: [200]
      register: proxmox_cluster_resources
      changed_when: false
      failed_when: false

    - name: Set existing VMID fact (if found)
      ansible.builtin.set_fact:
        existing_vmid: >-
          {{
            (
              proxmox_cluster_resources.json.data
              | default([])
              | selectattr('type', 'equalto', 'lxc')
              | selectattr('name', 'in', container_name_candidates)
              | selectattr('node', 'equalto', target_node)
              | map(attribute='vmid')
              | list
              | first
            )
            | default('', true)
          }}
      when: proxmox_cluster_resources.json is defined

    - name: Generate random password
      ansible.builtin.set_fact:
        actual_password: >-
          {{ lookup('password',
             '/dev/null length=20 chars=ascii_letters,digits') }}

    - name: Set VMID if not provided
      ansible.builtin.set_fact:
        actual_vmid: "{{ (vmid if vmid != '' else (existing_vmid | default(''))) }}"
      when: (vmid != "") or ((existing_vmid | default('')) | string | length > 0)

    - name: Build network interface configuration
      ansible.builtin.set_fact:
        net0_config: >-
          name=eth0,bridge={{ network_bridge
          }}{{ ',hwaddr=' + mac_address if (mac_address | default('') | trim) | length > 0 else ''
          }},ip={{ ip_address
          }}{{ ',gw=' + gateway if gateway and ip_address != 'dhcp' else ''
          }},ip6={{ ipv6_address
          }}{{ ',gw6=' + ipv6_gateway
            if ipv6_gateway and ipv6_address != 'dhcp' else '' }}

    - name: Get SSH public keys from GitHub
      ansible.builtin.uri:
        url: https://github.com/agoodkind.keys
        return_content: true
      register: github_keys
      delegate_to: localhost

    - name: Find ansible server's SSH public key
      ansible.builtin.find:
        paths: ~/.ssh
        patterns: "id_*.pub"
      register: ssh_key_files
      delegate_to: ansible.home.goodkind.io

    - name: Get ansible server's SSH public key
      ansible.builtin.slurp:
        src: "{{ ssh_key_files.files[0].path }}"
      register: ansible_key
      delegate_to: ansible.home.goodkind.io
      when: ssh_key_files.files | length > 0

    - name: Combine all SSH keys
      ansible.builtin.set_fact:
        all_ssh_keys: >-
          {{ github_keys.content }}{{ (ansible_key.content | b64decode)
             if (ssh_key_files.files | length > 0) else '' }}

    - name: Create LXC container
      community.proxmox.proxmox:
        api_host: "{{ proxmox_api_host }}"
        api_user: "{{ proxmox_api_user }}"
        api_token_id: "{{ proxmox_token_id }}"
        api_token_secret: "{{ proxmox_token_secret }}"
        validate_certs: false
        node: "{{ target_node }}"
        hostname: "{{ container_hostname }}"
        vmid: "{{ actual_vmid | default(omit) }}"
        ostemplate: "storage:vztmpl/{{ template_name }}"
        password: "{{ actual_password }}"
        pubkey: "{{ all_ssh_keys }}"
        disk: "local-lvm:{{ disk_size }}"
        memory: "{{ memory }}"
        cores: "{{ cores }}"
        netif: "{{ {'net0': net0_config} }}"
        features:
          - nesting=1
        onboot: true
        unprivileged: true
        state: present
        tags: "{{ container_tags.split(',') }}"
      delegate_to: ansible.home.goodkind.io
      register: container_result

    - name: Start container
      community.proxmox.proxmox:
        api_host: "{{ proxmox_api_host }}"
        api_user: "{{ proxmox_api_user }}"
        api_token_id: "{{ proxmox_token_id }}"
        api_token_secret: "{{ proxmox_token_secret }}"
        validate_certs: false
        node: "{{ target_node }}"
        hostname: "{{ container_hostname }}"
        vmid: "{{ container_result.vmid }}"
        state: started
      delegate_to: ansible.home.goodkind.io

    - name: Wait for container to start
      ansible.builtin.pause:
        seconds: 15

    - name: Fetch container network interfaces (discover IPs)
      ansible.builtin.uri:
        url: >-
          https://{{ proxmox_api_host }}:8006/api2/json/nodes/{{
          target_node }}/lxc/{{ container_result.vmid }}/interfaces
        method: GET
        headers:
          Authorization: >-
            PVEAPIToken={{ proxmox_api_user }}!{{ proxmox_token_id }}={{ proxmox_token_secret }}
        validate_certs: false
        return_content: true
        status_code: [200]
      register: container_interfaces
      delegate_to: ansible.home.goodkind.io
      changed_when: false
      retries: 20
      delay: 3
      until: >-
        container_interfaces.json is defined and
        container_interfaces.json.data is defined and
        (container_interfaces.json.data | length) > 0

    - name: Gather container IP candidates (v4/v6)
      ansible.builtin.set_fact:
        container_ipv4_candidates: >-
          {{
            (
              container_interfaces.json.data
              | default([])
              | map(attribute='inet')
              | select('defined')
              | list
              | flatten
              | map(attribute='address')
              | select('defined')
              | list
            )
          }}
        container_ipv6_candidates: >-
          {{
            (
              container_interfaces.json.data
              | default([])
              | map(attribute='inet6')
              | select('defined')
              | list
              | flatten
              | map(attribute='address')
              | select('defined')
              | list
            )
          }}

    - name: Select container IP for SSH (prefer global IPv6)
      ansible.builtin.set_fact:
        filtered_ipv6: >-
          {{
            container_ipv6_candidates
            | reject('match', '^fe80:')
            | reject('equalto', '::1')
            | list
          }}
        filtered_ipv4: >-
          {{
            container_ipv4_candidates
            | reject('equalto', '127.0.0.1')
            | list
          }}

    - name: Select container primary IP from filtered candidates
      ansible.builtin.set_fact:
        container_primary_ip: >-
          {{
            (
              filtered_ipv6[0]
              if (filtered_ipv6 | length > 0)
              else (
                filtered_ipv4[0]
                if (filtered_ipv4 | length > 0)
                else ''
              )
            )
          }}

    - name: Ensure container IP was discovered
      ansible.builtin.assert:
        that:
          - container_primary_ip is defined
          - container_primary_ip | string | trim | length > 0
        fail_msg: >-
          Unable to discover an IP address for {{ container_hostname }}
          (VMID {{ container_result.vmid }}) from Proxmox.
          This usually means DHCP hasn't assigned an address yet or the CT
          is not attached to the expected bridge ({{ network_bridge }}).

    - name: Display container info
      ansible.builtin.debug:
        msg:
          - >-
            Container {{ container_hostname }} created with VMID:
            {{ container_result.vmid }}
          - >-
            Ansible will connect to {{ container_hostname }} via
            {{ container_primary_ip }}

    - name: Add container to in-memory inventory
      ansible.builtin.add_host:
        name: "{{ container_hostname }}"
        groups: new_containers
        ansible_host: "{{ container_primary_ip }}"
        ansible_user: root
        ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
        ansible_proxmox_vmid: "{{ container_result.vmid }}"
        ansible_proxmox_host: "{{ target_node }}"

- name: Initialize new container
  hosts: new_containers
  gather_facts: false
  tasks:
    - name: Wait for SSH to be ready
      ansible.builtin.wait_for_connection:
        timeout: 45
        delay: 3
        sleep: 2

    - name: SSH connection established
      ansible.builtin.debug:
        msg: "✓ SSH connection to {{ inventory_hostname }} is ready"

- name: Pre-flight check before prep-cts
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Announce prep-cts start
      ansible.builtin.debug:
        msg: "Starting container preparation (prep-cts) on new container(s)..."

- name: Run prep-cts on new container
  import_playbook: prep-cts.yml
  vars:
    target_hosts: new_containers

- name: Summary
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Display completion message
      ansible.builtin.debug:
        msg: >-
          ✅ Container
          {{ hostvars[groups['new_containers'][0]].inventory_hostname }}
          created and prepped successfully!
