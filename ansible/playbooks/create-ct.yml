---
- name: Create new LXC container
  hosts: localhost
  gather_facts: false
  vars:
    target_node: vault
    vmid: ""
    template_storage: "storage"
    template_name: "debian-13-standard_13.1-2_amd64.tar.zst"
    disk_size: "8"
    memory: "512"
    cores: "1"
    storage: "local-lvm"
    network_bridge: "vmbr0"
    ip_address: "dhcp"
    gateway: ""
    ipv6_address: "dhcp"
    ipv6_gateway: ""
    container_tags: "lxc"
  vars_prompt:
    - name: container_hostname
      prompt: "Container hostname"
      private: false

  tasks:
    - name: Generate random password
      set_fact:
        actual_password: "{{ lookup('password', '/dev/null length=20 chars=ascii_letters,digits') }}"

    - name: Set VMID if not provided
      set_fact:
        actual_vmid: "{{ vmid }}"
      when: vmid != ""

    - name: Build network interface configuration
      set_fact:
        net0_config: >-
          name=eth0,bridge={{ network_bridge }},ip={{ ip_address
          }}{{ ',gw=' + gateway if gateway and ip_address != 'dhcp' else ''
          }},ip6={{ ipv6_address
          }}{{ ',gw6=' + ipv6_gateway if ipv6_gateway and ipv6_address != 'dhcp' else '' }}

    - name: Get SSH public keys from GitHub
      uri:
        url: https://github.com/agoodkind.keys
        return_content: yes
      register: github_keys
      delegate_to: localhost

    - name: Get ansible server's SSH public key
      slurp:
        src: "{{ lookup('fileglob', '~/.ssh/id_*.pub', wantlist=True) | first }}"
      register: ansible_key
      delegate_to: ansible.home.goodkind.io

    - name: Combine all SSH keys
      set_fact:
        all_ssh_keys: "{{ github_keys.content }}{{ ansible_key.content | b64decode }}"

    - name: Create LXC container
      community.proxmox.proxmox:
        api_host: "{{ proxmox_api_host }}"
        api_user: "{{ proxmox_api_user }}"
        api_token_id: "{{ proxmox_token_id }}"
        api_token_secret: "{{ proxmox_token_secret }}"
        validate_certs: false
        node: "{{ target_node }}"
        hostname: "{{ container_hostname }}"
        vmid: "{{ actual_vmid | default(omit) }}"
        ostemplate: "storage:vztmpl/debian-13-standard_13.1-2_amd64.tar.zst"
        password: "{{ actual_password }}"
        pubkey: "{{ all_ssh_keys }}"
        disk: "local-lvm:8"
        memory: 512
        cores: 1
        netif: "{{ {'net0': net0_config} }}"
        features:
          - nesting=1
        onboot: true
        unprivileged: true
        state: present
        tags: "{{ container_tags.split(',') }}"
      delegate_to: ansible.home.goodkind.io
      register: container_result

    - name: Display container info
      debug:
        msg: 
          - "Container created with VMID: {{ container_result.vmid }}"
          - "Root password: {{ actual_password }}"

    - name: Start container
      community.proxmox.proxmox:
        api_host: "{{ proxmox_api_host }}"
        api_user: "{{ proxmox_api_user }}"
        api_token_id: "{{ proxmox_token_id }}"
        api_token_secret: "{{ proxmox_token_secret }}"
        validate_certs: false
        node: "{{ target_node }}"
        hostname: "{{ container_hostname }}"
        vmid: "{{ container_result.vmid }}"
        state: started
      delegate_to: ansible.home.goodkind.io

    - name: Wait for container to start and get IP from DHCP
      pause:
        seconds: 15

    - name: Get container IP address
      shell: "pct exec {{ container_result.vmid }} -- hostname -I | awk '{print $1}'"
      register: container_ip
      delegate_to: "{{ target_node }}"
      retries: 6
      delay: 5
      until: container_ip.stdout != ""

    - name: Add container to in-memory inventory
      add_host:
        name: "{{ container_hostname }}"
        groups: new_containers
        ansible_host: "{{ container_ip.stdout | trim if ip_address == 'dhcp' else ip_address.split('/')[0] }}"
        ansible_user: root
        ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
        ansible_proxmox_vmid: "{{ container_result.vmid }}"
        ansible_proxmox_host: "{{ target_node }}"

- name: Initialize new container
  hosts: new_containers
  gather_facts: false
  tasks:
    - name: Wait for SSH to be ready
      wait_for_connection:
        timeout: 45
        delay: 3
        sleep: 2

- name: Run prep-cts on new container
  import_playbook: prep-cts.yml
  vars:
    target_hosts: new_containers

- name: Summary
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Display completion message
      debug:
        msg: "âœ… Container {{ hostvars[groups['new_containers'][0]].inventory_hostname }} created and prepped successfully!"

