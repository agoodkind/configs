---
- name: Create new LXC container
  hosts: localhost
  gather_facts: false
  vars:
    target_node: vault
    container_hostname: ""
    vmid: ""
    template_storage: "storage"
    template_name: "ubuntu-24.04-standard_24.04-2_amd64.tar.zst"
    disk_size: "8"
    memory: "512"
    cores: "1"
    storage: "local-lvm"
    network_bridge: "vmbr0"
    mac_address: ""
    ip_address: "dhcp"
    # Note: If using DHCP, mac_address should be set to ensure stable reservations
    gateway: ""
    ipv6_address: "dhcp"
    ipv6_gateway: ""
    container_tags: "lxc"

  tasks:
    - name: Validate container hostname is set
      ansible.builtin.assert:
        that:
          - container_hostname != ""
          - container_hostname is defined
        fail_msg: >-
          container_hostname must be provided as a variable
          (use -e container_hostname=hostname or pass via vars in import_playbook)
        success_msg: "✓ Container hostname: {{ container_hostname }}"

    - name: Build container name candidates (FQDN + short)
      ansible.builtin.set_fact:
        container_name_candidates: >-
          {{
            [
              container_hostname,
              (container_hostname.split('.')[0] if ('.' in container_hostname) else container_hostname)
            ]
            | unique
          }}

    - name: Debug container name candidates
      ansible.builtin.debug:
        msg: "Container name candidates: {{ container_name_candidates }}"

    - name: Lookup existing CT VMID by hostname (best-effort)
      ansible.builtin.uri:
        url: "https://{{ proxmox_api_host }}:8006/api2/json/cluster/resources?type=vm"
        method: GET
        headers:
          Authorization: "PVEAPIToken={{ proxmox_api_user }}!{{ proxmox_token_id }}={{ proxmox_token_secret }}"
        validate_certs: false
        return_content: true
        status_code: [200]
      register: proxmox_cluster_resources
      changed_when: false
      failed_when: false

    - name: Set VMID list fact (if found)
      ansible.builtin.set_fact:
        vmid_list: >-
          {{
            (
              proxmox_cluster_resources.json.data
              | default([])
              | selectattr('type', 'equalto', 'lxc')
              | selectattr('name', 'in', container_name_candidates)
              | selectattr('node', 'equalto', target_node)
              | map(attribute='vmid')
              | list
            )
            | default([])
          }}
      when: proxmox_cluster_resources.json.data is defined

    - name: Select VMID from filtered results
      ansible.builtin.set_fact:
        existing_vmid: "{{ (vmid_list | default([]))[0] if ((vmid_list | default([])) | length > 0) else '' }}"
      when:
        - proxmox_cluster_resources.json.data is defined
        - vmid_list is defined

    - name: Debug existing VMID lookup
      ansible.builtin.debug:
        msg: "Existing VMID found: {{ existing_vmid | default('none') }}"

    - name: Extract MAC address from existing container (if MAC not provided)
      ansible.builtin.shell: |
        set -o pipefail
        pct config {{ existing_vmid }} | grep '^net0:' | sed -n 's/.*hwaddr=\([^,]*\).*/\1/p' || echo ''
      args:
        executable: /bin/bash
      register: existing_mac_output
      delegate_to: "{{ target_node }}"
      when:
        - existing_vmid is defined
        - (existing_vmid | default('') | string | trim) | length > 0
        - (mac_address | default('') | trim) | length == 0
      changed_when: false
      failed_when: false

    - name: Set MAC address from existing container if not provided
      ansible.builtin.set_fact:
        mac_address: "{{ existing_mac_output.stdout | default('') | trim }}"
      when:
        - existing_vmid is defined
        - (existing_vmid | default('') | string | trim) | length > 0
        - (mac_address | default('') | trim) | length == 0
        - existing_mac_output.stdout is defined
        - (existing_mac_output.stdout | default('') | trim) | length > 0

    - name: Debug MAC address preservation
      ansible.builtin.debug:
        msg: >-
          MAC address: {{ mac_address | default('not set') }}
          {% if existing_vmid is defined and (existing_vmid | default('') | string | trim) | length > 0 %}
          (preserved from existing container {{ existing_vmid }})
          {% endif %}
      when:
        - existing_vmid is defined
        - (existing_vmid | default('') | string | trim) | length > 0

    - name: Generate random password
      ansible.builtin.set_fact:
        actual_password: >-
          {{ lookup('password',
             '/dev/null length=20 chars=ascii_letters,digits') }}

    - name: Set VMID if not provided
      ansible.builtin.set_fact:
        actual_vmid: "{{ (vmid if vmid != '' else (existing_vmid | default(''))) }}"
      when: (vmid != "") or ((existing_vmid | default('')) | string | length > 0)

    - name: Debug VMID selection
      ansible.builtin.debug:
        msg: "Selected VMID: {{ actual_vmid | default('auto-assign') }}"

    - name: Warn if DHCP is used without MAC address
      ansible.builtin.debug:
        msg: >-
          WARNING: Using DHCP without a pinned MAC address. This may cause
          IP address changes if the container is recreated. Consider setting
          mac_address variable for stable DHCP reservations.
      when:
        - (ip_address == 'dhcp' or ipv6_address == 'dhcp')
        - (mac_address | default('') | trim) | length == 0

    - name: Build network interface configuration
      ansible.builtin.set_fact:
        net0_config: >-
          name=eth0,bridge={{ network_bridge
          }}{{ ',hwaddr=' + mac_address if (mac_address | default('') | trim) | length > 0 else ''
          }},ip={{ ip_address
          }}{{ ',gw=' + gateway if gateway and ip_address != 'dhcp' else ''
          }},ip6={{ ipv6_address
          }}{{ ',gw6=' + ipv6_gateway
            if ipv6_gateway and ipv6_address != 'dhcp' else '' }}

    - name: Debug network interface configuration
      ansible.builtin.debug:
        msg:
          - "Network bridge: {{ network_bridge }}"
          - "MAC address: {{ mac_address | default('auto') }}"
          - "IPv4: {{ ip_address }}"
          - "IPv6: {{ ipv6_address }}"
          - "net0 config: {{ net0_config }}"

    - name: Get SSH public keys from GitHub
      ansible.builtin.uri:
        url: https://github.com/agoodkind.keys
        return_content: true
      register: github_keys
      delegate_to: localhost

    - name: Find ansible server's SSH public key
      ansible.builtin.find:
        paths: ~/.ssh
        patterns: "id_*.pub"
      register: ssh_key_files
      delegate_to: ansible.home.goodkind.io

    - name: Get ansible server's SSH public key
      ansible.builtin.slurp:
        src: "{{ ssh_key_files.files[0].path }}"
      register: ansible_key
      delegate_to: ansible.home.goodkind.io
      when: ssh_key_files.files | length > 0

    - name: Combine all SSH keys
      ansible.builtin.set_fact:
        all_ssh_keys: >-
          {{ github_keys.content }}{{ (ansible_key.content | b64decode)
             if (ssh_key_files.files | length > 0) else '' }}

    - name: Create LXC container
      community.proxmox.proxmox:
        api_host: "{{ proxmox_api_host }}"
        api_user: "{{ proxmox_api_user }}"
        api_token_id: "{{ proxmox_token_id }}"
        api_token_secret: "{{ proxmox_token_secret }}"
        validate_certs: false
        node: "{{ target_node }}"
        hostname: "{{ container_hostname }}"
        vmid: "{{ actual_vmid | default(omit) }}"
        ostemplate: "storage:vztmpl/{{ template_name }}"
        password: "{{ actual_password }}"
        pubkey: "{{ all_ssh_keys }}"
        disk: "local-lvm:{{ disk_size }}"
        memory: "{{ memory }}"
        cores: "{{ cores }}"
        netif: "{{ {'net0': net0_config} }}"
        features:
          - nesting=1
        onboot: true
        unprivileged: true
        state: present
        tags: "{{ container_tags.split(',') }}"
      delegate_to: ansible.home.goodkind.io
      register: container_result

    - name: Debug container creation result
      ansible.builtin.debug:
        msg:
          - "Container created/updated: {{ container_result.changed | default(false) }}"
          - "Container VMID: {{ container_result.vmid }}"
          - "Container hostname: {{ container_hostname }}"
          - "Container tags: {{ container_tags.split(',') }}"

    - name: Start container
      community.proxmox.proxmox:
        api_host: "{{ proxmox_api_host }}"
        api_user: "{{ proxmox_api_user }}"
        api_token_id: "{{ proxmox_token_id }}"
        api_token_secret: "{{ proxmox_token_secret }}"
        validate_certs: false
        node: "{{ target_node }}"
        hostname: "{{ container_hostname }}"
        vmid: "{{ container_result.vmid }}"
        state: started
      delegate_to: ansible.home.goodkind.io

    - name: Wait for container to get network interfaces
      ansible.builtin.uri:
        url: >-
          https://{{ proxmox_api_host }}:8006/api2/json/nodes/{{ target_node -}}/lxc/{{-
          container_result.vmid }}/interfaces
        method: GET
        headers:
          Authorization: >-
            PVEAPIToken={{ proxmox_api_user }}!{{ proxmox_token_id }}={{-
            proxmox_token_secret }}
        validate_certs: false
        return_content: true
        status_code: [200]
      register: container_boot_check
      delegate_to: ansible.home.goodkind.io
      changed_when: false
      failed_when: false
      retries: 20
      delay: 1
      until: >-
        container_boot_check.json is defined and
        container_boot_check.json.data is defined and
        (container_boot_check.json.data | length) > 1 and
        (container_boot_check.json.data | selectattr('name', 'equalto', 'eth0') | list | length) > 0

    - name: Fetch container network interfaces (discover IPs)
      ansible.builtin.uri:
        url: >-
          https://{{ proxmox_api_host }}:8006/api2/json/nodes/{{ target_node -}}/lxc/{{-
          container_result.vmid }}/interfaces
        method: GET
        headers:
          Authorization: >-
            PVEAPIToken={{ proxmox_api_user }}!{{ proxmox_token_id }}={{-
            proxmox_token_secret }}
        validate_certs: false
        return_content: true
        status_code: [200]
      register: container_interfaces
      delegate_to: ansible.home.goodkind.io
      changed_when: false
      retries: 30
      delay: 5
      until: >-
        container_interfaces.json is defined and
        container_interfaces.json.data is defined and
        (container_interfaces.json.data | length) > 0

    - name: Debug raw container interfaces API response
      ansible.builtin.debug:
        msg:
          - "Container interfaces API response:"
          - "{{ container_interfaces.json | default('NOT_DEFINED') }}"

    - name: Extract non-loopback IP addresses
      ansible.builtin.set_fact:
        all_ip_addresses: >-
          {{
            container_interfaces.json.data
            | default([])
            | rejectattr('name', 'equalto', 'lo')
            | map(attribute='ip-addresses')
            | select('defined')
            | flatten
            | list
          }}

    - name: Gather container IP candidates (v4/v6)
      ansible.builtin.set_fact:
        container_ipv4_candidates: >-
          {{
            all_ip_addresses
            | selectattr('ip-address-type', 'equalto', 'inet')
            | map(attribute='ip-address')
            | reject('equalto', '127.0.0.1')
            | list
            | unique
          }}
        container_ipv6_candidates: >-
          {{
            all_ip_addresses
            | selectattr('ip-address-type', 'equalto', 'inet6')
            | map(attribute='ip-address')
            | reject('equalto', '::1')
            | list
            | unique
          }}

    - name: Debug IP candidates
      ansible.builtin.debug:
        msg:
          - "IPv4 candidates: {{ container_ipv4_candidates }}"
          - "IPv6 candidates: {{ container_ipv6_candidates }}"

    - name: Select container IP for SSH (prefer global IPv6)
      ansible.builtin.set_fact:
        filtered_ipv6: >-
          {{
            container_ipv6_candidates
            | reject('match', '^fe80:')
            | reject('equalto', '::1')
            | list
          }}
        filtered_ipv4: >-
          {{
            container_ipv4_candidates
            | reject('equalto', '127.0.0.1')
            | list
          }}

    - name: Select container primary IP from filtered candidates
      ansible.builtin.set_fact:
        container_primary_ip: >-
          {{
            (
              filtered_ipv6[0]
              if (filtered_ipv6 | length > 0)
              else (
                filtered_ipv4[0]
                if (filtered_ipv4 | length > 0)
                else ''
              )
            )
          }}

    - name: Debug filtered IP candidates and selection
      ansible.builtin.debug:
        msg:
          - "Filtered IPv6 candidates: {{ filtered_ipv6 }}"
          - "Filtered IPv4 candidates: {{ filtered_ipv4 }}"
          - "Selected primary IP: {{ container_primary_ip }}"

    - name: Ensure container IP was discovered
      ansible.builtin.assert:
        that:
          - container_primary_ip is defined
          - container_primary_ip | string | trim | length > 0
        fail_msg: >-
          Unable to discover an IP address for {{ container_hostname }}
          (VMID {{ container_result.vmid }}) from Proxmox.
          This usually means DHCP hasn't assigned an address yet or the CT
          is not attached to the expected bridge ({{ network_bridge }}).

    - name: Display container info
      ansible.builtin.debug:
        msg:
          - >-
            Container {{ container_hostname }} created with VMID:
            {{ container_result.vmid }}
          - >-
            Ansible will connect to {{ container_hostname }} via
            {{ container_primary_ip }}

    - name: Add container to in-memory inventory
      ansible.builtin.add_host:
        name: "{{ container_hostname }}"
        groups: new_containers
        ansible_host: "{{ container_primary_ip }}"
        ansible_user: root
        ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
        ansible_proxmox_vmid: "{{ container_result.vmid }}"
        ansible_proxmox_host: "{{ target_node }}"

- name: Initialize new container
  hosts: new_containers
  gather_facts: false
  tasks:
    - name: Wait for SSH to be ready
      ansible.builtin.wait_for_connection:
        timeout: 45
        delay: 3
        sleep: 2

    - name: SSH connection established
      ansible.builtin.debug:
        msg: "✓ SSH connection to {{ inventory_hostname }} is ready"

- name: Pre-flight check before prep-cts
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Announce prep-cts start
      ansible.builtin.debug:
        msg: "Starting container preparation (prep-cts) on new container(s)..."

- name: Run prep-cts on new container
  import_playbook: prep-cts.yml
  vars:
    target_hosts: new_containers

- name: Summary
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Display completion message
      ansible.builtin.debug:
        msg: >-
          ✅ Container
          {{ hostvars[groups['new_containers'][0]].inventory_hostname }}
          created and prepped successfully!
