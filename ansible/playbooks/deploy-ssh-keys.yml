---
- name: Gather container/VM information
  hosts: "{{ target_hosts | default('proxmox_all_lxc') }}"
  gather_facts: false
  tasks:
    - name: Filter by container/VM ID if specified
      ansible.builtin.meta: end_host
      when:
        - container_id | default('') | length > 0
        - ansible_proxmox_vmid | default('') | string != container_id | string

    - name: Store container/VM info on each host
      ansible.builtin.set_fact:
        guest_info:
          vmid: "{{ ansible_proxmox_vmid }}"
          host: "{{ ansible_proxmox_host }}"
          name: "{{ inventory_hostname }}"

- name: Deploy SSH keys to containers/VMs via Proxmox
  hosts: localhost
  gather_facts: false
  vars:
    deploy_authorized_keys_script: "{{ playbook_dir }}/../deploy-authorized-keys"
    work_tmp_dir: "{{ playbook_dir }}/../.tmp"
    target_group: "{{ target_hosts | default('proxmox_all_lxc') }}"
    guests: >-
      {{ groups[target_group] | map('extract', hostvars, 'guest_info') |
         select('defined') | list }}
  tasks:
    - name: Create work tmp directory
      ansible.builtin.file:
        path: "{{ work_tmp_dir }}"
        state: directory
        mode: '0755'

    - name: Detect guest types
      ansible.builtin.include_tasks: tasks/detect-guest-type.yml


    - name: Look for proxy container in full inventory
      ansible.builtin.set_fact:
        proxy_from_inventory: >-
          {{
            (groups.get('proxy_servers', []) | length > 0) |
            ternary(groups.get('proxy_servers', [])[0], '')
          }}

    - name: Initialize proxy guest from hostvars as empty
      ansible.builtin.set_fact:
        proxy_guest_from_hostvars: {}

    - name: Get proxy container info from hostvars
      ansible.builtin.set_fact:
        proxy_guest_from_hostvars:
          vmid: "{{ hostvars[proxy_from_inventory].ansible_proxmox_vmid }}"
          host: "{{ hostvars[proxy_from_inventory].ansible_proxmox_host }}"
          name: "{{ proxy_from_inventory }}"
          type: lxc
      when:
        - proxy_from_inventory | length > 0
        - proxy_from_inventory in hostvars
        - hostvars[proxy_from_inventory].ansible_proxmox_vmid is defined
        - hostvars[proxy_from_inventory].ansible_proxmox_host is defined

    - name: Filter proxy container from targeted guests
      ansible.builtin.set_fact:
        proxy_guests_from_targets: >-
          {{
            (guests_with_type | default([]))
            | selectattr('type', 'equalto', 'lxc')
            | selectattr('name', 'defined')
            | selectattr('name', 'match', '(?i)^proxy\\.home\\.goodkind\\.io$')
            | list
          }}

    - name: Select proxy container (prefer from targets, fallback to inventory)
      ansible.builtin.set_fact:
        proxy_guest: >-
          {{
            proxy_guests_from_targets[0]
            if (proxy_guests_from_targets | default([]) | length > 0)
            else (proxy_guest_from_hostvars | default({}))
          }}

    - name: Show proxy guest selection
      ansible.builtin.debug:
        msg: >-
          Proxy guest: {{ proxy_guest.get('name', 'not found') }}
          (VMID: {{ proxy_guest.get('vmid', 'N/A') }},
          source: {{
            'targeted hosts'
            if (proxy_guests_from_targets | default([]) | length > 0)
            else 'inventory lookup'
          }})

    - name: Check if sshpiper upstream public key exists on proxy container
      ansible.builtin.command:
        argv:
          - pct
          - exec
          - "{{ proxy_guest.vmid }}"
          - --
          - sh
          - -c
          - test -f /etc/sshpiper/upstream_id_ed25519.pub
      delegate_to: "{{ proxy_guest.host }}"
      register: sshpiper_upstream_key_exists
      changed_when: false
      failed_when: false
      when: >
        (proxy_guest is mapping) and
        (proxy_guest.vmid | default('') | string | trim | length > 0) and
        (proxy_guest.host | default('') | string | trim | length > 0)

    - name: Read sshpiper upstream public key from proxy container
      ansible.builtin.command:
        argv:
          - pct
          - exec
          - "{{ proxy_guest.vmid }}"
          - --
          - cat
          - /etc/sshpiper/upstream_id_ed25519.pub
      delegate_to: "{{ proxy_guest.host }}"
      register: sshpiper_upstream_pubkey_read
      changed_when: false
      when:
        - proxy_guest is mapping
        - (proxy_guest.vmid | default('') | string | trim | length > 0)
        - (proxy_guest.host | default('') | string | trim | length > 0)
        - sshpiper_upstream_key_exists.rc | default(1) == 0

    - name: Set sshpiper upstream key fact
      ansible.builtin.set_fact:
        sshpiper_upstream_pubkey: >-
          {{ (sshpiper_upstream_pubkey_read.stdout | default('') | trim) }}

    - name: Show sshpiper upstream key status
      ansible.builtin.debug:
        msg: >-
          {{
            'Found sshpiper upstream key: ' + (sshpiper_upstream_pubkey | truncate(60))
            if (sshpiper_upstream_pubkey | length > 0)
            else 'No sshpiper upstream key found (will not be added to bundle)'
          }}

    - name: Write sshpiper upstream public key to work dir
      ansible.builtin.copy:
        content: "{{ sshpiper_upstream_pubkey }}\n"
        dest: "{{ work_tmp_dir }}/sshpiper_upstream_id_ed25519.pub"
        mode: '0644'
      delegate_to: localhost
      when: sshpiper_upstream_pubkey | length > 0

    - name: Get proxy container IPv6 from hostvars
      ansible.builtin.set_fact:
        proxy_ipv6: "{{ hostvars[proxy_from_inventory]['ansible_host'] }}"
      when:
        - proxy_from_inventory | length > 0
        - proxy_from_inventory in hostvars
        - hostvars[proxy_from_inventory].ansible_host is defined
        - "':' in hostvars[proxy_from_inventory].ansible_host"

    - name: Write sshd authorized_keys with 'from' restriction
      ansible.builtin.copy:
        content: |
          # Managed by Ansible - Restricted by SSHPiper
          {% if proxy_ipv6 is defined %}
          from="{{ '[' + proxy_ipv6 + ']' if ':' in proxy_ipv6 else proxy_ipv6 }}" {{ sshpiper_upstream_pubkey }}
          {% else %}
          # WARN: Proxy IPv6 not detected, key is unrestricted!
          {{ sshpiper_upstream_pubkey }}
          {% endif %}
        dest: "{{ work_tmp_dir }}/sshpiper_restricted_key.pub"
        mode: '0644'
      delegate_to: localhost
      when: sshpiper_upstream_pubkey | length > 0

    - name: Build authorized_keys bundle
      ansible.builtin.command:
        argv: >-
          {{
            [
              deploy_authorized_keys_script,
              '--out',
              work_tmp_dir + '/authorized_keys.bundle'
            ]
            + (
              [
                '--extra-pubkey',
                work_tmp_dir + '/sshpiper_restricted_key.pub'
              ]
              if (sshpiper_upstream_pubkey | length > 0)
              else []
            )
          }}
      register: build_bundle
      changed_when: false
      become: true

    - name: Show bundle preview
      ansible.builtin.debug:
        msg: >-
          Bundle built with {{ build_bundle.stdout_lines | default([]) |
          length }} keys
          (includes sshpiper upstream key: {{
            'yes' if (sshpiper_upstream_pubkey | length > 0) else 'no'
          }})

    - name: Copy bundle to Proxmox hosts
      ansible.builtin.copy:
        src: "{{ work_tmp_dir }}/authorized_keys.bundle"
        dest: "/tmp/authorized_keys_deploy.bundle"
        mode: '0644'
      delegate_to: "{{ item }}"
      loop: >-
        {{ (guests_with_type | default([]))
           | map(attribute='host') | unique | list }}

    - name: Write sshd disable password auth snippet to Proxmox hosts
      ansible.builtin.copy:
        dest: /tmp/sshd-disable-password-auth.conf
        mode: '0644'
        content: |
          # Managed by Ansible
          PasswordAuthentication no
          KbdInteractiveAuthentication no
          ChallengeResponseAuthentication no
      delegate_to: "{{ item }}"
      loop: >-
        {{ (guests_with_type | default([]))
           | map(attribute='host') | unique | list }}

    - name: Write sshd global authorized keys snippet to Proxmox hosts
      ansible.builtin.copy:
        dest: /tmp/sshd-global-authorized-keys.conf
        mode: '0644'
        content: |
          # Managed by Ansible
          AuthorizedKeysFile /etc/ssh/authorized_keys.d/authorized_keys
      delegate_to: "{{ item }}"
      loop: >-
        {{ (guests_with_type | default([]))
           | map(attribute='host') | unique | list }}

    - name: Write sshd tmpfiles snippet to Proxmox hosts
      ansible.builtin.copy:
        dest: /tmp/sshd-tmpfiles.conf
        mode: '0644'
        content: |
          # Managed by Ansible
          d /run/sshd 0755 root root -
      delegate_to: "{{ item }}"
      loop: >-
        {{ (guests_with_type | default([]))
           | map(attribute='host') | unique | list }}

    - name: Ensure LXC guests are running
      ansible.builtin.shell: |
        set -o pipefail
        pct status {{ item.vmid }} | grep -q running || pct start {{ item.vmid }}
      args:
        executable: /bin/bash
      delegate_to: "{{ item.host }}"
      loop: "{{ guests_with_type }}"
      loop_control:
        label: "{{ item.name }} (VMID: {{ item.vmid }})"
      when: item.type == 'lxc'
      changed_when: false
      failed_when: false

    - name: Ensure QEMU guests are running
      ansible.builtin.shell: |
        set -o pipefail
        qm status {{ item.vmid }} | grep -q running || qm start {{ item.vmid }}
      args:
        executable: /bin/bash
      delegate_to: "{{ item.host }}"
      loop: "{{ guests_with_type }}"
      loop_control:
        label: "{{ item.name }} (VMID: {{ item.vmid }})"
      when: item.type == 'qemu'
      changed_when: false
      failed_when: false

    - name: Deploy keys and sshd config to LXC guests
      ansible.builtin.shell: |
        set -e
        pct push {{ item.vmid }} /tmp/authorized_keys_deploy.bundle \
          /tmp/new_keys.pub
        pct push {{ item.vmid }} /tmp/sshd-disable-password-auth.conf \
          /tmp/sshd-disable-password-auth.conf
        pct push {{ item.vmid }} /tmp/sshd-global-authorized-keys.conf \
          /tmp/sshd-global-authorized-keys.conf
        pct push {{ item.vmid }} /tmp/sshd-tmpfiles.conf \
          /tmp/sshd-tmpfiles.conf

        pct exec {{ item.vmid }} -- sh -c '
          set -e
          mkdir -p /etc/ssh/sshd_config.d /etc/ssh/authorized_keys.d /etc/tmpfiles.d
          mv /tmp/sshd-disable-password-auth.conf \
            /etc/ssh/sshd_config.d/99-ansible-disable-password-auth.conf
          mv /tmp/sshd-global-authorized-keys.conf \
            /etc/ssh/sshd_config.d/99-sshpiper-global-authorized-keys.conf
          mv /tmp/sshd-tmpfiles.conf /etc/tmpfiles.d/sshd.conf
          chmod 0644 /etc/ssh/sshd_config.d/*.conf /etc/tmpfiles.d/sshd.conf
          if command -v systemd-tmpfiles >/dev/null 2>&1; then
            systemd-tmpfiles --create /etc/tmpfiles.d/sshd.conf || true
          fi
          mkdir -p /run/sshd
          chmod 0755 /run/sshd
          cat /tmp/new_keys.pub > /etc/ssh/authorized_keys.d/authorized_keys
          chmod 0644 /etc/ssh/authorized_keys.d/authorized_keys
          chown root:root /etc/ssh/authorized_keys.d/authorized_keys
          {% if (item.name | lower) == "proxy.home.goodkind.io" %}
          mkdir -p /etc/sshpiper
          cat /tmp/new_keys.pub > /etc/sshpiper/authorized_keys
          chmod 0600 /etc/sshpiper/authorized_keys
          chown sshpiper:sshpiper /etc/sshpiper/authorized_keys || true
          {% endif %}
          sshd -t
          systemctl reset-failed ssh || true
          systemctl restart ssh || true
          rm -f /tmp/new_keys.pub
        '
      args:
        executable: /bin/bash
      delegate_to: "{{ item.host }}"
      loop: "{{ guests_with_type }}"
      loop_control:
        label: "{{ item.name }} (VMID: {{ item.vmid }})"
      when: item.type == 'lxc'
      changed_when: true

    - name: Deploy keys and sshd config to QEMU guests
      ansible.builtin.shell: |
        set -eo pipefail
        qm status {{ item.vmid }} | grep -q running || qm start {{ item.vmid }}

        KEY_B64="$(base64 -w0 /tmp/authorized_keys_deploy.bundle)"
        DISABLE_B64="$(base64 -w0 /tmp/sshd-disable-password-auth.conf)"
        GLOBAL_B64="$(base64 -w0 /tmp/sshd-global-authorized-keys.conf)"
        TMPFILES_B64="$(base64 -w0 /tmp/sshd-tmpfiles.conf)"

        qm guest exec {{ item.vmid }} -- sh -c "
          set -e
          mkdir -p /etc/ssh/sshd_config.d /etc/ssh/authorized_keys.d /etc/tmpfiles.d
          echo '$DISABLE_B64' | base64 -d \
            > /etc/ssh/sshd_config.d/99-ansible-disable-password-auth.conf
          echo '$GLOBAL_B64' | base64 -d \
            > /etc/ssh/sshd_config.d/99-sshpiper-global-authorized-keys.conf
          echo '$TMPFILES_B64' | base64 -d > /etc/tmpfiles.d/sshd.conf
          chmod 0644 /etc/ssh/sshd_config.d/*.conf /etc/tmpfiles.d/sshd.conf
          if command -v systemd-tmpfiles >/dev/null 2>&1; then
            systemd-tmpfiles --create /etc/tmpfiles.d/sshd.conf || true
          fi
          mkdir -p /run/sshd
          chmod 0755 /run/sshd
          echo '$KEY_B64' | base64 -d \
            > /etc/ssh/authorized_keys.d/authorized_keys
          chmod 0644 /etc/ssh/authorized_keys.d/authorized_keys
          chown root:root /etc/ssh/authorized_keys.d/authorized_keys
          sshd -t
          systemctl reset-failed ssh || true
          systemctl restart ssh || true
        " | jq -r '.["out-data"]' || true
      args:
        executable: /bin/bash
      delegate_to: "{{ item.host }}"
      loop: "{{ guests_with_type }}"
      loop_control:
        label: "{{ item.name }} (VMID: {{ item.vmid }})"
      when: item.type == 'qemu'
      changed_when: true

    - name: Summary
      ansible.builtin.debug:
        msg: "âœ… SSH keys deployed to {{ guests_with_type | length }} guest(s)"
