---
- name: Gather container/VM information
  hosts: "{{ target_hosts | default('proxmox_all_lxc') }}"
  gather_facts: false
  tasks:
    - name: Filter by container/VM ID if specified
      ansible.builtin.meta: end_host
      when:
        - container_id | default('') | length > 0
        - ansible_proxmox_vmid | default('') | string != container_id | string

    - name: Store container/VM info on each host
      ansible.builtin.set_fact:
        guest_info:
          vmid: "{{ ansible_proxmox_vmid }}"
          host: "{{ ansible_proxmox_host }}"
          name: "{{ inventory_hostname }}"
          type: "{{ proxmox_vmtype | default('') }}"

- name: Deploy SSH keys to containers/VMs via Proxmox
  hosts: localhost
  gather_facts: false
  vars:
    deploy_authorized_keys_script: "{{ playbook_dir }}/../deploy-authorized-keys"
    work_tmp_dir: "{{ playbook_dir }}/../.tmp"
    target_group: "{{ target_hosts | default('proxmox_all_lxc') }}"
    guests: >-
      {{
        (
          groups.get(target_group, [])
          if target_group in groups
          else [target_group]
        )
        | map('extract', hostvars, 'guest_info')
        | select('defined')
        | list
      }}
  tasks:
    - name: Create work tmp directory
      ansible.builtin.file:
        path: "{{ work_tmp_dir }}"
        state: directory
        mode: "0755"

    - name: Use guest list with proxmox type
      ansible.builtin.set_fact:
        guests_with_type: "{{ guests }}"

    - name: Get proxy host and sshpiper upstream key from inventory
      ansible.builtin.set_fact:
        proxy_host: "{{ groups.proxy_servers | first }}"
        sshpiper_upstream_pubkey: >-
          {{ hostvars[(groups.proxy_servers | first)].sshpiper_upstream_pubkey | trim }}

    - name: Get proxy IPv6 from service_mapping inventory
      ansible.builtin.set_fact:
        proxy_ipv6: "{{ hostvars[proxy_host].service_ipv6 }}"

    - name: Show sshpiper upstream key status
      ansible.builtin.debug:
        msg: >-
          {{ 'Using sshpiper upstream key: ' + (sshpiper_upstream_pubkey | truncate(60)) }}

    - name: Write sshpiper upstream public key to work dir
      ansible.builtin.copy:
        content: "{{ sshpiper_upstream_pubkey }}\n"
        dest: "{{ work_tmp_dir }}/sshpiper_upstream_id_ed25519.pub"
        mode: "0644"
      delegate_to: localhost

    - name: Build proxy IPv6 allowlist from service_mapping
      ansible.builtin.set_fact:
        proxy_allowed_ipv6_list: ["{{ proxy_ipv6 }}/128"]

    - name: Write sshd authorized_keys with 'from' restriction
      ansible.builtin.copy:
        content: |
          # Managed by Ansible - Restricted by SSHPiper
          from="{{ proxy_allowed_ipv6_list | join(',') }}" {{ sshpiper_upstream_pubkey }}
        dest: "{{ work_tmp_dir }}/sshpiper_restricted_key.pub"
        mode: "0644"
      delegate_to: localhost

    - name: Build authorized_keys bundle
      ansible.builtin.command:
        argv: >-
          {{
            [
              deploy_authorized_keys_script,
              '--out',
              work_tmp_dir + '/authorized_keys.bundle'
            ]
            + (
              [
                '--extra-pubkey',
                work_tmp_dir + '/sshpiper_restricted_key.pub'
              ]
            )
          }}
      register: build_bundle
      changed_when: false
      become: true

    - name: Show bundle preview
      ansible.builtin.debug:
        msg: >-
          Bundle built with {{ build_bundle.stdout_lines |
          length }} keys
          (includes sshpiper upstream key: {{
            'yes' if (sshpiper_upstream_pubkey | length > 0) else 'no'
          }})

    - name: Copy bundle to Proxmox hosts
      ansible.builtin.copy:
        src: "{{ work_tmp_dir }}/authorized_keys.bundle"
        dest: "/tmp/authorized_keys_deploy.bundle"
        mode: "0644"
      delegate_to: "{{ item }}"
      loop: >-
        {{ guests_with_type
           | map(attribute='host') | unique | list }}

    - name: Write sshd disable password auth snippet to Proxmox hosts
      ansible.builtin.copy:
        dest: /tmp/sshd-disable-password-auth.conf
        mode: "0644"
        content: |
          # Managed by Ansible
          PasswordAuthentication no
          KbdInteractiveAuthentication no
          ChallengeResponseAuthentication no
      delegate_to: "{{ item }}"
      loop: >-
        {{ guests_with_type
           | map(attribute='host') | unique | list }}

    - name: Write sshd global authorized keys snippet to Proxmox hosts
      ansible.builtin.copy:
        dest: /tmp/sshd-global-authorized-keys.conf
        mode: "0644"
        content: |
          # Managed by Ansible
          AuthorizedKeysFile /etc/ssh/authorized_keys.d/authorized_keys
      delegate_to: "{{ item }}"
      loop: >-
        {{ guests_with_type
           | map(attribute='host') | unique | list }}

    - name: Write sshd tmpfiles snippet to Proxmox hosts
      ansible.builtin.copy:
        dest: /tmp/sshd-tmpfiles.conf
        mode: "0644"
        content: |
          # Managed by Ansible
          d /run/sshd 0755 root root -
      delegate_to: "{{ item }}"
      loop: >-
        {{ guests_with_type
           | map(attribute='host') | unique | list }}

    - name: Ensure LXC guests are running
      ansible.builtin.shell: |
        set -o pipefail
        pct status {{ item.vmid }} | grep -q running || pct start {{ item.vmid }}
      args:
        executable: /bin/bash
      delegate_to: "{{ item.host }}"
      loop: "{{ guests_with_type }}"
      loop_control:
        label: "{{ item.name }} (VMID: {{ item.vmid }})"
      when: item.type == 'lxc'
      changed_when: false
      failed_when: false

    - name: Ensure QEMU guests are running
      ansible.builtin.shell: |
        set -o pipefail
        qm status {{ item.vmid }} | grep -q running || qm start {{ item.vmid }}
      args:
        executable: /bin/bash
      delegate_to: "{{ item.host }}"
      loop: "{{ guests_with_type }}"
      loop_control:
        label: "{{ item.name }} (VMID: {{ item.vmid }})"
      when: item.type == 'qemu'
      changed_when: false
      failed_when: false

    - name: Deploy keys and sshd config to LXC guests
      ansible.builtin.shell: |
        set -e
        pct push {{ item.vmid }} /tmp/authorized_keys_deploy.bundle \
          /tmp/new_keys.pub
        pct push {{ item.vmid }} /tmp/sshd-disable-password-auth.conf \
          /tmp/sshd-disable-password-auth.conf
        pct push {{ item.vmid }} /tmp/sshd-global-authorized-keys.conf \
          /tmp/sshd-global-authorized-keys.conf
        pct push {{ item.vmid }} /tmp/sshd-tmpfiles.conf \
          /tmp/sshd-tmpfiles.conf

        pct exec {{ item.vmid }} -- sh -c '
          set -e
          mkdir -p /etc/ssh/sshd_config.d /etc/ssh/authorized_keys.d /etc/tmpfiles.d
          mv /tmp/sshd-disable-password-auth.conf \
            /etc/ssh/sshd_config.d/99-ansible-disable-password-auth.conf
          mv /tmp/sshd-global-authorized-keys.conf \
            /etc/ssh/sshd_config.d/99-sshpiper-global-authorized-keys.conf
          mv /tmp/sshd-tmpfiles.conf /etc/tmpfiles.d/sshd.conf
          chmod 0644 /etc/ssh/sshd_config.d/*.conf /etc/tmpfiles.d/sshd.conf
          if command -v systemd-tmpfiles >/dev/null 2>&1; then
            systemd-tmpfiles --create /etc/tmpfiles.d/sshd.conf || true
          fi
          mkdir -p /run/sshd
          chmod 0755 /run/sshd
          cat /tmp/new_keys.pub > /etc/ssh/authorized_keys.d/authorized_keys
          chmod 0644 /etc/ssh/authorized_keys.d/authorized_keys
          chown root:root /etc/ssh/authorized_keys.d/authorized_keys
          {% if (item.name | lower) == "proxy.home.goodkind.io" %}
          mkdir -p /etc/sshpiper
          cat /tmp/new_keys.pub > /etc/sshpiper/authorized_keys
          chmod 0600 /etc/sshpiper/authorized_keys
          chown sshpiper:sshpiper /etc/sshpiper/authorized_keys || true
          {% endif %}
          sshd -t
          systemctl reset-failed ssh || true
          systemctl restart ssh || true
          rm -f /tmp/new_keys.pub
        '
      args:
        executable: /bin/bash
      delegate_to: "{{ item.host }}"
      loop: "{{ guests_with_type }}"
      loop_control:
        label: "{{ item.name }} (VMID: {{ item.vmid }})"
      when: item.type == 'lxc'
      changed_when: true

    - name: Deploy keys and sshd config to QEMU guests
      ansible.builtin.shell: |
        set -eo pipefail
        qm status {{ item.vmid }} | grep -q running || qm start {{ item.vmid }}

        KEY_B64="$(base64 -w0 /tmp/authorized_keys_deploy.bundle)"
        DISABLE_B64="$(base64 -w0 /tmp/sshd-disable-password-auth.conf)"
        GLOBAL_B64="$(base64 -w0 /tmp/sshd-global-authorized-keys.conf)"
        TMPFILES_B64="$(base64 -w0 /tmp/sshd-tmpfiles.conf)"

        qm guest exec {{ item.vmid }} -- sh -c "
          set -e
          mkdir -p /etc/ssh/sshd_config.d /etc/ssh/authorized_keys.d /etc/tmpfiles.d
          echo '$DISABLE_B64' | base64 -d \
            > /etc/ssh/sshd_config.d/99-ansible-disable-password-auth.conf
          echo '$GLOBAL_B64' | base64 -d \
            > /etc/ssh/sshd_config.d/99-sshpiper-global-authorized-keys.conf
          echo '$TMPFILES_B64' | base64 -d > /etc/tmpfiles.d/sshd.conf
          chmod 0644 /etc/ssh/sshd_config.d/*.conf /etc/tmpfiles.d/sshd.conf
          if command -v systemd-tmpfiles >/dev/null 2>&1; then
            systemd-tmpfiles --create /etc/tmpfiles.d/sshd.conf || true
          fi
          mkdir -p /run/sshd
          chmod 0755 /run/sshd
          echo '$KEY_B64' | base64 -d \
            > /etc/ssh/authorized_keys.d/authorized_keys
          chmod 0644 /etc/ssh/authorized_keys.d/authorized_keys
          chown root:root /etc/ssh/authorized_keys.d/authorized_keys
          sshd -t
          systemctl reset-failed ssh || true
          systemctl restart ssh || true
        " | jq -r '.["out-data"]'
      args:
        executable: /bin/bash
      delegate_to: "{{ item.host }}"
      loop: "{{ guests_with_type }}"
      loop_control:
        label: "{{ item.name }} (VMID: {{ item.vmid }})"
      when: item.type == 'qemu'
      changed_when: true

    - name: Summary
      ansible.builtin.debug:
        msg: "âœ… SSH keys deployed to {{ guests_with_type | length }} guest(s)"
