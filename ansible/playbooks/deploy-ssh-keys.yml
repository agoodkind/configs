---
- name: Gather container/VM information
  hosts: "{{ target_hosts | default('proxmox_all_lxc') }}"
  gather_facts: false
  tasks:
    - name: Filter by container/VM ID if specified
      ansible.builtin.meta: end_host
      when:
        - container_id | default('') | length > 0
        - ansible_proxmox_vmid | default('') | string != container_id | string

    - name: Store container/VM info on each host
      ansible.builtin.set_fact:
        guest_info:
          vmid: "{{ ansible_proxmox_vmid }}"
          host: "{{ ansible_proxmox_host }}"
          name: "{{ inventory_hostname }}"

- name: Deploy SSH keys to containers/VMs via Proxmox
  hosts: localhost
  gather_facts: false
  vars:
    deploy_authorized_keys_script: "{{ playbook_dir }}/../deploy-authorized-keys"
    work_tmp_dir: "{{ playbook_dir }}/../.tmp"
    authorized_keys_bundle_path: "{{ work_tmp_dir }}/authorized_keys.bundle"
    sshpiper_upstream_pubkey_path: "{{ work_tmp_dir }}/sshpiper_upstream_id_ed25519.pub"
    target_group: "{{ target_hosts | default('proxmox_all_lxc') }}"
    guests: "{{ groups[target_group] | map('extract', hostvars, 'guest_info') | select('defined') | list }}"
  tasks:
    - name: Ensure local temp directory exists
      ansible.builtin.file:
        path: "{{ work_tmp_dir }}"
        state: directory
        mode: '0700'

    - name: Detect guest types
      ansible.builtin.include_tasks: tasks/detect-guest-type.yml
      vars:
        guest_list: "{{ guests }}"

    - name: Filter proxy container candidates from guest list
      ansible.builtin.set_fact:
        proxy_guests: >-
          {{
            (guests_with_type | default([]))
            | selectattr('type', 'equalto', 'lxc')
            | selectattr('name', 'defined')
            | selectattr('name', 'match', '(?i)^proxy\\.home\\.goodkind\\.io$')
            | list
          }}

    - name: Select proxy container from candidates
      ansible.builtin.set_fact:
        proxy_guest: >-
          {{
            proxy_guests[0]
            if (proxy_guests | default([]) | length > 0)
            else {}
          }}

    - name: Show selected proxy guest
      ansible.builtin.debug:
        var: proxy_guest

    - name: Check if sshpiper upstream public key exists on proxy container
      ansible.builtin.command:
        argv:
          - pct
          - exec
          - "{{ proxy_guest.vmid }}"
          - --
          - sh
          - -c
          - test -f /etc/sshpiper/upstream_id_ed25519.pub
      delegate_to: "{{ proxy_guest.host }}"
      register: sshpiper_upstream_key_exists
      changed_when: false
      failed_when: false
      when: >
        (proxy_guest is mapping) and
        (proxy_guest.vmid | default('') | string | trim | length > 0) and
        (proxy_guest.host | default('') | string | trim | length > 0)

    - name: Read sshpiper upstream public key from proxy container
      ansible.builtin.command:
        argv:
          - pct
          - exec
          - "{{ proxy_guest.vmid }}"
          - --
          - cat
          - /etc/sshpiper/upstream_id_ed25519.pub
      delegate_to: "{{ proxy_guest.host }}"
      register: sshpiper_upstream_pubkey_read
      changed_when: false
      when:
        - proxy_guest is mapping
        - (proxy_guest.vmid | default('') | string | trim | length > 0)
        - (proxy_guest.host | default('') | string | trim | length > 0)
        - sshpiper_upstream_key_exists.rc | default(1) == 0

    - name: Set sshpiper upstream key fact (empty if unavailable)
      ansible.builtin.set_fact:
        sshpiper_upstream_pubkey: >-
          {{ (sshpiper_upstream_pubkey_read.stdout | default('') | trim) }}

    - name: Write sshpiper upstream public key to controller (if available)
      ansible.builtin.copy:
        content: "{{ sshpiper_upstream_pubkey }}\n"
        dest: "{{ sshpiper_upstream_pubkey_path }}"
        mode: '0600'
      delegate_to: localhost
      when: sshpiper_upstream_pubkey | length > 0

    - name: Build authorized_keys bundle on controller
      ansible.builtin.command:
        argv: >-
          {{
            [
              deploy_authorized_keys_script,
              '--out',
              authorized_keys_bundle_path
            ]
            + (
              [
                '--extra-pubkey',
                sshpiper_upstream_pubkey_path
              ]
              if (sshpiper_upstream_pubkey | length > 0)
              else []
            )
          }}
      register: build_bundle
      changed_when: false

    - name: Deploy keys and sshd config to each guest
      ansible.builtin.command:
        argv: >-
          {{
            [
              deploy_authorized_keys_script,
              '--deploy',
              '--method',
              ('pct' if item.type == 'lxc' else 'qm'),
              '--proxmox-host',
              item.host,
              '--vmid',
              (item.vmid | string),
              '--bundle',
              authorized_keys_bundle_path
            ]
            + (['--proxy'] if ((item.name | lower) == 'proxy.home.goodkind.io') else [])
          }}
      loop: "{{ guests_with_type | unique(attribute='vmid') }}"
      loop_control:
        label: "{{ item.name }} (VMID: {{ item.vmid }} on {{ item.host }})"
      changed_when: true

    - name: Summary
      ansible.builtin.debug:
        msg: "âœ… SSH keys deployed to {{ guests_with_type | length }} guest(s)"
