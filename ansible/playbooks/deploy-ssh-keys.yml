---
- name: Gather LXC container information
  hosts: proxmox_all_lxc
  gather_facts: false
  tasks:
    - name: Store container info on each host
      set_fact:
        container_info:
          vmid: "{{ ansible_proxmox_vmid }}"
          host: "{{ ansible_proxmox_host }}"
          name: "{{ inventory_hostname }}"

- name: Deploy SSH keys to containers via Proxmox
  hosts: localhost
  gather_facts: false
  vars:
    # Option 1: Read from file
    # ssh_key: "{{ lookup('file', '~/.ssh/id_ed25519.pub') }}"
    # Option 2: Read from URL
    ssh_key: "{{ lookup('url', 'https://github.com/USERNAME.keys') }}"
    containers: "{{ groups['proxmox_all_lxc'] | map('extract', hostvars, 'container_info') | list }}"
  tasks:
    - name: Deploy SSH key to container
      delegate_to: "{{ item.host }}"
      shell: |
        pct exec {{ item.vmid }} -- sh -c '
          mkdir -p /root/.ssh
          chmod 700 /root/.ssh
          echo "{{ ssh_key }}" >> /root/.ssh/authorized_keys
          chmod 600 /root/.ssh/authorized_keys
          chown -R root:root /root/.ssh
        '
      loop: "{{ containers }}"
      loop_control:
        label: "{{ item.name }} (VMID: {{ item.vmid }} on {{ item.host }})"

