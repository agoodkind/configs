---
# MWAN (Multi-WAN) Configuration Variables

# Path to AT&T certificates on Ansible controller (persistent across Semaphore runs)
# Certificates should be placed here: /var/lib/semaphore/certs/mwan/wpa/
mwan_att_certs_path: "/var/lib/semaphore/certs/mwan/wpa"

# VM hostname
mwan_hostname: mwan.home.goodkind.io
# Management interface uses DHCP - IP assigned by KEA and registered in DNS automatically
# mwan_mgmt_ip_config can be overridden for static IP if needed:
# mwan_mgmt_ip_config: "ip=10.250.0.134/24,gw=10.250.0.1,ip6=3d06:bad:b01::86/64,gw6=3d06:bad:b01::1"

# DNS configuration (IPv6 first) - use OPNsense as DNS
mwan_dns_domain: "home.goodkind.io"
mwan_dns_servers: "3d06:bad:b01::1 10.250.0.1"

# Proxmox bridge names
mwan_mgmt_bridge: vmbr0 # Management network for SSH access
mwan_bridge_name: mwanbr # mwan <-> OPNsense internal link

# PCI Passthrough devices
# X710 VF for AT&T 802.1X authentication (created on Proxmox host via x710-vf-setup.service)
pci_x710_vf: "02:02.0"
# Webpass I226-V NIC (full passthrough to avoid MAC issues)
pci_webpass_nic: "06:00.0"

# Interface names are DETECTED at deploy time and stored as facts
# These defaults are overridden by deploy-mwan.yml after detection
mwan_mgmt_iface: "enmgmt0"
mwan_att_iface: "{{ detected_att_iface | default('enatt0') }}"
mwan_webpass_iface: "{{ detected_webpass_iface | default('enwebpass0') }}"
mwan_internal_iface: "{{ detected_internal_iface | default('enmwanbr0') }}"

# AT&T 802.1X authentication (via X710 VF passthrough)
mwan_att_vlan_id: 3242
mwan_att_eap_identity: "D0:FC:D0:7C:85:30"
mwan_att_mac: "D0:FC:D0:7C:85:30" # MAC for DHCP (different from EAP identity)
# Certificates must be manually uploaded to /etc/wpa_supplicant/ on mwan VM
# Extract from OPNsense:
#   scp agoodkind@router:/conf/opnatt/wpa/*.pem root@mwan.home.goodkind.io:/etc/wpa_supplicant/
#   ssh root@mwan.home.goodkind.io "chmod 600 /etc/wpa_supplicant/*.pem"

# Webpass identity spoofing (CRITICAL - must match current OPNsense)
# The I226-V NIC has wrong hardware MAC, so we MUST spoof it
# DUID format: 00:01:00:01:<timestamp>:<mac_address>
# MAC extracted from DUID: 00:e2:69:66:8b:5a
mwan_webpass_duid: "00:01:00:01:2f:aa:b6:c3:00:e2:69:66:8b:5a"
# Raw DUID data (without leading 00:01 type bytes) for systemd-networkd
mwan_webpass_duid_raw_data: "00:01:2f:aa:b6:c3:00:e2:69:66:8b:5a"
mwan_att_duid: "00:02:00:00:0d:e9:44:30:46:43:44:30:2d:44:39:33:4c:44:32:50:58:33:30:39:32:33:37"
mwan_att_duid_raw_data: "00:00:0d:e9:44:30:46:43:44:30:2d:44:39:33:4c:44:32:50:58:33:30:39:32:33:37"
mwan_webpass_mac: "00:e2:69:66:8b:5a" # MAC registered with Webpass

# Webpass static IPv4 (Google Fiber)
# Network: 136.25.91.240/29
# Gateway: 136.25.91.241
# Usable: 136.25.91.242 - 136.25.91.246
mwan_webpass_ipv4: "136.25.91.242/29"
mwan_webpass_gateway: "136.25.91.241"

# Internal link (to OPNsense) addressing
mwan_internal_ipv4: "10.250.250.1/29"
mwan_internal_ipv6: "3d06:bad:b01:fe::1/64"

# Internal prefix for NPT (LAN -> PD)
# Keep LAN /64 on the bridge, but NPT the broader /60
mwan_internal_prefix: "3d06:bad:b01::/60"

# OPNsense WAN link-local (next-hop on the MWAN internal link).
# Used for correct routing of the internal IPv6 /60 in MWAN policy tables.
# NOTE: This is derived from OPNsense WAN MAC (EUI-64). If the WAN MAC changes,
# update this value accordingly.
mwan_opnsense_wan_ll: "fe80::be24:11ff:fe77:500c"

# OPNsense IPv6 address on the MWAN link (DNAT target for "hairpinned" WAN /128 interface addresses).
# This does not need to be globally routable; it is only used on the MWANâ†”OPNsense link.
mwan_opnsense_edge_ipv6: "3d06:bad:b01:fe::2"

# NPT targets: lower /60 from each PD
# The ::1 address from each PD is added to WAN interfaces and used for:
# - SNAT of fe::1 and fe::2 (single /128 translation)
# - Source for NPT'd traffic from broader /60
mwan_npt_att_prefix: "2600:1700:2f71:c80::/60"
mwan_npt_webpass_prefix: "2604:5500:c271:be00::/60"

# Static IP mappings (1:1 NAT)
mwan_static_mappings:
  att:
    - { internal: "10.250.250.2", external: "104.57.226.193" }
    - { internal: "10.250.250.3", external: "104.57.226.194" }
    - { internal: "10.250.250.4", external: "104.57.226.195" }
    - { internal: "10.250.250.5", external: "104.57.226.196" }
    - { internal: "10.250.250.6", external: "104.57.226.197" }
  webpass:
    # Note: .242 is also interface IP (dual-purpose)
    - { internal: "10.250.250.2", external: "136.25.91.242" }
    - { internal: "10.250.250.3", external: "136.25.91.243" }
    - { internal: "10.250.250.4", external: "136.25.91.244" }
    - { internal: "10.250.250.5", external: "136.25.91.245" }
    - { internal: "10.250.250.6", external: "136.25.91.246" }

# Health check configuration
mwan_health_checks:
  att:
    enabled: true
    ping_count: 3
    success_threshold: 2
    check_interval: 10
    failure_threshold: 2
    recovery_threshold: 2
    targets_v4:
      - "1.1.1.1" # Cloudflare
      - "8.8.8.8" # Google
    targets_v6:
      - "2606:4700:4700::1111" # Cloudflare
      - "2001:4860:4860::8888" # Google
    http_targets:
      - "https://ifconfig.co/ip"
  webpass:
    enabled: true
    ping_count: 3
    success_threshold: 2
    check_interval: 10
    failure_threshold: 2
    recovery_threshold: 2
    targets_v4:
      - "1.1.1.1"
      - "8.8.8.8"
    targets_v6:
      - "2606:4700:4700::1111"
      - "2001:4860:4860::8888"
    http_targets:
      - "https://ifconfig.co/ip"
  # monkeybrains:
  #   enabled: false # Enable for Phase 3
  #   ping_count: 5
  #   success_threshold: 1 # Lax - it's lossy
  #   check_interval: 30
  #   failure_threshold: 5
  #   recovery_threshold: 3
  #   targets_v4:
  #     - "1.1.1.1"
  #     - "8.8.8.8"
  #   targets_v6:
  #     - "2606:4700:4700::1111"
  #     - "2001:4860:4860::8888"
  #   http_targets:
  #     - "https://ifconfig.co/ip"

# Latency-sensitive services pinned to AT&T
# Add destination IPs/subnets here
# mwan_att_pinned_dests:
#   - "8.8.8.8/32" # Example - Google DNS for testing
# Add Zoom, Google Meet, WiFi Calling ranges here

# Routing Table IDs
# Used in /etc/iproute2/rt_tables and systemd-networkd configs
mwan_rt_tables:
  att: 100
  webpass: 200
  monkeybrains: 300

# Email notifications (optional)
mwan_email_enabled: true
mwan_email_recipient: "alex@goodkind.io"
mwan_email_script: "/opt/scripts/send-email"

# Debug logging for MWAN helper scripts
# When enabled, scripts emit additional structured logs to:
# - syslog (tagged per script)
# - /var/log/mwan-debug.log (JSON lines)
mwan_debug_logging: true
